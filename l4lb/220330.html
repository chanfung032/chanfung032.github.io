
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>#220330 é—®é¢˜ &#8212; Feng&#39;s blog 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/custom.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="#220321 FB: From XDP to Socket" href="220321.html" />
    <link rel="prev" title="#220721 æ¢æ´»ã€TIME_WAIT ä»¥åŠ SO_LINGER" href="220721.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="wen-ti">
<h1>#220330 é—®é¢˜<a class="headerlink" href="#wen-ti" title="Permalink to this headline">Â¶</a></h1>
<section id="ixgbe-detected-tx-unit-hang">
<h2>ixgbe Detected Tx Unit Hang<a class="headerlink" href="#ixgbe-detected-tx-unit-hang" title="Permalink to this headline">Â¶</a></h2>
<p>ç°è±¡æ˜¯ç½‘å¡ä¸æ–­é‡å¯ï¼ŒæŸ¥çœ‹ <code class="docutils literal notranslate"><span class="pre">/var/log/message</span></code> å¯ä»¥çœ‹åˆ°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span> <span class="n">ixgbe</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">p4p1</span><span class="p">:</span> <span class="n">Detected</span> <span class="n">Tx</span> <span class="n">Unit</span> <span class="n">Hang</span> <span class="p">(</span><span class="n">XDP</span><span class="p">)</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">Tx</span> <span class="n">Queue</span>             <span class="o">&lt;</span><span class="mi">24</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">TDH</span><span class="p">,</span> <span class="n">TDT</span>             <span class="o">&lt;</span><span class="mi">84</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">136</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">next_to_use</span>          <span class="o">&lt;</span><span class="mi">136</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">next_to_clean</span>        <span class="o">&lt;</span><span class="mi">84</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span> <span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">next_to_clean</span><span class="p">]</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">time_stamp</span>           <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">jiffies</span>              <span class="o">&lt;</span><span class="mi">128</span><span class="n">edcdc0</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797955</span><span class="p">]</span> <span class="n">ixgbe</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">p4p1</span><span class="p">:</span> <span class="n">tx</span> <span class="n">hang</span> <span class="mi">1</span> <span class="n">detected</span> <span class="n">on</span> <span class="n">queue</span> <span class="mi">25</span><span class="p">,</span> <span class="n">resetting</span> <span class="n">adapter</span>
<span class="o">...</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span> <span class="n">kernel</span><span class="p">:</span> <span class="p">[</span><span class="mf">687078.764725</span><span class="p">]</span> <span class="n">bond0</span><span class="p">:</span> <span class="n">link</span> <span class="n">status</span> <span class="n">down</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">p4p2</span><span class="p">,</span> <span class="n">disabling</span> <span class="n">it</span> <span class="ow">in</span> <span class="mi">200</span> <span class="n">ms</span>
</pre></div>
</div>
<p>è¿™ä¸ªé—®é¢˜æ˜¯ ixgbe é©±åŠ¨ xdp å®ç° BUG å¯¼è‡´ï¼Œå‡ºç°åœ¨ cpu æ¯”è¾ƒå¤šçš„æœºå™¨ã€‚</p>
<blockquote>
<div><p>When the received core is such that the xdp queue falls beyond
MAX_TX_QUEUES(64), then the hang results. In other words, if I leave
<cite>ethtool -L eno1 combined 40</cite> (the default), and a packet is received on
core 24 or greater, it hangs. However, if I lower the tx queue count to
24 (since XDP is forced to nr_cpu_ids), or if I force the incoming
packets onto core &lt; 24 with an ntuple filter, then no hang occurs.</p>
</div></blockquote>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -l p4p1
<span class="go">Channel parameters for p4p1:</span>
<span class="go">Pre-set maximums:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              1</span>
<span class="go">Combined:   63</span>
<span class="go">Current hardware settings:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              1</span>
<span class="go">Combined:   28</span>
<span class="gp"># </span>nproc
<span class="go">56</span>
<span class="gp"># </span>uname -r
<span class="go">4.19.113-88.4bs.el7.centos.x86_64</span>
</pre></div>
</div>
<p>å½“ <code class="docutils literal notranslate"><span class="pre">combined</span> <span class="pre">+</span> <span class="pre">xdp</span> <span class="pre">queues(nr_cpu_ids)</span> <span class="pre">&gt;</span> <span class="pre">max_tx_queues(64)</span></code> å°±ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>è¯¦ç»†é—®é¢˜è®¨è®ºåœ¨è¿™ä¸¤ä¸ª thread ä¸­ï¼š</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.spinics.net/lists/netdev/msg439438.html">https://www.spinics.net/lists/netdev/msg439438.html</a></p></li>
<li><p><a class="reference external" href="https://www.spinics.net/lists/netdev/msg519914.html">https://www.spinics.net/lists/netdev/msg519914.html</a></p></li>
</ul>
<p>ä¸å‡çº§å†…æ ¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ <code class="docutils literal notranslate"><span class="pre">ethtool</span> <span class="pre">-L</span> <span class="pre">p4p1</span> <span class="pre">combined</span> <span class="pre">N</span></code> å‘½ä»¤è°ƒä½ combined çš„ä¸ªæ•°ï¼Œç»•è¿‡è¿™ä¸ª BUGï¼Œä½†æ˜¯ä¼šå½±å“æ€§èƒ½ã€‚</p>
<p>BUG åœ¨ 4.20-rc1 å·²ç»ä¿®å¤ã€‚å‚è§ï¼š<a class="reference external" href="https://github.com/torvalds/linux/commit/8d7179b1e2d64b3493c0114916486fe92e6109a9">https://github.com/torvalds/linux/commit/8d7179b1e2d64b3493c0114916486fe92e6109a9</a></p>
<p>å¦ä¸€ä¸ªè§£å†³é—®é¢˜çš„æ–¹æ³•æ˜¯è®¾å®š XDP åŠ è½½æ¨¡å¼ä¸º skb æ¨¡å¼ï¼ŒåŒæ ·ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ˜¯ä¸éœ€è¦å‡çº§å†…æ ¸ã€‚</p>
</section>
<section id="i40e-x722-unable-to-handle-kernel-null-pointer-dereference">
<h2>i40e/X722 unable to handle kernel NULL pointer dereference<a class="headerlink" href="#i40e-x722-unable-to-handle-kernel-null-pointer-dereference" title="Permalink to this headline">Â¶</a></h2>
<p>i40e é©±åŠ¨ï¼Œç½‘å¡æ˜¯ X722 å‹å·çš„ï¼Œåœ¨åŠ è½½ xdp çš„æ—¶å€™ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -i enp61s0f0
<span class="go">driver: i40e</span>
<span class="go">version: 2.3.2-k</span>
<span class="go">...</span>
<span class="gp"># </span>lshw -class network -short
<span class="go">H/W path         Device      Class          Description</span>
<span class="go">=======================================================</span>
<span class="go">/0/0/0/3/0       enp61s0f0   network        Ethernet Connection X722 for 10GbE SFP+</span>
<span class="go">/0/0/0/3/0.1     enp61s0f1   network        Ethernet Connection X722 for 10GbE SFP+</span>
<span class="go">/3               bond0       network        Ethernet interface</span>
</pre></div>
</div>
<p>é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:3d:00.0: setup of MAIN VSI failed
i40e 0000:3d:00.0: can&#39;t remove VEB 160 with 0 VSIs left
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
Oops: 0000 [#1] SMP NOPTI
CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:3d:00.0: setup of MAIN VSI failed
i40e 0000:3d:00.0: can&#39;t remove VEB 160 with 0 VSIs left
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
Oops: 0000 [#1] SMP NOPTI
Oops: 0000 [#1] SMP NOPTI
CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
Code: 87 ab d0 0c 00 00 84 c0 75 60 31 c0 66 83 bb f6 0c 00 00 00 74 27 48 8b 93 90 0c 00 00 48 63 f0 48 8b 8b d0 0c 00 00 83 c0 01 &lt;48&gt; 8b 14 f2 48 89 4a 20 0f b7 93 f6 0c 00 00 39 d0 7c d9 48 85 ed
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
RSP: 0018:ffff9d00ea6af8c0 EFLAGS: 00010202
RAX: 0000000000000001 RBX: ffff88f5f75fc000 RCX: ffff9d00c01ef000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff88f5ffcd68f0
RBP: 0000000000000000 R08: 0000000000000070 R09: 0000000000027e7c
R10: ffff89063ff468c0 R11: 0000000000000707 R12: ffff88f5f7600000
R13: ffffffffc0308aa0 R14: ffffffffc032c5a0 R15: 000000000000000f
FS:  00007f25f9ffb700(0000) GS:ffff88f5ffcc0000(0000) knlGS:0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000001fb3828004 CR4: 00000000007606e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
 dev_xdp_install+0x4f/0x70
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 dev_change_xdp_fd+0x103/0x210
 ? dev_disable_lro+0xa0/0xa0
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 do_setlink+0xd63/0xd90
 ? cpumask_next+0x16/0x20
 ? do_kernel_range_flush+0x50/0x50
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? nla_parse+0xa4/0x120
 rtnl_setlink+0xd7/0x140
 ? security_capset+0x50/0x70
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 rtnetlink_rcv_msg+0x28f/0x350
 ? _cond_resched+0x15/0x30
 ? __kmalloc_node_track_caller+0x188/0x280
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? rtnl_calcit.isra.27+0x110/0x110
 netlink_rcv_skb+0xd4/0x110
 netlink_unicast+0x182/0x230
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 netlink_sendmsg+0x2ed/0x3e0
 sock_sendmsg+0x36/0x50
 __sys_sendto+0xdc/0x160
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? sock_setsockopt+0x3b9/0xc80
 ? syscall_trace_enter+0x1c9/0x2c0
 ? __audit_syscall_exit+0x213/0x350
 __x64_sys_sendto+0x24/0x30
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 do_syscall_64+0x5b/0x1a0
 entry_SYSCALL_64_after_hwframe+0x44/0xa9
RIP: 0033:0x4aeeea
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
Code: e8 5b 9c fb ff 48 8b 7c 24 10 48 8b 74 24 18 48 8b 54 24 20 4c 8b 54 24 28 4c 8b 44 24 30 4c 8b 4c 24 38 48 8b 44 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 76 20 48 c7 44 24 40 ff ff ff ff 48 c7 44 24 4

RSP: 002b:000000c0003d8f98 EFLAGS: 00000216 ORIG_RAX: 000000000000002c
</pre></div>
</div>
<p>è¿™ä¸ªæ˜¯é©±åŠ¨ BUGï¼Œå‡çº§é©±åŠ¨å¯è§£å†³ã€‚</p>
<ul class="simple">
<li><p>é©±åŠ¨ä¸‹è½½ï¼š<a class="reference external" href="https://www.intel.com/content/www/us/en/download/18026/intel-network-adapter-driver-for-pcie-40-gigabit-ethernet-network-connections-under-linux.html">https://www.intel.com/content/www/us/en/download/18026/intel-network-adapter-driver-for-pcie-40-gigabit-ethernet-network-connections-under-linux.html</a></p></li>
<li><p>é‚®ä»¶åˆ—è¡¨åŒæ ·é—®é¢˜è®¨è®ºï¼š<a class="reference external" href="https://www.spinics.net/lists/xdp-newbies/msg01780.html">https://www.spinics.net/lists/xdp-newbies/msg01780.html</a></p></li>
<li><p>ä¿®å¤è¡¥ä¸ï¼š<a class="reference external" href="https://github.com/torvalds/linux/commit/92947844b8beee988c0ce17082b705c2f75f0742">https://github.com/torvalds/linux/commit/92947844b8beee988c0ce17082b705c2f75f0742</a></p></li>
</ul>
<hr class="docutils" />
<p>çº¿ä¸Šå‡çº§çš„æ—¶å€™æ˜¯æ–°å†…æ ¸å’Œæ–°é©±åŠ¨ä¸€èµ·å‡çº§ï¼Œé»˜è®¤æƒ…å†µä¸‹éœ€è¦é‡å¯ä¸¤æ¬¡æ–°é©±åŠ¨æ‰ç”Ÿæ•ˆï¼Œç¬¬ä¸€æ¬¡æ–°å†…æ ¸ç”Ÿæ•ˆï¼Œç¬¬äºŒæ¬¡æ–°é©±åŠ¨æ‰ç”Ÿæ•ˆï¼Œå› ä¸ºæ–°é©±åŠ¨å®‰è£…çš„æ—¶å€™æœ€å postinstall è„šæœ¬é‡Œçš„ <code class="docutils literal notranslate"><span class="pre">depmod</span></code> æ‰§è¡Œè¿˜æ˜¯åœ¨è€å†…æ ¸ä¸Šï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡é‡å¯è¿˜æ˜¯ä½¿ç”¨çš„æ–°å†…æ ¸é»˜è®¤è‡ªå¸¦çš„è€é©±åŠ¨ã€‚è§£å†³æ–¹æ³•æ˜¯æ–°é©±åŠ¨é‡Œæ·»åŠ ä¸€ä¸ª <code class="docutils literal notranslate"><span class="pre">/etc/depmod.d/</span></code> é…ç½®æ–‡ä»¶ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat /etc/depmod.d/kmod-i40e.conf
<span class="go">override i40e * weak-updates/i40e</span>
</pre></div>
</div>
<p><a class="reference external" href="https://linux.die.net/man/8/depmod">https://linux.die.net/man/8/depmod</a></p>
<hr class="docutils" />
<p>å‡çº§é©±åŠ¨ç‰ˆæœ¬æ³¨æ„ä¸­é—´æœ‰äº›ç‰ˆæœ¬å‡çº§åä¼šå‡ºç°ç½‘å¡ç»Ÿè®¡çš„ RX ä¸€ç›´ä¸º 0 çš„é—®é¢˜ï¼Œè¿™ä¸ªåœ¨ä¸‹é¢è¿™ä¸ªæäº¤ä¸­å·²ç»ä¿®å¤ï¼š</p>
<p><a class="reference external" href="https://github.com/torvalds/linux/commit/cdec2141c24ef177d929765c5a6f95549c266fb3">https://github.com/torvalds/linux/commit/cdec2141c24ef177d929765c5a6f95549c266fb3</a></p>
<p>è™½ç„¶è¿™ä¸ªæ˜¯ 2018 å¹´çš„æäº¤ï¼Œä½† intel å®˜æ–¹åœ¨ 2021 å¹´ä¹‹åæä¾›çš„é©±åŠ¨ç‰ˆæœ¬ä¼¼ä¹è¿˜æ˜¯ä¸åŒ…å«è¿™ä¸ªè¡¥ä¸å†…å®¹ã€‚éœ€è¦ä»£ç ç¡®è®¤ä¸‹ã€‚</p>
</section>
<section id="di-er-tiao-zhi-jie-zhai-chu-vip-fu-wu-qi-kai-qi-le-ip-forward-zao-cheng-de-bao-xun-huan">
<h2>ç¬¬äºŒè·³ç›´æ¥æ‘˜é™¤ VIP + æœåŠ¡å™¨å¼€å¯äº† ip_forward é€ æˆçš„åŒ…å¾ªç¯<a class="headerlink" href="#di-er-tiao-zhi-jie-zhai-chu-vip-fu-wu-qi-kai-qi-le-ip-forward-zao-cheng-de-bao-xun-huan" title="Permalink to this headline">Â¶</a></h2>
<p>å¦‚æœç¬¬äºŒè·³æœºå™¨ä¸Šæ²¡æœ‰ç»‘å®š VIPï¼Œæœºå™¨ä¸Šåˆå¼€å¯äº† ip_forwardï¼Œè¿™ä¸ªæ—¶å€™è§£åŒ…å‡ºä¸€ä¸ª VIP çš„åŒ…è¿‡æ¥ï¼Œå‘ç°ä¸æ˜¯æœ¬æœº IPï¼Œä¼šèµ°è·¯ç”±å°†åŒ…è½¬å‘å‡ºå»ï¼ŒåŒ…åˆä¼šä»è´Ÿè½½å‡è¡¡è¿›æ¥ï¼Œé‡æ–°è½¬å‘ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åŒ…åªæœ‰ ttl ä¼šå‡å°ï¼Œä¼šå¯¼è‡´åŒ…ä¸€ç›´åœ¨ director -&gt; ç¬¬ä¸€è·³åç«¯ -&gt; ç¬¬äºŒè·³åç«¯ -&gt; director è¿™æ ·å¾ªç¯ï¼Œç›´åˆ° ttl ä¸º 0 ä¸ºæ­¢ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>tcpdump -i bond0 <span class="s1">&#39;dst &lt;VIP&gt;&#39;</span>  -nnn -v -e
<span class="go">19:26:28.377695 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 49, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">...</span>
<span class="go">19:26:28.380421 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 4, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">19:26:28.380493 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 3, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">19:26:28.380540 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 2, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">19:26:28.380595 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 1, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
</pre></div>
</div>
<p>æ•™è®­å°±æ˜¯ï¼š</p>
<ul class="simple">
<li><p>åœ¨å¯¹ç§°éƒ¨ç½²æ¶æ„ä¸‹ï¼ŒOSPF VIP å’Œåç«¯ç»‘å®š VIP éœ€è¦åœ¨é€»è¾‘åœ¨åˆ†å¼€ï¼ˆç‰©ç†ä¸Šå¯èƒ½ç»‘å®šçš„æ˜¯ä¸€ä¸ªï¼‰ï¼Œæœ‰äº›åœºæ™¯ä¸‹ OSPF VIP å’Œåç«¯ VIP çš„ç»‘å®šè§£ç»‘é€»è¾‘ä¸ä¸€è‡´ï¼Œä¸€ä¸ªéœ€è¦è§£ï¼Œä¸€ä¸ªä¸èƒ½è§£ï¼Œè¿™ä¸ªéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé¿å…ç±»ä¼¼ä¸Šé¢è¿™æ ·çš„é—®é¢˜ã€‚</p></li>
<li><p>æ²¡äº‹åˆ«å¼€ ip_forwardã€‚</p></li>
</ul>
</section>
<section id="ipv4-vip-fang-wen-zheng-chang-ipv6-fang-wen-yi-chang-ke-neng-de-wen-ti">
<h2>IPv4 VIP è®¿é—®æ­£å¸¸ã€IPv6 è®¿é—®å¼‚å¸¸å¯èƒ½çš„é—®é¢˜<a class="headerlink" href="#ipv4-vip-fang-wen-zheng-chang-ipv6-fang-wen-yi-chang-ke-neng-de-wen-ti" title="Permalink to this headline">Â¶</a></h2>
<p>é›†ç¾¤ä¸­æœ‰ä¸€å°æœºå™¨ IPv6 è®¿é—®å¼‚å¸¸ï¼ŒIPv4 è®¿é—®ç¡®æ­£å¸¸ï¼Œå¼‚å¸¸çš„æœºå™¨ä¸Š IPv6 çš„ VIP ç»‘å®šæ­£å¸¸ï¼Œsit0 ç½‘å¡ä¹Ÿæ­£å¸¸ï¼Œä¸€åˆ‡çœ‹ä¸Šå»éƒ½æŒºæ­£å¸¸ï¼Œè¿™ç§æƒ…å†µå¯èƒ½æ˜¯æ²¡æœ‰åˆå§‹åŒ– IPv6 å¯¼è‡´ç¼ºå°‘é»˜è®¤ IPv6 è·¯ç”±ï¼Œä¸‹è¡Œçš„åŒ…ä¸çŸ¥é“æ€ä¹ˆå‡ºå»å¯¼è‡´çš„ã€‚</p>
</section>
<section id="jiao-huan-ji-he-fu-wu-qi-shang-mtu-bu-yi-zhi-dao-zhi-de-bird-ospf-shi-bai">
<h2>äº¤æ¢æœºå’ŒæœåŠ¡å™¨ä¸Š MTU ä¸ä¸€è‡´å¯¼è‡´çš„ bird ospf å¤±è´¥<a class="headerlink" href="#jiao-huan-ji-he-fu-wu-qi-shang-mtu-bu-yi-zhi-dao-zhi-de-bird-ospf-shi-bai" title="Permalink to this headline">Â¶</a></h2>
<p>æœ‰äº›äº¤æ¢æœº MTU è®¾ç½®ä¸º 9000 ä¸”æ— æ³•ä¿®æ”¹ï¼Œä½†æ˜¯æŒ‚è½½äº† XDP çš„ç½‘å¡çš„ MTU æ— æ³•æ”¹åˆ°å’Œäº¤æ¢æœºçš„ä¸€è‡´ï¼ˆ <a class="reference internal" href="210305.html#mtu9000"><span class="std std-ref">mlx5_core MTU(9000) &gt; 3498 is not allowed while XDP enabled</span></a> ï¼‰ï¼Œæ­¤æ—¶ <a class="reference external" href="https://bird.network.cz/">bird</a> ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>tail /tmp/bird.log
<span class="go">2022-12-03 20:30:51.893 &lt;RMT&gt; ospfv2: MTU mismatch with nbr 61.184.215.126 on bond0 (remote 9000, local 1500)</span>
<span class="go">...</span>
</pre></div>
</div>
<p>è¿™ä¸ªæ˜¯ bird v2.0.7 ç‰ˆæœ¬å¼€å§‹åŠ ä¸Šçš„ä¸€ä¸ªéªŒè¯ï¼Œä¹‹å‰åªæ˜¯ä¸€ä¸ª warningã€‚</p>
<p><a class="reference external" href="https://github.com/CZ-NIC/bird/commit/267da8138d7f429941f2d829b44cf9bdd94a14d6">https://github.com/CZ-NIC/bird/commit/267da8138d7f429941f2d829b44cf9bdd94a14d6</a></p>
<p>å¯ä»¥åŠ ä¸ªé€‰é¡¹æ”¯æŒå°†è¿™ä¸ªéªŒè¯å…³é—­ã€‚</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff -ru a/proto/ospf/config.Y b/proto/ospf/config.Y</span>
<span class="gd">--- a/proto/ospf/config.Y   2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/config.Y   2022-12-05 16:36:46.334051267 +0800</span>
<span class="gu">@@ -191,7 +191,7 @@</span>
 CF_DECLS

 CF_KEYWORDS(OSPF, V2, V3, OSPF_METRIC1, OSPF_METRIC2, OSPF_TAG, OSPF_ROUTER_ID)
<span class="gd">-CF_KEYWORDS(AREA, NEIGHBORS, RFC1583COMPAT, STUB, TICK, COST, COST2, RETRANSMIT)</span>
<span class="gi">+CF_KEYWORDS(AREA, NEIGHBORS, RFC1583COMPAT, STUB, TICK, COST, COST2, RETRANSMIT, IGNOREMTU)</span>
 CF_KEYWORDS(HELLO, TRANSMIT, PRIORITY, DEAD, TYPE, BROADCAST, BCAST, DEFAULT)
 CF_KEYWORDS(NONBROADCAST, NBMA, POINTOPOINT, PTP, POINTOMULTIPOINT, PTMP)
 CF_KEYWORDS(NONE, SIMPLE, AUTHENTICATION, STRICT, CRYPTOGRAPHIC, TTL, SECURITY)
<span class="gu">@@ -258,6 +258,7 @@</span>
    proto_item
  | ospf_channel { this_proto-&gt;net_type = $1-&gt;net_type; }
  | RFC1583COMPAT bool { OSPF_CFG-&gt;rfc1583 = $2; }
<span class="gi">+ | IGNOREMTU bool { OSPF_CFG-&gt;ignoremtu = $2; }</span>
  | RFC5838 bool { OSPF_CFG-&gt;af_ext = $2; if (!ospf_cfg_is_v3()) cf_error(&quot;RFC5838 option requires OSPFv3&quot;); }
  | VPN PE bool { OSPF_CFG-&gt;vpn_pe = $3; }
  | STUB ROUTER bool { OSPF_CFG-&gt;stub_router = $3; }
<span class="gh">diff -ru a/proto/ospf/dbdes.c b/proto/ospf/dbdes.c</span>
<span class="gd">--- a/proto/ospf/dbdes.c    2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/dbdes.c    2022-12-05 16:54:41.919077802 +0800</span>
<span class="gu">@@ -360,9 +360,11 @@</span>
       (rcv_iface_mtu != ifa-&gt;iface-&gt;mtu) &amp;&amp;
       (rcv_iface_mtu != 0) &amp;&amp; (ifa-&gt;iface-&gt;mtu != 0))
   {
<span class="gd">-    LOG_PKT(&quot;MTU mismatch with nbr %R on %s (remote %d, local %d)&quot;,</span>
<span class="gd">-       n-&gt;rid, ifa-&gt;ifname, rcv_iface_mtu, ifa-&gt;iface-&gt;mtu);</span>
<span class="gd">-    return;</span>
<span class="gi">+    LOG_PKT(&quot;MTU mismatch with nbr %R on %s (remote %d, local %d) %d&quot;,</span>
<span class="gi">+       n-&gt;rid, ifa-&gt;ifname, rcv_iface_mtu, ifa-&gt;iface-&gt;mtu, p-&gt;ignoremtu);</span>
<span class="gi">+    if (!p-&gt;ignoremtu) {</span>
<span class="gi">+       return;</span>
<span class="gi">+    }</span>
   }

   switch (n-&gt;state)
<span class="gh">diff -ru a/proto/ospf/ospf.c b/proto/ospf/ospf.c</span>
<span class="gd">--- a/proto/ospf/ospf.c     2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/ospf.c     2022-12-05 16:57:16.415081613 +0800</span>
<span class="gu">@@ -287,6 +287,7 @@</span>
   p-&gt;af_ext = c-&gt;af_ext;
   p-&gt;af_mc = c-&gt;af_mc;
   p-&gt;rfc1583 = c-&gt;rfc1583;
<span class="gi">+  p-&gt;ignoremtu = c-&gt;ignoremtu;</span>
   p-&gt;stub_router = c-&gt;stub_router;
   p-&gt;merge_external = c-&gt;merge_external;
   p-&gt;instance_id = c-&gt;instance_id;
<span class="gu">@@ -708,6 +709,9 @@</span>
   if (p-&gt;rfc1583 != new-&gt;rfc1583)
     return 0;

<span class="gi">+  if (p-&gt;ignoremtu != new-&gt;ignoremtu)</span>
<span class="gi">+    return 0;</span>
<span class="gi">+</span>
   if (p-&gt;instance_id != new-&gt;instance_id)
     return 0;

<span class="gu">@@ -832,6 +836,7 @@</span>

   cli_msg(-1014, &quot;%s:&quot;, p-&gt;p.name);
   cli_msg(-1014, &quot;RFC1583 compatibility: %s&quot;, (p-&gt;rfc1583 ? &quot;enabled&quot; : &quot;disabled&quot;));
<span class="gi">+  cli_msg(-1014, &quot;Ignore MTU: %s&quot;, (p-&gt;ignoremtu? &quot;enabled&quot; : &quot;disabled&quot;));</span>
   cli_msg(-1014, &quot;Stub router: %s&quot;, (p-&gt;stub_router ? &quot;Yes&quot; : &quot;No&quot;));
   cli_msg(-1014, &quot;RT scheduler tick: %d&quot;, p-&gt;tick);
   cli_msg(-1014, &quot;Number of areas: %u&quot;, p-&gt;areano);
<span class="gh">diff -ru a/proto/ospf/ospf.h b/proto/ospf/ospf.h</span>
<span class="gd">--- a/proto/ospf/ospf.h     2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/ospf.h     2022-12-05 15:19:47.161937314 +0800</span>
<span class="gu">@@ -94,6 +94,7 @@</span>
   u8 af_ext;
   u8 af_mc;
   u8 rfc1583;
<span class="gi">+  u8 ignoremtu;</span>
   u8 stub_router;
   u8 merge_external;
   u8 instance_id;
<span class="gu">@@ -232,6 +233,7 @@</span>
   u8 af_ext;                       /* OSPFv3-AF extension */
   u8 af_mc;                        /* OSPFv3-AF multicast */
   u8 rfc1583;                      /* RFC1583 compatibility */
<span class="gi">+  u8 ignoremtu;</span>
   u8 stub_router;          /* Do not forward transit traffic */
   u8 merge_external;               /* Should i merge external routes? */
   u8 instance_id;          /* Differentiate between more OSPF instances */
</pre></div>
</div>
</section>
<section id="tcpdump-neng-kan-dao-vlan-header-dan-shi-xdp-kan-bu-dao">
<h2>tcpdump èƒ½çœ‹åˆ° vlan headerï¼Œä½†æ˜¯ xdp çœ‹ä¸åˆ°<a class="headerlink" href="#tcpdump-neng-kan-dao-vlan-header-dan-shi-xdp-kan-bu-dao" title="Permalink to this headline">Â¶</a></h2>
<blockquote>
<div><p>Since XDP needs to see the VLAN headers as part of the packet headers, it is important to turn off VLAN hardware offload (which most hardware NICs support), since that will remove the VLAN tag from the packet header and instead communicate it out of band to the kernel via the packet hardware descriptor.</p>
<p><a class="reference external" href="https://github.com/xdp-project/xdp-tutorial/tree/master/packet01-parsing">https://github.com/xdp-project/xdp-tutorial/tree/master/packet01-parsing</a></p>
</div></blockquote>
<p>ä¸€èˆ¬ç½‘å¡éƒ½æœ‰ vlan è§£æ/æ’å…¥çš„ç¡¬ä»¶åŠ é€Ÿï¼š</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -k eth0<span class="p">|</span>grep vlan-offload
<span class="go">rx-vlan-offload: on</span>
<span class="go">tx-vlan-offload: on [fixed]</span>
</pre></div>
</div>
<p>ç½‘å¡ä¼šç›´æ¥ç¡¬ä»¶è§£æ vlan headerï¼Œç„¶åå°† vlan id ç­‰ä¿¡æ¯ç›´æ¥ç»™é©±åŠ¨ï¼ŒDMA ç»™é©±åŠ¨çš„ç½‘ç»œåŒ…ä¼šåˆ é™¤æ‰ vlan header å˜æˆä¸€ä¸ªæ™®é€šçš„ç½‘ç»œåŒ…ã€‚è¿™æ · XDP å°±çœ‹ä¸åˆ° vlan header äº†ã€‚è§£å†³çš„æ–¹æ³•æ˜¯å…³é—­è¿™ä¸ªç¡¬ä»¶åŠ é€Ÿï¼š</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -K eth0 rxvlan off
</pre></div>
</div>
<p>æˆ–è€…é€šè¿‡é…ç½®å°† vlan ä¿¡æ¯ç»™åˆ° XDP ç¨‹åºã€‚</p>
</section>
<section id="xdp-pass-sysctl-net-ipv4-conf-interface-accept-local">
<h2>XDP_PASS &amp; sysctl net.ipv4.conf.interface.accept_local<a class="headerlink" href="#xdp-pass-sysctl-net-ipv4-conf-interface-accept-local" title="Permalink to this headline">Â¶</a></h2>
<p><a class="reference external" href="https://sysctl-explorer.net/net/ipv4/accept_local/">https://sysctl-explorer.net/net/ipv4/accept_local/</a></p>
<p>sysctl <code class="docutils literal notranslate"><span class="pre">net.ipv4.conf.interface.accept_local</span></code> å‚æ•°é»˜è®¤ä¸º FALSEï¼Œæ­¤æ—¶ XDP_PASS ç»™æœ¬æœºçš„ GUE åŒ…çš„æºåœ°å€éœ€è¦æ”¹æˆå…¶ä»–éæœ¬æœº IPï¼Œå¦åˆ™åŒ…ä¼šè¢«ä¸¢æ‰ã€‚æˆ–è€…è®¾ç½® sysctl <code class="docutils literal notranslate"><span class="pre">net.ipv4.conf.interface.accept_local</span></code> å‚æ•°ä¸º TRUEã€‚</p>
</section>
<section id="clang-loop-unroll-full-shi-bai-dao-zhi-de-bpf-jia-zai-shi-bai">
<h2>clang loop unroll(full) å¤±è´¥å¯¼è‡´çš„ BPF åŠ è½½å¤±è´¥<a class="headerlink" href="#clang-loop-unroll-full-shi-bai-dao-zhi-de-bpf-jia-zai-shi-bai" title="Permalink to this headline">Â¶</a></h2>
<p>ä¸‹é¢çš„ä»£ç åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå¾ªç¯ä¼šå±•å¼€å¤±è´¥ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma clang loop unroll(full)</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">L4LB_GUE_IPS_ARRAY_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l4lb_gue_ips</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>æŠ¥ <em>è­¦å‘Š</em>ï¼š</p>
<blockquote>
<div><p>warning: loop not unrolled: the optimizer was unable to perform the requested transformation; the transformation might be part of an unsupported transformation ordering [-Wpass-failed=transform-warning]</p>
</div></blockquote>
<p>è¿™æ ·ç¼–è¯‘å‡ºçš„ bpf ä¼šåŠ è½½å¤±è´¥ï¼ŒæŠ¥ <em>é”™è¯¯</em>ã€‚</p>
<blockquote>
<div><p>invalid argument: back-edge from insn 1456 to 1458</p>
</div></blockquote>
<p>æœç´¢ Linux å†…æ ¸ä»£ç å¯ä»¥çœ‹åˆ°è¿™ä¸ªé”™è¯¯æ˜¯è¯´ bpf ä»£ç ä¸­æœ‰å¾€å›çš„ jump äº†ï¼Œåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹å°±æ˜¯ä¸Šé¢çš„è¿™ä¸ªå¾ªç¯ï¼Œbpf ä¸å…è®¸å¾ªç¯ã€‚</p>
<p>ä¸€ä¸ªè®©ç¼–è¯‘å™¨çš„ä¼˜åŒ–å™¨å¯ä»¥æˆåŠŸå±•å¼€è¿™ä¸ªå¾ªç¯çš„æ–¹æ³•æ˜¯ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma clang loop unroll(full)</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">L4LB_GUE_IPS_ARRAY_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">   </span><span class="c1">// ğŸ‘ˆ</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l4lb_gue_ips</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">j</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>é‚®ä»¶åˆ—è¡¨é‡Œä¹Ÿæœ‰äººé‡åˆ°è¿‡åŒæ ·é—®é¢˜ï¼ˆ<a class="reference external" href="https://lists.linuxfoundation.org/pipermail/iovisor-dev/2017-April/000733.html">https://lists.linuxfoundation.org/pipermail/iovisor-dev/2017-April/000733.html</a>ï¼‰ï¼Œç»™å‡ºçš„è§£é‡Šæ˜¯å°† <code class="docutils literal notranslate"><span class="pre">&amp;i</span></code> è¿™ä¸ªå¾ªç¯è®¡æ•°å˜é‡çš„æŒ‡é’ˆä¼ ç»™ <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_elem</span></code> å‡½æ•°ï¼Œå‡½æ•°ä¸­å¯èƒ½ä¼šæ”¹å˜æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œä½†æ˜¯ä»è¿™ä¸ªå‡½æ•°çš„åŸå‹ <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">void</span> <span class="pre">*(*bpf_map_lookup_elem)(void</span> <span class="pre">*map,</span> <span class="pre">const</span> <span class="pre">void</span> <span class="pre">*key)</span> <span class="pre">=</span> <span class="pre">(void</span> <span class="pre">*)</span> <span class="pre">1</span></code> æ¥çœ‹ï¼Œè¿™ä¸ªå‚æ•°å‰é¢å¸¦äº† const å…³é”®å­—ï¼Œç¼–è¯‘å™¨åº”è¯¥å¯ä»¥çŸ¥é“è¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ªåªè¯»å˜é‡çš„ã€‚</p>
<hr class="docutils" />
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">;</span><span class="w"></span>

<span class="c1">// æŠ¥ error: assignment of read-only location â€˜*pâ€™</span>
<span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="c1">// ä½†æ˜¯åšä¸€ä¸ªå¼ºåˆ¶è½¬æ¢åï¼Œåƒä¸‹é¢è¿™æ ·æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡çš„</span>
<span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p><a class="reference external" href="https://stackoverflow.com/questions/34842224/when-to-use-const-void">https://stackoverflow.com/questions/34842224/when-to-use-const-void</a></p>
<p>const æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ä¹Ÿæ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œä½†è¿™ç§æƒ…å†µç¼–è¯‘å™¨åº”è¯¥è€ƒè™‘å—ï¼Ÿ</p>
</section>
<section id="can-t-get-map-by-id-2637-device-or-resource-busy">
<h2>canâ€™t get map by id(2637): Device or resource busy<a class="headerlink" href="#can-t-get-map-by-id-2637-device-or-resource-busy" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>bpftool map show
<span class="go">2001: hash  flags 0x0</span>
<span class="go">    key 24B  value 48B  max_entries 256  memlock 40960B</span>
<span class="go">2636: percpu_array  name l4lb_director_m  flags 0x0</span>
<span class="go">    key 4B  value 120B  max_entries 1  memlock 8192B</span>
<span class="go">Error: can&#39;t get map by id(2637): Device or resource busy</span>
</pre></div>
</div>
<p>è¿™ä¸ªå¯èƒ½æ˜¯ç”¨æˆ·ç©ºé—´ç¨‹åºæ‰“å¼€äº†å¤ªå¤šçš„ 2637 è¿™ä¸ª id çš„ bpf map fd å¯¼è‡´çš„ã€‚å†…æ ¸ä»£ç é™åˆ¶äº†ä¸€ä¸ª map æœ€å¤šå¯ä»¥æ‰“å¼€ 32768 ä¸ª fdã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BPF_MAX_REFCNT 32768</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">bpf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="k">union</span> <span class="nc">bpf_attr</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">uattr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="o">|-</span><span class="w"> </span><span class="n">bpf_map_get_fd_by_id</span><span class="p">()</span><span class="w"></span>
<span class="w">   </span><span class="o">|-</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="w">   </span><span class="o">|-</span><span class="w"> </span><span class="n">bpf_map_inc_not_zero</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">|-</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
<span class="w">      </span><span class="o">|-</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">refold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_fetch_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">|-</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">refold</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BPF_MAX_REFCNT</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">|-</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">|-</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="ru-he-huo-de-yi-ge-jin-cheng-da-kai-de-bpf-map-fd-dui-ying-de-map-id">
<h2>å¦‚ä½•è·å¾—ä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„ bpf map fd å¯¹åº”çš„ map id<a class="headerlink" href="#ru-he-huo-de-yi-ge-jin-cheng-da-kai-de-bpf-map-fd-dui-ying-de-map-id" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>lsof -p <span class="m">3248691</span> <span class="p">|</span>grep bpf-map
<span class="go">nginx   3248691 nobody    4u  a_inode               0,13        0      14337 bpf-map</span>
<span class="gp"># </span>cat /proc/3248691/fdinfo/4
<span class="go">...</span>
<span class="go">map_id:     16392</span>
</pre></div>
</div>
</section>
<section id="bpf-map-type-prog-array-lei-xing-map-xie-ru-cheng-gong-dan-shi-bpftool-dump-map-fa-xian-mei-you-xie-ru-de-yuan-su">
<h2>BPF_MAP_TYPE_PROG_ARRAY ç±»å‹ map å†™å…¥æˆåŠŸä½†æ˜¯ bpftool dump map å‘ç°æ²¡æœ‰å†™å…¥çš„å…ƒç´ <a class="headerlink" href="#bpf-map-type-prog-array-lei-xing-map-xie-ru-cheng-gong-dan-shi-bpftool-dump-map-fa-xian-mei-you-xie-ru-de-yuan-su" title="Permalink to this headline">Â¶</a></h2>
<p>ç”¨æˆ·æ€ç¨‹åºå¦‚æœå…³é—­ BPF_MAP_TYPE_PROG_ARRAY çš„ mapï¼Œä¼šç»™ map ä¸­æ‰€æœ‰çš„ prog çš„å¼•ç”¨è®¡æ•°å‡ 1ï¼Œæ·»åŠ çš„æ—¶å€™æ‰€æœ‰çš„ prog ä¼šå¼•ç”¨åŠ  1ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–æ“ä½œï¼Œè¿™ä¸ª prog ä¼šè¢«è‡ªåŠ¨æ¸…ç†æ‰ã€‚</p>
<p>è§£å†³æ–¹æ³•å°±æ˜¯è¦ä¹ˆç”¨æˆ·ç©ºé—´ç¨‹åºä¸è¦å…³é—­è¿™ä¸ª mapï¼Œæˆ–è€…å…³é—­å‰å°†è¿™ä¸ª map å›ºå®šåˆ° bpf æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">file_operations</span><span class="w"> </span><span class="n">bpf_map_fops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">release</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_release</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">bpf_map_release</span><span class="w"></span>
<span class="o">|-</span><span class="w"> </span><span class="n">map</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_release</span><span class="p">()</span><span class="w"></span>
<span class="w">   </span><span class="o">|-</span><span class="w"> </span><span class="n">prog_array_map_clear</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">|-</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">array</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">max_entries</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">|-</span><span class="w">   </span><span class="n">__fd_array_map_delete_elem</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">need_defer</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="o">|-</span><span class="w"> </span><span class="n">map</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_fd_put_ptr</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">old_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">need_defer</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bpf-yan-zheng-qi-bao-math-between-pkt-pointer-and-register-with-unbounded-min-value-is-not-allowed">
<h2>bpf éªŒè¯å™¨æŠ¥ math between pkt pointer and register with unbounded min value is not allowed<a class="headerlink" href="#bpf-yan-zheng-qi-bao-math-between-pkt-pointer-and-register-with-unbounded-min-value-is-not-allowed" title="Permalink to this headline">Â¶</a></h2>
<p>æœ‰æ—¶å€™æ ¡éªŒå™¨æŠ¥é”™ä¸ä¸€å®šæ˜¯ç¨‹åºä»£ç æœ‰é—®é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨ä½ç‰ˆæœ¬çš„å†…æ ¸ä¸Šï¼Œä¹Ÿå¯èƒ½æ˜¯ bpf æ ¡éªŒå™¨æœ¬èº«æœ‰é—®é¢˜ã€‚æ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">return</span><span class="w"> </span><span class="n">buf_skip</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>è¿™æ®µä»£ç æœ‰äº›æ—¶å€™ç¼–è¯‘çš„æ—¶å€™æ²¡é—®é¢˜ï¼Œæœ‰äº›æ—¶å€™ï¼ˆå…¶ä»–ä»£ç å˜äº†ï¼‰ç¼–è¯‘ä¹‹ååœ¨é«˜ç‰ˆæœ¬å†…æ ¸ä¸Šæ²¡é—®é¢˜ï¼Œåœ¨ä½ç‰ˆæœ¬æ¯”å¦‚ 4.19 å†…æ ¸ä¸Šå°±æŠ¥ <code class="docutils literal notranslate"><span class="pre">math</span> <span class="pre">between</span> <span class="pre">pkt</span> <span class="pre">pointer</span> <span class="pre">and</span> <span class="pre">register</span> <span class="pre">with</span> <span class="pre">unbounded</span> <span class="pre">min</span> <span class="pre">value</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">allowed</span></code> é”™è¯¯ã€‚</p>
<p>åæ±‡ç¼– bpf ç¨‹åºï¼Œæ ¹æ®æŠ¥é”™çš„ä¿¡æ¯å¯ä»¥å®šä½åˆ°ä»£ç è¡Œæ•°ï¼Œå¯ä»¥å‘ç°ä¸Šé¢çš„ä»£ç ç¼–è¯‘å‡ºæ¥çš„ bpf æŒ‡ä»¤ç æœ‰é—®é¢˜å’Œæ²¡é—®é¢˜çš„æ—¶å€™ä¸ä¸€æ ·ã€‚</p>
<p>é¦–å…ˆæ²¡é—®é¢˜çš„ï¼š</p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="x">; if (ipv4-&gt;ihl &lt; 5) {</span>
<span class="x">    187:       r4 = *(u8 *)(r8 + 0)</span>
<span class="x">    188:       r4 &amp;= 15</span>
<span class="x">    189:       r5 = 5</span>
<span class="x">    190:       if r5 &gt; r4 goto +157 &lt;LBB0_154&gt;</span>
<span class="x">; if (ipv4-&gt;ihl &lt;= 5) {</span>
<span class="x">    191:       if r4 == 5 goto +4 &lt;LBB0_28&gt;</span>
<span class="x">; return buf_skip(buf, (ipv4-&gt;ihl - 5) * 4);</span>
<span class="x">    192:       r4 &lt;&lt;= 2</span>
<span class="x">; if (buf-&gt;head + len &gt; buf-&gt;tail) {</span>
<span class="x">    193:       r8 += r4</span>
</pre></div>
</div>
<p>æœ‰é—®é¢˜çš„ï¼š</p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="x">; if (ipv4-&gt;ihl &lt; 5) {</span>
<span class="x">    221:       r3 = *(u8 *)(r4 + 0)</span>
<span class="x">    222:       r3 &amp;= 15</span>
<span class="x">    223:       r5 = 5</span>
<span class="x">    224:       *(u64 *)(r10 - 104) = r3</span>
<span class="x">    225:       if r5 &gt; r3 goto +178 &lt;LBB0_165&gt;</span>
<span class="x">; if (ipv4-&gt;ihl &lt;= 5) {</span>
<span class="x">    226:       r5 = *(u64 *)(r10 - 104)</span>
<span class="x">    227:       if r5 == 5 goto +5 &lt;LBB0_29&gt;</span>
<span class="x">    228:       r3 = *(u64 *)(r10 - 104)</span>
<span class="x">; return buf_skip(buf, (ipv4-&gt;ihl - 5) * 4);</span>
<span class="x">    229:       r3 &lt;&lt;= 2</span>
<span class="x">; if (buf-&gt;head + len &gt; buf-&gt;tail) {</span>
<span class="x">    230:       r4 += r3 ğŸ‘ˆ æŠ¥é”™è¡Œ</span>
</pre></div>
</div>
<p>å¯¹æ¯” bpf æŒ‡ä»¤ç å¯ä»¥çœ‹å‡ºï¼Œæ²¡é—®é¢˜çš„ç‰ˆæœ¬ä¸­ <code class="docutils literal notranslate"><span class="pre">ipv4-&gt;ihl</span></code> è¿™ä¸ªå˜é‡å§‹ç»ˆæ˜¯ä¿å­˜åœ¨ <code class="docutils literal notranslate"><span class="pre">r4</span></code> è¿™ä¸ªå¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">buf_skip</span></code> å‡½æ•°çš„æ—¶å€™ï¼Œæ ¡éªŒå™¨å¯ä»¥å¾ˆå®¹æ˜“è·Ÿè¸ªå¾—åˆ° <code class="docutils literal notranslate"><span class="pre">ipv4-&gt;ihl</span> <span class="pre">-</span> <span class="pre">5</span></code> è‚¯å®šæ˜¯å¤§äº 0 çš„ï¼Œä½†æ˜¯å¯¹äºæœ‰é—®é¢˜çš„ç‰ˆæœ¬ä¸­ï¼Œç”Ÿæˆçš„ bpf ä»£ç æ˜¯ä»æ ˆä¸ŠåŠ è½½çš„å˜é‡å€¼ï¼Œä½ç‰ˆæœ¬çš„æ—¶å€™ï¼Œæ ¡éªŒå™¨è¿˜ä¸èƒ½è·Ÿè¸ªæ ˆä¸Šçš„å˜é‡ï¼Œæ‰€ä»¥è¿™é‡Œè·Ÿè¸ªå¤±è´¥ï¼Œå¯¼è‡´æ ¡éªŒå™¨æ— æ³•ç¡®å®šå€¼çš„èŒƒå›´ï¼ŒæŠ¥è¿™ä¸ªé”™è¯¯ã€‚</p>
<p>è§£å†³çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ç”¨ asm å¼ºåˆ¶å°†ä¸Šé¢ 226-228 è¡Œè¿™é‡Œçš„ <code class="docutils literal notranslate"><span class="pre">r5</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">r3</span></code> å¯„å­˜å™¨å¼ºåˆ¶ä¸ºä¸€ä¸ªï¼Œè¿™æ ·å°±èƒ½è®©æ ¡éªŒå™¨è·Ÿè¸ªåˆ°å˜é‡çš„èŒƒå›´ä»è€Œé¿å…è¿™ä¸ªé”™è¯¯ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%0 = %1&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">));</span><span class="w"> </span><span class="cm">/* a = ipv4-&gt;ihl */</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">return</span><span class="w"> </span><span class="n">buf_skip</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>å¦å¤–é«˜å†…æ ¸ï¼ˆ5.3 ä¹‹åï¼‰åº”è¯¥å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†ã€‚</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.mail-archive.com/iovisor-dev&#64;lists.iovisor.org/msg01390.html">https://www.mail-archive.com/iovisor-dev&#64;lists.iovisor.org/msg01390.html</a></p></li>
<li><p><a class="reference external" href="https://discourse.llvm.org/t/forcing-llvm-to-not-spill-specific-variables-to-the-stack-when-compiling-to-bpf/59002">https://discourse.llvm.org/t/forcing-llvm-to-not-spill-specific-variables-to-the-stack-when-compiling-to-bpf/59002</a></p></li>
</ul>
</section>
<section id="zhuan-fa-biao-fen-pei-jun-yun-dan-shi-you-hou-duan-ji-qi-de-liu-liang-hen-xiao">
<h2>è½¬å‘è¡¨åˆ†é…å‡åŒ€ä½†æ˜¯æœ‰åç«¯æœºå™¨çš„æµé‡å¾ˆå°<a class="headerlink" href="#zhuan-fa-biao-fen-pei-jun-yun-dan-shi-you-hou-duan-ji-qi-de-liu-liang-hen-xiao" title="Permalink to this headline">Â¶</a></h2>
<p>ç¨‹åºã€è½¬å‘è¡¨æ‰€æœ‰ä¸€åˆ‡éƒ½æ­£å¸¸ï¼Œä½†æ˜¯å°±æ˜¯æœ‰åç«¯æœºå™¨çš„æµé‡å¾ˆå°ï¼Œé‡‡æ ·ç»Ÿè®¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è¿›ä¸€æ­¥é‡‡æ ·è½¬å‘çš„ GUE æµé‡å¹¶è§£åŒ…ï¼Œçœ‹çœ‹è½¬å‘çš„æµé‡æ˜¯å¦æœ‰ç‰¹å¾ã€‚</p>
<p>çº¿ä¸Šæ›¾ç»å‡ºç°è¿‡çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯å‡çº§çš„æ—¶å€™ç”±äºä»£ç  BUGï¼Œå¯¼è‡´æŸäº›æœºå™¨ä¸Š fou æ¨¡å—æ²¡æœ‰æˆåŠŸåŠ è½½ï¼Œè°ƒåº¦åˆ°è¿™äº›åç«¯çš„æµé‡æ— æ³•è¢«å¤„ç†ï¼Œsyn åŒ…ä¼šä¸€ç›´é‡è¯•ï¼Œå°±ä¼šå‡ºç°ä¸Šé¢è¯´çš„è¿™ç§ç°è±¡ã€‚</p>
</section>
<section id="systemd-shi-yong-root-yong-hu-qi-dong-fu-wu-bao-bpf-map-create-failed-permission-denied">
<h2>systemd ä½¿ç”¨ root ç”¨æˆ·å¯åŠ¨æœåŠ¡æŠ¥ bpf map create failed: permission denied<a class="headerlink" href="#systemd-shi-yong-root-yong-hu-qi-dong-fu-wu-bao-bpf-map-create-failed-permission-denied" title="Permalink to this headline">Â¶</a></h2>
<p>ä½†æ˜¯æ‰‹å·¥å¯åŠ¨æ²¡æœ‰é—®é¢˜ï¼Œè¿™ä¸ªå¯èƒ½æ˜¯ selinux çš„é—®é¢˜ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>getenforce
<span class="go">Enforcing</span>
</pre></div>
</div>
<p>æ£€æŸ¥ selinux æ˜¯ä¸æ˜¯åœ¨ Enforcing çŠ¶æ€ï¼Œæ˜¯çš„è¯æ£€æŸ¥ <code class="docutils literal notranslate"><span class="pre">/var/log/audit/audit.log</span></code> çœ‹æ˜¯ä¸æ˜¯è¢« selinux æ‹¦äº†ã€‚ç®€å•çš„å¤„ç†æ–¹å¼æ˜¯å…³äº† selinux <code class="docutils literal notranslate"><span class="pre">setenforce</span> <span class="pre">0</span></code> ã€‚</p>
<p><a class="reference external" href="https://superuser.com/questions/1125250/systemctl-access-denied-when-root">https://superuser.com/questions/1125250/systemctl-access-denied-when-root</a></p>
</section>
<section id="yong-hu-kong-jian-bpf-map-lookup-elem-fan-hui-enoent">
<h2>ç”¨æˆ·ç©ºé—´ bpf_map_lookup_elem è¿”å› ENOENT<a class="headerlink" href="#yong-hu-kong-jian-bpf-map-lookup-elem-fan-hui-enoent" title="Permalink to this headline">Â¶</a></h2>
<p>è¿™ä¸ªä¸æ˜¯é”™è¯¯ï¼Œæ˜¯ key ä¸å­˜åœ¨ã€‚</p>
<p><a class="reference external" href="https://elixir.bootlin.com/linux/v4.19/source/kernel/bpf/syscall.c#L718">https://elixir.bootlin.com/linux/v4.19/source/kernel/bpf/syscall.c#L718</a></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">map_lookup_elem</span><span class="p">(</span><span class="k">union</span> <span class="nc">bpf_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">..</span><span class="w"></span>
<span class="w">    </span><span class="n">rcu_read_lock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map_lookup_elem</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">value_size</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rcu_read_unlock</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="kua-ji-fang-diao-du-ttl-tai-xiao-dao-zhi-zhuan-fa-shi-bai">
<h2>è·¨æœºæˆ¿è°ƒåº¦ ttl å¤ªå°å¯¼è‡´è½¬å‘å¤±è´¥<a class="headerlink" href="#kua-ji-fang-diao-du-ttl-tai-xiao-dao-zhi-zhuan-fa-shi-bai" title="Permalink to this headline">Â¶</a></h2>
<p>å¦‚é¢˜ã€‚</p>
</section>
<section id="virtio-net-qu-dong-jia-zai-xdp-driver-mo-shi-shi-bai">
<h2>virtio-net é©±åŠ¨åŠ è½½ xdp driver æ¨¡å¼å¤±è´¥<a class="headerlink" href="#virtio-net-qu-dong-jia-zai-xdp-driver-mo-shi-shi-bai" title="Permalink to this headline">Â¶</a></h2>
<p>åŠ è½½ xdp ç¨‹åºæŠ¥é”™ <code class="docutils literal notranslate"><span class="pre">load</span> <span class="pre">xdp</span> <span class="pre">root</span> <span class="pre">failed:</span> <span class="pre">cannot</span> <span class="pre">allocate</span> <span class="pre">memory</span></code> ã€‚</p>
<p>dmesg å†…æ ¸é”™è¯¯ä¿¡æ¯ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>  <span class="mf">717.248974</span><span class="p">]</span> <span class="n">virtio_net</span> <span class="n">virtio0</span> <span class="n">eth0</span><span class="p">:</span> <span class="n">request</span> <span class="mi">4</span> <span class="n">queues</span> <span class="n">but</span> <span class="nb">max</span> <span class="ow">is</span> <span class="mi">2</span>
</pre></div>
</div>
<p>æŠ¥é”™çš„ç‚¹ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">curr_qp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">curr_queue_pairs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">xdp_queue_pairs</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prog</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">xdp_qp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nr_cpu_ids</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* XDP requires extra queues for XDP_TX */</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_qp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xdp_qp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">max_queue_pairs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;request %i queues but max is %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">curr_qp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xdp_qp</span><span class="p">,</span><span class="w"> </span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">max_queue_pairs</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=672aafd5d88a951f394334802b938b502010d9eb">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=672aafd5d88a951f394334802b938b502010d9eb</a></p></li>
<li><p><a class="reference external" href="https://elixir.bootlin.com/linux/v4.17.2/source/drivers/net/virtio_net.c#L2213">https://elixir.bootlin.com/linux/v4.17.2/source/drivers/net/virtio_net.c#L2213</a></p></li>
<li><p><a class="reference external" href="https://github.com/iovisor/bcc/issues/1833#issuecomment-397882174">https://github.com/iovisor/bcc/issues/1833#issuecomment-397882174</a></p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -l eth0
<span class="go">Channel parameters for eth0:</span>
<span class="go">Pre-set maximums:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              0</span>
<span class="go">Combined:   2</span>
<span class="go">Current hardware settings:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              0</span>
<span class="go">Combined:   2</span>

<span class="gp"># </span>nproc
<span class="go">2</span>
</pre></div>
</div>
<p>xdp é»˜è®¤è¦ç”³è¯·ç‹¬ç«‹çš„ queueï¼Œä½†ç½‘å¡æœ€å¤§å°± 2 ä¸ª queueï¼Œå·²ç»ç”³è¯·äº† 2 ä¸ªç”¨ä½œ rx+txï¼ˆcombined å°±æ˜¯å…±ç”¨ï¼‰é˜Ÿåˆ—ï¼Œä¸æ”¯æŒå†é¢å¤–ç”³è¯· xdp tx queue äº†ã€‚</p>
<p>æ€ä¹ˆè§£å†³ï¼Ÿ</p>
<p>ç®€å•çš„æ–¹å¼å…±ç”¨ç°æœ‰çš„ queueï¼Œå‚è§æäº¤ï¼š<a class="reference external" href="https://github.com/torvalds/linux/commit/97c2c69e1926260c78c7f1c0b2c987934f1dc7a1">https://github.com/torvalds/linux/commit/97c2c69e1926260c78c7f1c0b2c987934f1dc7a1</a>ã€‚è¦åšçš„å°±æ˜¯å‡çº§é©±åŠ¨å³å¯ã€‚</p>
<p>æˆ–è€…å¯ä»¥æ”¹ç¡¬ä»¶çš„ maxï¼ˆ# Enable multiqueue virtio-netï¼‰ï¼Ÿ <a class="reference external" href="https://en.opensuse.org/Testing_XDP_with_virtio-net">https://en.opensuse.org/Testing_XDP_with_virtio-net</a></p>
</section>
<section id="bpf-yan-zheng-qi-bao-invalid-indirect-read-from-stack">
<h2>bpf éªŒè¯å™¨æŠ¥ invalid indirect read from stack<a class="headerlink" href="#bpf-yan-zheng-qi-bao-invalid-indirect-read-from-stack" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">ethhdr</span><span class="w"> </span><span class="n">eth</span><span class="p">;</span><span class="w"></span>
<span class="c1">// memset(&amp;eth, 0, sizeof(eth));</span>
<span class="n">eth</span><span class="p">.</span><span class="n">h_proto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_ntohs</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">);</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_skb_store_bytes</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">eth</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">eth</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// ğŸ‘ˆ è¿™é‡ŒæŠ¥é”™</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>æœªåˆå§‹åŒ–æ ˆå†…å…ƒç´ ï¼Œå°±ä¼ é€’è¯¥æ ˆåœ°å€ã€‚æŠŠä¸Šé¢ memset å‰é¢çš„æ³¨é‡Šå»æ‰å°±æ²¡é—®é¢˜äº†ã€‚</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">#220330 é—®é¢˜</a><ul>
<li><a class="reference internal" href="#ixgbe-detected-tx-unit-hang">ixgbe Detected Tx Unit Hang</a></li>
<li><a class="reference internal" href="#i40e-x722-unable-to-handle-kernel-null-pointer-dereference">i40e/X722 unable to handle kernel NULL pointer dereference</a></li>
<li><a class="reference internal" href="#di-er-tiao-zhi-jie-zhai-chu-vip-fu-wu-qi-kai-qi-le-ip-forward-zao-cheng-de-bao-xun-huan">ç¬¬äºŒè·³ç›´æ¥æ‘˜é™¤ VIP + æœåŠ¡å™¨å¼€å¯äº† ip_forward é€ æˆçš„åŒ…å¾ªç¯</a></li>
<li><a class="reference internal" href="#ipv4-vip-fang-wen-zheng-chang-ipv6-fang-wen-yi-chang-ke-neng-de-wen-ti">IPv4 VIP è®¿é—®æ­£å¸¸ã€IPv6 è®¿é—®å¼‚å¸¸å¯èƒ½çš„é—®é¢˜</a></li>
<li><a class="reference internal" href="#jiao-huan-ji-he-fu-wu-qi-shang-mtu-bu-yi-zhi-dao-zhi-de-bird-ospf-shi-bai">äº¤æ¢æœºå’ŒæœåŠ¡å™¨ä¸Š MTU ä¸ä¸€è‡´å¯¼è‡´çš„ bird ospf å¤±è´¥</a></li>
<li><a class="reference internal" href="#tcpdump-neng-kan-dao-vlan-header-dan-shi-xdp-kan-bu-dao">tcpdump èƒ½çœ‹åˆ° vlan headerï¼Œä½†æ˜¯ xdp çœ‹ä¸åˆ°</a></li>
<li><a class="reference internal" href="#xdp-pass-sysctl-net-ipv4-conf-interface-accept-local">XDP_PASS &amp; sysctl net.ipv4.conf.interface.accept_local</a></li>
<li><a class="reference internal" href="#clang-loop-unroll-full-shi-bai-dao-zhi-de-bpf-jia-zai-shi-bai">clang loop unroll(full) å¤±è´¥å¯¼è‡´çš„ BPF åŠ è½½å¤±è´¥</a></li>
<li><a class="reference internal" href="#can-t-get-map-by-id-2637-device-or-resource-busy">canâ€™t get map by id(2637): Device or resource busy</a></li>
<li><a class="reference internal" href="#ru-he-huo-de-yi-ge-jin-cheng-da-kai-de-bpf-map-fd-dui-ying-de-map-id">å¦‚ä½•è·å¾—ä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„ bpf map fd å¯¹åº”çš„ map id</a></li>
<li><a class="reference internal" href="#bpf-map-type-prog-array-lei-xing-map-xie-ru-cheng-gong-dan-shi-bpftool-dump-map-fa-xian-mei-you-xie-ru-de-yuan-su">BPF_MAP_TYPE_PROG_ARRAY ç±»å‹ map å†™å…¥æˆåŠŸä½†æ˜¯ bpftool dump map å‘ç°æ²¡æœ‰å†™å…¥çš„å…ƒç´ </a></li>
<li><a class="reference internal" href="#bpf-yan-zheng-qi-bao-math-between-pkt-pointer-and-register-with-unbounded-min-value-is-not-allowed">bpf éªŒè¯å™¨æŠ¥ math between pkt pointer and register with unbounded min value is not allowed</a></li>
<li><a class="reference internal" href="#zhuan-fa-biao-fen-pei-jun-yun-dan-shi-you-hou-duan-ji-qi-de-liu-liang-hen-xiao">è½¬å‘è¡¨åˆ†é…å‡åŒ€ä½†æ˜¯æœ‰åç«¯æœºå™¨çš„æµé‡å¾ˆå°</a></li>
<li><a class="reference internal" href="#systemd-shi-yong-root-yong-hu-qi-dong-fu-wu-bao-bpf-map-create-failed-permission-denied">systemd ä½¿ç”¨ root ç”¨æˆ·å¯åŠ¨æœåŠ¡æŠ¥ bpf map create failed: permission denied</a></li>
<li><a class="reference internal" href="#yong-hu-kong-jian-bpf-map-lookup-elem-fan-hui-enoent">ç”¨æˆ·ç©ºé—´ bpf_map_lookup_elem è¿”å› ENOENT</a></li>
<li><a class="reference internal" href="#kua-ji-fang-diao-du-ttl-tai-xiao-dao-zhi-zhuan-fa-shi-bai">è·¨æœºæˆ¿è°ƒåº¦ ttl å¤ªå°å¯¼è‡´è½¬å‘å¤±è´¥</a></li>
<li><a class="reference internal" href="#virtio-net-qu-dong-jia-zai-xdp-driver-mo-shi-shi-bai">virtio-net é©±åŠ¨åŠ è½½ xdp driver æ¨¡å¼å¤±è´¥</a></li>
<li><a class="reference internal" href="#bpf-yan-zheng-qi-bao-invalid-indirect-read-from-stack">bpf éªŒè¯å™¨æŠ¥ invalid indirect read from stack</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/l4lb/220330.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="https://cn.bing.com/search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>
$('#searchbox').show(0);
document.getElementsByClassName('search')[0].addEventListener('submit', function(event) {
  event.preventDefault();
  var form = event.target;
  var input = form.querySelector('input[name="q"]');
  var value = input.value;
  var q = 'ensearch=1&q=site%3Achanfung032.github.io++' + value;
  var url = form.action + '?' + q;
  window.location.href = url;
});
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, chanfung032.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/l4lb/220330.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>