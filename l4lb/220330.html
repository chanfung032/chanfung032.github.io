
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>#220330 问题 &#8212; Feng&#39;s blog 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/custom.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="#220321 FB: From XDP to Socket" href="220321.html" />
    <link rel="prev" title="#220721 探活、TIME_WAIT 以及 SO_LINGER" href="220721.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="wen-ti">
<h1>#220330 问题<a class="headerlink" href="#wen-ti" title="Permalink to this headline">¶</a></h1>
<section id="ixgbe-detected-tx-unit-hang">
<h2>ixgbe Detected Tx Unit Hang<a class="headerlink" href="#ixgbe-detected-tx-unit-hang" title="Permalink to this headline">¶</a></h2>
<p>现象是网卡不断重启，查看 <code class="docutils literal notranslate"><span class="pre">/var/log/message</span></code> 可以看到以下错误信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span> <span class="n">ixgbe</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">p4p1</span><span class="p">:</span> <span class="n">Detected</span> <span class="n">Tx</span> <span class="n">Unit</span> <span class="n">Hang</span> <span class="p">(</span><span class="n">XDP</span><span class="p">)</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">Tx</span> <span class="n">Queue</span>             <span class="o">&lt;</span><span class="mi">24</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">TDH</span><span class="p">,</span> <span class="n">TDT</span>             <span class="o">&lt;</span><span class="mi">84</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">136</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">next_to_use</span>          <span class="o">&lt;</span><span class="mi">136</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">next_to_clean</span>        <span class="o">&lt;</span><span class="mi">84</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span> <span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">next_to_clean</span><span class="p">]</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">time_stamp</span>           <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">jiffies</span>              <span class="o">&lt;</span><span class="mi">128</span><span class="n">edcdc0</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797955</span><span class="p">]</span> <span class="n">ixgbe</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">p4p1</span><span class="p">:</span> <span class="n">tx</span> <span class="n">hang</span> <span class="mi">1</span> <span class="n">detected</span> <span class="n">on</span> <span class="n">queue</span> <span class="mi">25</span><span class="p">,</span> <span class="n">resetting</span> <span class="n">adapter</span>
<span class="o">...</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span> <span class="n">kernel</span><span class="p">:</span> <span class="p">[</span><span class="mf">687078.764725</span><span class="p">]</span> <span class="n">bond0</span><span class="p">:</span> <span class="n">link</span> <span class="n">status</span> <span class="n">down</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">p4p2</span><span class="p">,</span> <span class="n">disabling</span> <span class="n">it</span> <span class="ow">in</span> <span class="mi">200</span> <span class="n">ms</span>
</pre></div>
</div>
<p>这个问题是 ixgbe 驱动 xdp 实现 BUG 导致，出现在 cpu 比较多的机器。</p>
<blockquote>
<div><p>When the received core is such that the xdp queue falls beyond
MAX_TX_QUEUES(64), then the hang results. In other words, if I leave
<cite>ethtool -L eno1 combined 40</cite> (the default), and a packet is received on
core 24 or greater, it hangs. However, if I lower the tx queue count to
24 (since XDP is forced to nr_cpu_ids), or if I force the incoming
packets onto core &lt; 24 with an ntuple filter, then no hang occurs.</p>
</div></blockquote>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -l p4p1
<span class="go">Channel parameters for p4p1:</span>
<span class="go">Pre-set maximums:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              1</span>
<span class="go">Combined:   63</span>
<span class="go">Current hardware settings:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              1</span>
<span class="go">Combined:   28</span>
<span class="gp"># </span>nproc
<span class="go">56</span>
<span class="gp"># </span>uname -r
<span class="go">4.19.113-88.4bs.el7.centos.x86_64</span>
</pre></div>
</div>
<p>当 <code class="docutils literal notranslate"><span class="pre">combined</span> <span class="pre">+</span> <span class="pre">xdp</span> <span class="pre">queues(nr_cpu_ids)</span> <span class="pre">&gt;</span> <span class="pre">max_tx_queues(64)</span></code> 就会出现这个问题。</p>
<p>详细问题讨论在这两个 thread 中：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.spinics.net/lists/netdev/msg439438.html">https://www.spinics.net/lists/netdev/msg439438.html</a></p></li>
<li><p><a class="reference external" href="https://www.spinics.net/lists/netdev/msg519914.html">https://www.spinics.net/lists/netdev/msg519914.html</a></p></li>
</ul>
<p>不升级内核的情况下，可以通过 <code class="docutils literal notranslate"><span class="pre">ethtool</span> <span class="pre">-L</span> <span class="pre">p4p1</span> <span class="pre">combined</span> <span class="pre">N</span></code> 命令调低 combined 的个数，绕过这个 BUG，但是会影响性能。</p>
<p>BUG 在 4.20-rc1 已经修复。参见：<a class="reference external" href="https://github.com/torvalds/linux/commit/8d7179b1e2d64b3493c0114916486fe92e6109a9">https://github.com/torvalds/linux/commit/8d7179b1e2d64b3493c0114916486fe92e6109a9</a></p>
<p>另一个解决问题的方法是设定 XDP 加载模式为 skb 模式，同样会影响性能，但是不需要升级内核。</p>
</section>
<section id="i40e-x722-unable-to-handle-kernel-null-pointer-dereference">
<h2>i40e/X722 unable to handle kernel NULL pointer dereference<a class="headerlink" href="#i40e-x722-unable-to-handle-kernel-null-pointer-dereference" title="Permalink to this headline">¶</a></h2>
<p>i40e 驱动，网卡是 X722 型号的，在加载 xdp 的时候会报这个错误。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -i enp61s0f0
<span class="go">driver: i40e</span>
<span class="go">version: 2.3.2-k</span>
<span class="go">...</span>
<span class="gp"># </span>lshw -class network -short
<span class="go">H/W path         Device      Class          Description</span>
<span class="go">=======================================================</span>
<span class="go">/0/0/0/3/0       enp61s0f0   network        Ethernet Connection X722 for 10GbE SFP+</span>
<span class="go">/0/0/0/3/0.1     enp61s0f1   network        Ethernet Connection X722 for 10GbE SFP+</span>
<span class="go">/3               bond0       network        Ethernet interface</span>
</pre></div>
</div>
<p>错误信息如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:3d:00.0: setup of MAIN VSI failed
i40e 0000:3d:00.0: can&#39;t remove VEB 160 with 0 VSIs left
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
Oops: 0000 [#1] SMP NOPTI
CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:3d:00.0: setup of MAIN VSI failed
i40e 0000:3d:00.0: can&#39;t remove VEB 160 with 0 VSIs left
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
Oops: 0000 [#1] SMP NOPTI
Oops: 0000 [#1] SMP NOPTI
CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
Code: 87 ab d0 0c 00 00 84 c0 75 60 31 c0 66 83 bb f6 0c 00 00 00 74 27 48 8b 93 90 0c 00 00 48 63 f0 48 8b 8b d0 0c 00 00 83 c0 01 &lt;48&gt; 8b 14 f2 48 89 4a 20 0f b7 93 f6 0c 00 00 39 d0 7c d9 48 85 ed
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
RSP: 0018:ffff9d00ea6af8c0 EFLAGS: 00010202
RAX: 0000000000000001 RBX: ffff88f5f75fc000 RCX: ffff9d00c01ef000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff88f5ffcd68f0
RBP: 0000000000000000 R08: 0000000000000070 R09: 0000000000027e7c
R10: ffff89063ff468c0 R11: 0000000000000707 R12: ffff88f5f7600000
R13: ffffffffc0308aa0 R14: ffffffffc032c5a0 R15: 000000000000000f
FS:  00007f25f9ffb700(0000) GS:ffff88f5ffcc0000(0000) knlGS:0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000001fb3828004 CR4: 00000000007606e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
 dev_xdp_install+0x4f/0x70
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 dev_change_xdp_fd+0x103/0x210
 ? dev_disable_lro+0xa0/0xa0
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 do_setlink+0xd63/0xd90
 ? cpumask_next+0x16/0x20
 ? do_kernel_range_flush+0x50/0x50
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? nla_parse+0xa4/0x120
 rtnl_setlink+0xd7/0x140
 ? security_capset+0x50/0x70
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 rtnetlink_rcv_msg+0x28f/0x350
 ? _cond_resched+0x15/0x30
 ? __kmalloc_node_track_caller+0x188/0x280
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? rtnl_calcit.isra.27+0x110/0x110
 netlink_rcv_skb+0xd4/0x110
 netlink_unicast+0x182/0x230
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 netlink_sendmsg+0x2ed/0x3e0
 sock_sendmsg+0x36/0x50
 __sys_sendto+0xdc/0x160
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? sock_setsockopt+0x3b9/0xc80
 ? syscall_trace_enter+0x1c9/0x2c0
 ? __audit_syscall_exit+0x213/0x350
 __x64_sys_sendto+0x24/0x30
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 do_syscall_64+0x5b/0x1a0
 entry_SYSCALL_64_after_hwframe+0x44/0xa9
RIP: 0033:0x4aeeea
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
Code: e8 5b 9c fb ff 48 8b 7c 24 10 48 8b 74 24 18 48 8b 54 24 20 4c 8b 54 24 28 4c 8b 44 24 30 4c 8b 4c 24 38 48 8b 44 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 76 20 48 c7 44 24 40 ff ff ff ff 48 c7 44 24 4

RSP: 002b:000000c0003d8f98 EFLAGS: 00000216 ORIG_RAX: 000000000000002c
</pre></div>
</div>
<p>这个是驱动 BUG，升级驱动可解决。</p>
<ul class="simple">
<li><p>驱动下载：<a class="reference external" href="https://www.intel.com/content/www/us/en/download/18026/intel-network-adapter-driver-for-pcie-40-gigabit-ethernet-network-connections-under-linux.html">https://www.intel.com/content/www/us/en/download/18026/intel-network-adapter-driver-for-pcie-40-gigabit-ethernet-network-connections-under-linux.html</a></p></li>
<li><p>邮件列表同样问题讨论：<a class="reference external" href="https://www.spinics.net/lists/xdp-newbies/msg01780.html">https://www.spinics.net/lists/xdp-newbies/msg01780.html</a></p></li>
<li><p>修复补丁：<a class="reference external" href="https://github.com/torvalds/linux/commit/92947844b8beee988c0ce17082b705c2f75f0742">https://github.com/torvalds/linux/commit/92947844b8beee988c0ce17082b705c2f75f0742</a></p></li>
</ul>
<hr class="docutils" />
<p>线上升级的时候是新内核和新驱动一起升级，默认情况下需要重启两次新驱动才生效，第一次新内核生效，第二次新驱动才生效，因为新驱动安装的时候最后 postinstall 脚本里的 <code class="docutils literal notranslate"><span class="pre">depmod</span></code> 执行还是在老内核上，所以第一次重启还是使用的新内核默认自带的老驱动。解决方法是新驱动里添加一个 <code class="docutils literal notranslate"><span class="pre">/etc/depmod.d/</span></code> 配置文件。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat /etc/depmod.d/kmod-i40e.conf
<span class="go">override i40e * weak-updates/i40e</span>
</pre></div>
</div>
<p><a class="reference external" href="https://linux.die.net/man/8/depmod">https://linux.die.net/man/8/depmod</a></p>
<hr class="docutils" />
<p>升级驱动版本注意中间有些版本升级后会出现网卡统计的 RX 一直为 0 的问题，这个在下面这个提交中已经修复：</p>
<p><a class="reference external" href="https://github.com/torvalds/linux/commit/cdec2141c24ef177d929765c5a6f95549c266fb3">https://github.com/torvalds/linux/commit/cdec2141c24ef177d929765c5a6f95549c266fb3</a></p>
<p>虽然这个是 2018 年的提交，但 intel 官方在 2021 年之后提供的驱动版本似乎还是不包含这个补丁内容。需要代码确认下。</p>
</section>
<section id="di-er-tiao-zhi-jie-zhai-chu-vip-fu-wu-qi-kai-qi-le-ip-forward-zao-cheng-de-bao-xun-huan">
<h2>第二跳直接摘除 VIP + 服务器开启了 ip_forward 造成的包循环<a class="headerlink" href="#di-er-tiao-zhi-jie-zhai-chu-vip-fu-wu-qi-kai-qi-le-ip-forward-zao-cheng-de-bao-xun-huan" title="Permalink to this headline">¶</a></h2>
<p>如果第二跳机器上没有绑定 VIP，机器上又开启了 ip_forward，这个时候解包出一个 VIP 的包过来，发现不是本机 IP，会走路由将包转发出去，包又会从负载均衡进来，重新转发，这个过程中包只有 ttl 会减小，会导致包一直在 director -&gt; 第一跳后端 -&gt; 第二跳后端 -&gt; director 这样循环，直到 ttl 为 0 为止。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>tcpdump -i bond0 <span class="s1">&#39;dst &lt;VIP&gt;&#39;</span>  -nnn -v -e
<span class="go">19:26:28.377695 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 49, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">...</span>
<span class="go">19:26:28.380421 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 4, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">19:26:28.380493 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 3, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">19:26:28.380540 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 2, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
<span class="go">19:26:28.380595 24:6e:96:c6:aa:60 &gt; e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 1, id 21256, offset 0, flags [DF], proto TCP (6), length 40)</span>
<span class="go">  112.8.88.102.14979 &gt; 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0</span>
</pre></div>
</div>
<p>教训就是：</p>
<ul class="simple">
<li><p>在对称部署架构下，OSPF VIP 和后端绑定 VIP 需要在逻辑在分开（物理上可能绑定的是一个），有些场景下 OSPF VIP 和后端 VIP 的绑定解绑逻辑不一致，一个需要解，一个不能解，这个需要特殊处理，避免类似上面这样的问题。</p></li>
<li><p>没事别开 ip_forward。</p></li>
</ul>
</section>
<section id="ipv4-vip-fang-wen-zheng-chang-ipv6-fang-wen-yi-chang-ke-neng-de-wen-ti">
<h2>IPv4 VIP 访问正常、IPv6 访问异常可能的问题<a class="headerlink" href="#ipv4-vip-fang-wen-zheng-chang-ipv6-fang-wen-yi-chang-ke-neng-de-wen-ti" title="Permalink to this headline">¶</a></h2>
<p>集群中有一台机器 IPv6 访问异常，IPv4 访问确正常，异常的机器上 IPv6 的 VIP 绑定正常，sit0 网卡也正常，一切看上去都挺正常，这种情况可能是没有初始化 IPv6 导致缺少默认 IPv6 路由，下行的包不知道怎么出去导致的。</p>
</section>
<section id="jiao-huan-ji-he-fu-wu-qi-shang-mtu-bu-yi-zhi-dao-zhi-de-bird-ospf-shi-bai">
<h2>交换机和服务器上 MTU 不一致导致的 bird ospf 失败<a class="headerlink" href="#jiao-huan-ji-he-fu-wu-qi-shang-mtu-bu-yi-zhi-dao-zhi-de-bird-ospf-shi-bai" title="Permalink to this headline">¶</a></h2>
<p>有些交换机 MTU 设置为 9000 且无法修改，但是挂载了 XDP 的网卡的 MTU 无法改到和交换机的一致（ <a class="reference internal" href="210305.html#mtu9000"><span class="std std-ref">mlx5_core MTU(9000) &gt; 3498 is not allowed while XDP enabled</span></a> ），此时 <a class="reference external" href="https://bird.network.cz/">bird</a> 会报下面的错误。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>tail /tmp/bird.log
<span class="go">2022-12-03 20:30:51.893 &lt;RMT&gt; ospfv2: MTU mismatch with nbr 61.184.215.126 on bond0 (remote 9000, local 1500)</span>
<span class="go">...</span>
</pre></div>
</div>
<p>这个是 bird v2.0.7 版本开始加上的一个验证，之前只是一个 warning。</p>
<p><a class="reference external" href="https://github.com/CZ-NIC/bird/commit/267da8138d7f429941f2d829b44cf9bdd94a14d6">https://github.com/CZ-NIC/bird/commit/267da8138d7f429941f2d829b44cf9bdd94a14d6</a></p>
<p>可以加个选项支持将这个验证关闭。</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff -ru a/proto/ospf/config.Y b/proto/ospf/config.Y</span>
<span class="gd">--- a/proto/ospf/config.Y       2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/config.Y       2022-12-05 16:36:46.334051267 +0800</span>
<span class="gu">@@ -191,7 +191,7 @@</span>
 CF_DECLS

 CF_KEYWORDS(OSPF, V2, V3, OSPF_METRIC1, OSPF_METRIC2, OSPF_TAG, OSPF_ROUTER_ID)
<span class="gd">-CF_KEYWORDS(AREA, NEIGHBORS, RFC1583COMPAT, STUB, TICK, COST, COST2, RETRANSMIT)</span>
<span class="gi">+CF_KEYWORDS(AREA, NEIGHBORS, RFC1583COMPAT, STUB, TICK, COST, COST2, RETRANSMIT, IGNOREMTU)</span>
 CF_KEYWORDS(HELLO, TRANSMIT, PRIORITY, DEAD, TYPE, BROADCAST, BCAST, DEFAULT)
 CF_KEYWORDS(NONBROADCAST, NBMA, POINTOPOINT, PTP, POINTOMULTIPOINT, PTMP)
 CF_KEYWORDS(NONE, SIMPLE, AUTHENTICATION, STRICT, CRYPTOGRAPHIC, TTL, SECURITY)
<span class="gu">@@ -258,6 +258,7 @@</span>
        proto_item
  | ospf_channel { this_proto-&gt;net_type = $1-&gt;net_type; }
  | RFC1583COMPAT bool { OSPF_CFG-&gt;rfc1583 = $2; }
<span class="gi">+ | IGNOREMTU bool { OSPF_CFG-&gt;ignoremtu = $2; }</span>
  | RFC5838 bool { OSPF_CFG-&gt;af_ext = $2; if (!ospf_cfg_is_v3()) cf_error(&quot;RFC5838 option requires OSPFv3&quot;); }
  | VPN PE bool { OSPF_CFG-&gt;vpn_pe = $3; }
  | STUB ROUTER bool { OSPF_CFG-&gt;stub_router = $3; }
<span class="gh">diff -ru a/proto/ospf/dbdes.c b/proto/ospf/dbdes.c</span>
<span class="gd">--- a/proto/ospf/dbdes.c        2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/dbdes.c        2022-12-05 16:54:41.919077802 +0800</span>
<span class="gu">@@ -360,9 +360,11 @@</span>
           (rcv_iface_mtu != ifa-&gt;iface-&gt;mtu) &amp;&amp;
           (rcv_iface_mtu != 0) &amp;&amp; (ifa-&gt;iface-&gt;mtu != 0))
   {
<span class="gd">-    LOG_PKT(&quot;MTU mismatch with nbr %R on %s (remote %d, local %d)&quot;,</span>
<span class="gd">-           n-&gt;rid, ifa-&gt;ifname, rcv_iface_mtu, ifa-&gt;iface-&gt;mtu);</span>
<span class="gd">-    return;</span>
<span class="gi">+    LOG_PKT(&quot;MTU mismatch with nbr %R on %s (remote %d, local %d) %d&quot;,</span>
<span class="gi">+           n-&gt;rid, ifa-&gt;ifname, rcv_iface_mtu, ifa-&gt;iface-&gt;mtu, p-&gt;ignoremtu);</span>
<span class="gi">+    if (!p-&gt;ignoremtu) {</span>
<span class="gi">+       return;</span>
<span class="gi">+    }</span>
   }

   switch (n-&gt;state)
<span class="gh">diff -ru a/proto/ospf/ospf.c b/proto/ospf/ospf.c</span>
<span class="gd">--- a/proto/ospf/ospf.c 2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/ospf.c 2022-12-05 16:57:16.415081613 +0800</span>
<span class="gu">@@ -287,6 +287,7 @@</span>
   p-&gt;af_ext = c-&gt;af_ext;
   p-&gt;af_mc = c-&gt;af_mc;
   p-&gt;rfc1583 = c-&gt;rfc1583;
<span class="gi">+  p-&gt;ignoremtu = c-&gt;ignoremtu;</span>
   p-&gt;stub_router = c-&gt;stub_router;
   p-&gt;merge_external = c-&gt;merge_external;
   p-&gt;instance_id = c-&gt;instance_id;
<span class="gu">@@ -708,6 +709,9 @@</span>
   if (p-&gt;rfc1583 != new-&gt;rfc1583)
         return 0;

<span class="gi">+  if (p-&gt;ignoremtu != new-&gt;ignoremtu)</span>
<span class="gi">+    return 0;</span>
<span class="gi">+</span>
   if (p-&gt;instance_id != new-&gt;instance_id)
         return 0;

<span class="gu">@@ -832,6 +836,7 @@</span>

   cli_msg(-1014, &quot;%s:&quot;, p-&gt;p.name);
   cli_msg(-1014, &quot;RFC1583 compatibility: %s&quot;, (p-&gt;rfc1583 ? &quot;enabled&quot; : &quot;disabled&quot;));
<span class="gi">+  cli_msg(-1014, &quot;Ignore MTU: %s&quot;, (p-&gt;ignoremtu? &quot;enabled&quot; : &quot;disabled&quot;));</span>
   cli_msg(-1014, &quot;Stub router: %s&quot;, (p-&gt;stub_router ? &quot;Yes&quot; : &quot;No&quot;));
   cli_msg(-1014, &quot;RT scheduler tick: %d&quot;, p-&gt;tick);
   cli_msg(-1014, &quot;Number of areas: %u&quot;, p-&gt;areano);
<span class="gh">diff -ru a/proto/ospf/ospf.h b/proto/ospf/ospf.h</span>
<span class="gd">--- a/proto/ospf/ospf.h 2019-10-16 18:45:08.000000000 +0800</span>
<span class="gi">+++ b/proto/ospf/ospf.h 2022-12-05 15:19:47.161937314 +0800</span>
<span class="gu">@@ -94,6 +94,7 @@</span>
   u8 af_ext;
   u8 af_mc;
   u8 rfc1583;
<span class="gi">+  u8 ignoremtu;</span>
   u8 stub_router;
   u8 merge_external;
   u8 instance_id;
<span class="gu">@@ -232,6 +233,7 @@</span>
   u8 af_ext;                   /* OSPFv3-AF extension */
   u8 af_mc;                    /* OSPFv3-AF multicast */
   u8 rfc1583;                  /* RFC1583 compatibility */
<span class="gi">+  u8 ignoremtu;</span>
   u8 stub_router;              /* Do not forward transit traffic */
   u8 merge_external;           /* Should i merge external routes? */
   u8 instance_id;              /* Differentiate between more OSPF instances */
</pre></div>
</div>
</section>
<section id="tcpdump-neng-kan-dao-vlan-header-dan-shi-xdp-kan-bu-dao">
<h2>tcpdump 能看到 vlan header，但是 xdp 看不到<a class="headerlink" href="#tcpdump-neng-kan-dao-vlan-header-dan-shi-xdp-kan-bu-dao" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Since XDP needs to see the VLAN headers as part of the packet headers, it is important to turn off VLAN hardware offload (which most hardware NICs support), since that will remove the VLAN tag from the packet header and instead communicate it out of band to the kernel via the packet hardware descriptor.</p>
<p><a class="reference external" href="https://github.com/xdp-project/xdp-tutorial/tree/master/packet01-parsing">https://github.com/xdp-project/xdp-tutorial/tree/master/packet01-parsing</a></p>
</div></blockquote>
<p>一般网卡都有 vlan 解析/插入的硬件加速：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -k eth0<span class="p">|</span>grep vlan-offload
<span class="go">rx-vlan-offload: on</span>
<span class="go">tx-vlan-offload: on [fixed]</span>
</pre></div>
</div>
<p>网卡会直接硬件解析 vlan header，然后将 vlan id 等信息直接给驱动，DMA 给驱动的网络包会删除掉 vlan header 变成一个普通的网络包。这样 XDP 就看不到 vlan header 了。解决的方法是关闭这个硬件加速：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -K eth0 rxvlan off
</pre></div>
</div>
<p>或者通过配置将 vlan 信息给到 XDP 程序。</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">#220330 问题</a><ul>
<li><a class="reference internal" href="#ixgbe-detected-tx-unit-hang">ixgbe Detected Tx Unit Hang</a></li>
<li><a class="reference internal" href="#i40e-x722-unable-to-handle-kernel-null-pointer-dereference">i40e/X722 unable to handle kernel NULL pointer dereference</a></li>
<li><a class="reference internal" href="#di-er-tiao-zhi-jie-zhai-chu-vip-fu-wu-qi-kai-qi-le-ip-forward-zao-cheng-de-bao-xun-huan">第二跳直接摘除 VIP + 服务器开启了 ip_forward 造成的包循环</a></li>
<li><a class="reference internal" href="#ipv4-vip-fang-wen-zheng-chang-ipv6-fang-wen-yi-chang-ke-neng-de-wen-ti">IPv4 VIP 访问正常、IPv6 访问异常可能的问题</a></li>
<li><a class="reference internal" href="#jiao-huan-ji-he-fu-wu-qi-shang-mtu-bu-yi-zhi-dao-zhi-de-bird-ospf-shi-bai">交换机和服务器上 MTU 不一致导致的 bird ospf 失败</a></li>
<li><a class="reference internal" href="#tcpdump-neng-kan-dao-vlan-header-dan-shi-xdp-kan-bu-dao">tcpdump 能看到 vlan header，但是 xdp 看不到</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/l4lb/220330.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="https://cn.bing.com/search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>
$('#searchbox').show(0);
document.getElementsByClassName('search')[0].addEventListener('submit', function(event) {
  event.preventDefault();
  var form = event.target;
  var input = form.querySelector('input[name="q"]');
  var value = input.value;
  var q = 'ensearch=1&q=site%3Achanfung032.github.io++' + value;
  var url = form.action + '?' + q;
  window.location.href = url;
});
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, chanfung032.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/l4lb/220330.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>