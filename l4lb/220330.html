
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>#220330 问题 &#8212; Feng&#39;s blog 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/custom.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="#220321 FB: From XDP to Socket" href="220321.html" />
    <link rel="prev" title="#220721 探活、TIME_WAIT 以及 SO_LINGER" href="220721.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="wen-ti">
<h1>#220330 问题<a class="headerlink" href="#wen-ti" title="Permalink to this headline">¶</a></h1>
<section id="ixgbe-detected-tx-unit-hang">
<h2>ixgbe Detected Tx Unit Hang<a class="headerlink" href="#ixgbe-detected-tx-unit-hang" title="Permalink to this headline">¶</a></h2>
<p>现象是网卡不断重启，查看 <code class="docutils literal notranslate"><span class="pre">/var/log/message</span></code> 可以看到以下错误信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span> <span class="n">ixgbe</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">p4p1</span><span class="p">:</span> <span class="n">Detected</span> <span class="n">Tx</span> <span class="n">Unit</span> <span class="n">Hang</span> <span class="p">(</span><span class="n">XDP</span><span class="p">)</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">Tx</span> <span class="n">Queue</span>             <span class="o">&lt;</span><span class="mi">24</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">TDH</span><span class="p">,</span> <span class="n">TDT</span>             <span class="o">&lt;</span><span class="mi">84</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">136</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">next_to_use</span>          <span class="o">&lt;</span><span class="mi">136</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">next_to_clean</span>        <span class="o">&lt;</span><span class="mi">84</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span> <span class="n">tx_buffer_info</span><span class="p">[</span><span class="n">next_to_clean</span><span class="p">]</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">time_stamp</span>           <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797868</span><span class="p">]</span>   <span class="n">jiffies</span>              <span class="o">&lt;</span><span class="mi">128</span><span class="n">edcdc0</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="n">Mar</span> <span class="mi">25</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span> <span class="p">[</span><span class="mf">686973.797955</span><span class="p">]</span> <span class="n">ixgbe</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">p4p1</span><span class="p">:</span> <span class="n">tx</span> <span class="n">hang</span> <span class="mi">1</span> <span class="n">detected</span> <span class="n">on</span> <span class="n">queue</span> <span class="mi">25</span><span class="p">,</span> <span class="n">resetting</span> <span class="n">adapter</span>
<span class="o">...</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">53</span> <span class="n">kernel</span><span class="p">:</span> <span class="p">[</span><span class="mf">687078.764725</span><span class="p">]</span> <span class="n">bond0</span><span class="p">:</span> <span class="n">link</span> <span class="n">status</span> <span class="n">down</span> <span class="k">for</span> <span class="n">interface</span> <span class="n">p4p2</span><span class="p">,</span> <span class="n">disabling</span> <span class="n">it</span> <span class="ow">in</span> <span class="mi">200</span> <span class="n">ms</span>
</pre></div>
</div>
<p>这个问题是 ixgbe 驱动 xdp 实现 BUG 导致，出现在 cpu 比较多的机器。</p>
<blockquote>
<div><p>When the received core is such that the xdp queue falls beyond
MAX_TX_QUEUES(64), then the hang results. In other words, if I leave
<cite>ethtool -L eno1 combined 40</cite> (the default), and a packet is received on
core 24 or greater, it hangs. However, if I lower the tx queue count to
24 (since XDP is forced to nr_cpu_ids), or if I force the incoming
packets onto core &lt; 24 with an ntuple filter, then no hang occurs.</p>
</div></blockquote>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -l p4p1
<span class="go">Channel parameters for p4p1:</span>
<span class="go">Pre-set maximums:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              1</span>
<span class="go">Combined:   63</span>
<span class="go">Current hardware settings:</span>
<span class="go">RX:         0</span>
<span class="go">TX:         0</span>
<span class="go">Other:              1</span>
<span class="go">Combined:   28</span>
<span class="gp"># </span>nproc
<span class="go">56</span>
<span class="gp"># </span>uname -r
<span class="go">4.19.113-88.4bs.el7.centos.x86_64</span>
</pre></div>
</div>
<p>当 <code class="docutils literal notranslate"><span class="pre">combined</span> <span class="pre">+</span> <span class="pre">xdp</span> <span class="pre">queues(nr_cpu_ids)</span> <span class="pre">&gt;</span> <span class="pre">max_tx_queues(64)</span></code> 就会出现这个问题。</p>
<p>详细问题讨论在这两个 thread 中：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.spinics.net/lists/netdev/msg439438.html">https://www.spinics.net/lists/netdev/msg439438.html</a></p></li>
<li><p><a class="reference external" href="https://www.spinics.net/lists/netdev/msg519914.html">https://www.spinics.net/lists/netdev/msg519914.html</a></p></li>
</ul>
<p>不升级内核的情况下，可以通过 <code class="docutils literal notranslate"><span class="pre">ethtool</span> <span class="pre">-L</span> <span class="pre">p4p1</span> <span class="pre">combined</span> <span class="pre">N</span></code> 命令调低 combined 的个数，绕过这个 BUG，但是会影响性能。</p>
<p>BUG 在 4.20-rc1 已经修复。参见：<a class="reference external" href="https://github.com/torvalds/linux/commit/8d7179b1e2d64b3493c0114916486fe92e6109a9">https://github.com/torvalds/linux/commit/8d7179b1e2d64b3493c0114916486fe92e6109a9</a></p>
<p>另一个解决问题的方法是设定 XDP 加载模式为 skb 模式，同样会影响性能，但是不需要升级内核。</p>
</section>
<section id="i40e-x722-unable-to-handle-kernel-null-pointer-dereference">
<h2>i40e/X722 unable to handle kernel NULL pointer dereference<a class="headerlink" href="#i40e-x722-unable-to-handle-kernel-null-pointer-dereference" title="Permalink to this headline">¶</a></h2>
<p>i40e 驱动，网卡是 X722 型号的，在加载 xdp 的时候会报这个错误。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>ethtool -i enp61s0f0
<span class="go">driver: i40e</span>
<span class="go">version: 2.3.2-k</span>
<span class="go">...</span>
<span class="gp"># </span>lshw -class network -short
<span class="go">H/W path         Device      Class          Description</span>
<span class="go">=======================================================</span>
<span class="go">/0/0/0/3/0       enp61s0f0   network        Ethernet Connection X722 for 10GbE SFP+</span>
<span class="go">/0/0/0/3/0.1     enp61s0f1   network        Ethernet Connection X722 for 10GbE SFP+</span>
<span class="go">/3               bond0       network        Ethernet interface</span>
</pre></div>
</div>
<p>错误信息如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:3d:00.0: setup of MAIN VSI failed
i40e 0000:3d:00.0: can&#39;t remove VEB 160 with 0 VSIs left
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
Oops: 0000 [#1] SMP NOPTI
CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:3d:00.0: setup of MAIN VSI failed
i40e 0000:3d:00.0: can&#39;t remove VEB 160 with 0 VSIs left
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
Oops: 0000 [#1] SMP NOPTI
Oops: 0000 [#1] SMP NOPTI
CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
Code: 87 ab d0 0c 00 00 84 c0 75 60 31 c0 66 83 bb f6 0c 00 00 00 74 27 48 8b 93 90 0c 00 00 48 63 f0 48 8b 8b d0 0c 00 00 83 c0 01 &lt;48&gt; 8b 14 f2 48 89 4a 20 0f b7 93 f6 0c 00 00 39 d0 7c d9 48 85 ed
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
RSP: 0018:ffff9d00ea6af8c0 EFLAGS: 00010202
RAX: 0000000000000001 RBX: ffff88f5f75fc000 RCX: ffff9d00c01ef000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff88f5ffcd68f0
RBP: 0000000000000000 R08: 0000000000000070 R09: 0000000000027e7c
R10: ffff89063ff468c0 R11: 0000000000000707 R12: ffff88f5f7600000
R13: ffffffffc0308aa0 R14: ffffffffc032c5a0 R15: 000000000000000f
FS:  00007f25f9ffb700(0000) GS:ffff88f5ffcc0000(0000) knlGS:0000000000000000
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000001fb3828004 CR4: 00000000007606e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
 dev_xdp_install+0x4f/0x70
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 dev_change_xdp_fd+0x103/0x210
 ? dev_disable_lro+0xa0/0xa0
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 do_setlink+0xd63/0xd90
 ? cpumask_next+0x16/0x20
 ? do_kernel_range_flush+0x50/0x50
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? nla_parse+0xa4/0x120
 rtnl_setlink+0xd7/0x140
 ? security_capset+0x50/0x70
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 rtnetlink_rcv_msg+0x28f/0x350
 ? _cond_resched+0x15/0x30
 ? __kmalloc_node_track_caller+0x188/0x280
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? rtnl_calcit.isra.27+0x110/0x110
 netlink_rcv_skb+0xd4/0x110
 netlink_unicast+0x182/0x230
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 netlink_sendmsg+0x2ed/0x3e0
 sock_sendmsg+0x36/0x50
 __sys_sendto+0xdc/0x160
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 ? sock_setsockopt+0x3b9/0xc80
 ? syscall_trace_enter+0x1c9/0x2c0
 ? __audit_syscall_exit+0x213/0x350
 __x64_sys_sendto+0x24/0x30
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
 do_syscall_64+0x5b/0x1a0
 entry_SYSCALL_64_after_hwframe+0x44/0xa9
RIP: 0033:0x4aeeea
bond0: link status down for interface enp61s0f0, disabling it in 200 ms
Code: e8 5b 9c fb ff 48 8b 7c 24 10 48 8b 74 24 18 48 8b 54 24 20 4c 8b 54 24 28 4c 8b 44 24 30 4c 8b 4c 24 38 48 8b 44 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 76 20 48 c7 44 24 40 ff ff ff ff 48 c7 44 24 4

RSP: 002b:000000c0003d8f98 EFLAGS: 00000216 ORIG_RAX: 000000000000002c
</pre></div>
</div>
<p>这个是驱动 BUG，升级驱动可解决。</p>
<ul class="simple">
<li><p>驱动下载：<a class="reference external" href="https://www.intel.com/content/www/us/en/download/18026/intel-network-adapter-driver-for-pcie-40-gigabit-ethernet-network-connections-under-linux.html">https://www.intel.com/content/www/us/en/download/18026/intel-network-adapter-driver-for-pcie-40-gigabit-ethernet-network-connections-under-linux.html</a></p></li>
<li><p>邮件列表同样问题讨论：<a class="reference external" href="https://www.spinics.net/lists/xdp-newbies/msg01780.html">https://www.spinics.net/lists/xdp-newbies/msg01780.html</a></p></li>
<li><p>修复补丁：<a class="reference external" href="https://github.com/torvalds/linux/commit/92947844b8beee988c0ce17082b705c2f75f0742">https://github.com/torvalds/linux/commit/92947844b8beee988c0ce17082b705c2f75f0742</a></p></li>
</ul>
<hr class="docutils" />
<p>线上升级的时候是新内核和新驱动一起升级，默认情况下需要重启两次新驱动才生效，第一次新内核生效，第二次新驱动才生效，因为新驱动安装的时候最后 postinstall 脚本里的 <code class="docutils literal notranslate"><span class="pre">depmod</span></code> 执行还是在老内核上，所以第一次重启还是使用的新内核默认自带的老驱动。解决方法是新驱动里添加一个 <code class="docutils literal notranslate"><span class="pre">/etc/depmod.d/</span></code> 配置文件。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat /etc/depmod.d/kmod-i40e.conf
<span class="go">override i40e * weak-updates/i40e</span>
</pre></div>
</div>
<p><a class="reference external" href="https://linux.die.net/man/8/depmod">https://linux.die.net/man/8/depmod</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">#220330 问题</a><ul>
<li><a class="reference internal" href="#ixgbe-detected-tx-unit-hang">ixgbe Detected Tx Unit Hang</a></li>
<li><a class="reference internal" href="#i40e-x722-unable-to-handle-kernel-null-pointer-dereference">i40e/X722 unable to handle kernel NULL pointer dereference</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/l4lb/220330.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, chanfung032.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/l4lb/220330.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>