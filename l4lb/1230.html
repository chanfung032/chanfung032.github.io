
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>#1230 è°ƒè¯• &#8212; Feng&#39;s blog 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/custom.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="#1225 åŸºäºé™æ€ç­–ç•¥çš„è½¬å‘è¡¨ç”Ÿæˆå’Œæ›´æ–°æ–¹æ³•" href="1225.html" />
    <link rel="prev" title="#0108 xdp è¿›é˜¶" href="210108.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="tiao-shi">
<h1>#1230 è°ƒè¯•<a class="headerlink" href="#tiao-shi" title="Permalink to this headline">Â¶</a></h1>
<section id="ru-he-tiao-shi-wen-ti">
<h2>å¦‚ä½•è°ƒè¯•é—®é¢˜<a class="headerlink" href="#ru-he-tiao-shi-wen-ti" title="Permalink to this headline">Â¶</a></h2>
<p>xdp/bpf ç¨‹åºä¸æ”¯æŒ gdb ä¹‹ç±»çš„å·¥å…·ï¼Œæ‰€ä»¥è°ƒè¯•åªèƒ½è¯‰è¯¸äº tcpdump + æ—¥å¿—ã€‚è½¬å‘è¿‡ç¨‹ä¸­ç½‘ç»œåŒ…ä¾æ¬¡ç»è¿‡äº† <code class="docutils literal notranslate"><span class="pre">t22</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">t33</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">t33</span> <span class="pre">é‡Œçš„</span> <span class="pre">eth0</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">t33</span> <span class="pre">é‡Œçš„</span> <span class="pre">lo</span></code> è¿™äº›ç½‘å£ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥ä»å‰åˆ°å tcpdump è¿™äº›æ¥å£å¹¶éªŒè¯æ•°æ®æ˜¯å¦å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€è‡´ï¼Œä¸ä¸€è‡´è§£å†³é—®é¢˜ï¼Œä¸€ç‚¹ä¸€ç‚¹å¾€å‰æ¨è¿›ã€‚</p>
<p>å¸¸ç”¨ tcpdump å‘½ä»¤ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># -nã€-nn ä¸è½¬æ¢åœ°å€ä¸ºä¸»æœºåã€ä¸ç¿»è¯‘ç«¯å£ä¸ºåè®®å</span>
<span class="c1"># -vvv Even more verbose output</span>
<span class="c1"># -x æ‰“å°å‡ºåŸå§‹ IP åŒ…</span>
tcpdump -n -nn -vvv -x -i &lt;iface&gt;
<span class="c1"># -xx æ‰“å°å‡ºåŒ…æ‹¬ ethernet header çš„æ•´ä¸ªç½‘ç»œåŒ…</span>
tcpdump -n -nn -vvv -xx -i &lt;iface&gt;
</pre></div>
</div>
</section>
<section id="veth-xdp">
<h2>veth &amp; xdp<a class="headerlink" href="#veth-xdp" title="Permalink to this headline">Â¶</a></h2>
<p>å¦‚æœåœ¨ t22 ç½‘å£ä¸Š tcpdump åªæœ‰è¿›çš„åŒ…ï¼Œæ²¡æœ‰è½¬å‘å‡ºæ¥çš„åŒ…ï¼Œå¯èƒ½çš„åŸå› æœ‰ä¸¤ä¸ªï¼š</p>
<p>ç¬¬ä¸€ä¸ªï¼Œt22 ç½‘å£ä¸Šæ²¡æœ‰åŠ è½½ xdp ç¨‹åºã€‚</p>
<blockquote>
<div><p>Note that in order to the transmit and/or redirect functionality to work, all involved devices should have an attached XDP program, including both veth peers. We have to do this because veth devices wonâ€™t deliver redirected/retransmitted XDP frames unless there is an XDP program attached to the receiving side of the target veth interface. Physical hardware will likely behave the same. XDP maintainers are currently working on fixing this behaviour upstream. See the <a class="reference external" href="https://www.netdevconf.org/0x13/session.html?talk-veth-xdp">Veth XDP: XDP for containers</a>  talk which describes the reasons behind this problem. (The xdpgeneric mode may be used without this limitation.)</p>
<p><a class="reference external" href="https://github.com/xdp-project/xdp-tutorial/tree/master/packet03-redirecting#sending-packets-back-to-the-interface-they-came-from">https://github.com/xdp-project/xdp-tutorial/tree/master/packet03-redirecting#sending-packets-back-to-the-interface-they-came-from</a></p>
</div></blockquote>
<p>è¿™ä¸ªé—®é¢˜è§£å†³çš„æ–¹æ³•å°±æ˜¯åœ¨æ‰€æœ‰æåˆ°çš„ç½‘å£ä¸Šéƒ½æŒ‚è½½ä¸€ä¸ªç©º xdp ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºåªå¹²ä¸€ä»¶äº‹ï¼Œå°±æ˜¯è¿”å› XDP_PASSã€‚</p>
<p>å¦å¤–ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯ 22 ns é‡ŒæŒ‚è½½çš„ xdp director ç¨‹åºæ ¹æœ¬æ²¡æœ‰è¿”å› XDP_TXï¼Œæ¯”å¦‚ xdp ç¨‹åºä¸­çš„é”™è¯¯å¤„ç†å¯èƒ½ä¼šè¿”å› XDP_DROPï¼Œå¯¼è‡´åŒ…è¢«ç›´æ¥ dropã€‚è¿™ä¸ªä¸€èˆ¬é€šè¿‡åŠ æ—¥å¿—å°±èƒ½æ‰¾åˆ°é—®é¢˜ã€‚è¯´è¿™ä¸ªå½“ç„¶æ˜¯æ‰åœ¨è¿™ä¸ªå‘é‡Œè¿‡ï¼Œå¼€å‘å°åŒ…ç¨‹åºè°ƒç”¨ bpf_xdp_adjust_head ç”³è¯·ç©ºé—´çš„æ—¶å€™ï¼Œdelta å‚æ•°ä¼ æˆäº†æ­£çš„ï¼ˆä¸ºè´Ÿæ‰æ˜¯å¢åŠ ç©ºé—´ï¼‰ï¼Œå¯¼è‡´ç©ºé—´åè€Œç¼©å°äº†ï¼Œåç»­å†™ GUE header å‰åš bounds checking çš„æ—¶å€™å‘ç°ç©ºé—´ä¸å¤Ÿï¼ˆè¦å†™çš„åœ°æ–¹åœ¨ data_end ä¹‹åäº†ï¼‰ï¼Œè¿”å› XDP_DROPï¼Œå¯¼è‡´åŒ…è¢« drop äº† ğŸ¤¦â€â™‚ï¸ã€‚</p>
</section>
<section id="ke-yi-ping-tong-dan-shi-curl-bao-no-route-to-host">
<h2>å¯ä»¥ ping é€šä½†æ˜¯ curl æŠ¥ No route to host<a class="headerlink" href="#ke-yi-ping-tong-dan-shi-curl-bao-no-route-to-host" title="Permalink to this headline">Â¶</a></h2>
<p>åœ¨ 22 ns é‡Œç›´æ¥ curl 33ï¼ŒæŠ¥ No route to hostã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ip netns <span class="nb">exec</span> t22 curl <span class="m">172</span>.17.3.3
<span class="go">curl: (7) Failed to connect to 172.17.3.3 port 80: No route to host</span>
</pre></div>
</div>
<p>tcpdump t22 ç½‘å£ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">172.17.2.2.49138</span> <span class="o">&gt;</span> <span class="mf">172.17.3.3.80</span><span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> <span class="mh">0x5d56</span> <span class="p">(</span><span class="n">incorrect</span> <span class="o">-&gt;</span> <span class="mh">0x26e6</span><span class="p">),</span> <span class="n">seq</span> <span class="mi">1545991743</span><span class="p">,</span> <span class="n">win</span> <span class="mi">64240</span><span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> <span class="mi">1460</span><span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> <span class="mi">2712278192</span> <span class="n">ecr</span> <span class="mi">0</span><span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> <span class="mi">6</span><span class="p">],</span> <span class="n">length</span> <span class="mi">0</span>
<span class="mi">08</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mf">59.957166</span> <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">ttl</span> <span class="mi">64</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">54935</span><span class="p">,</span> <span class="n">offset</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">ICMP</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">length</span> <span class="mi">88</span><span class="p">)</span>
<span class="mf">172.17.2.1</span> <span class="o">&gt;</span> <span class="mf">172.17.2.2</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">host</span> <span class="mf">172.17.3.3</span> <span class="n">unreachable</span> <span class="o">-</span> <span class="n">admin</span> <span class="n">prohibited</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">length</span> <span class="mi">68</span>
</pre></div>
</div>
<p>è¿™ä¸ª <code class="docutils literal notranslate"><span class="pre">unreachable</span> <span class="pre">-</span> <span class="pre">admin</span> <span class="pre">prohibited</span> <span class="pre">filter</span></code> è·Ÿ firewalld æœ‰å…³ç³»ï¼Œç›´æ¥å…³é—­ firewalld å°± okã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl disable --now firewalld
</pre></div>
</div>
<p><a class="reference external" href="https://unix.stackexchange.com/questions/552857/why-are-my-network-connections-being-rejected">https://unix.stackexchange.com/questions/552857/why-are-my-network-connections-being-rejected</a></p>
</section>
<section id="bytes-missing">
<h2>14 bytes missing!<a class="headerlink" href="#bytes-missing" title="Permalink to this headline">Â¶</a></h2>
<p>å‰é¢ä¸€åˆ‡é¡ºåˆ©ï¼Œåˆ° 33 ns åè§£åŒ…å¹¶ redirect ç»™ lo åï¼Œtcpdump lo æŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>08:18:20.780688 IP truncated-ip - 14 bytes missing! (tos 0x0, ttl 64, id 30246, offset 0, flags [DF], proto TCP (6), length 60)
    172.17.2.1.36312 &gt; 172.17.2.2.80: Flags [S], seq 481216774, win 64240, options [mss 1460,sackOK,[|tcp]&gt;
    0x0000:  4500 003c 7626 4000 4006 6870 ac11 0201
    0x0010:  ac11 0202 8dd8 0050 1cae c906 0000 0000
    0x0020:  a002 faf0 0d84 0000 0204 05b4 0402
</pre></div>
</div>
<p>è¿™ä¸ªé—®é¢˜æ˜¯å°åŒ…çš„ iphdr ä¸­çš„ tot_len ï¼ˆIP åŒ…çš„æ€»é•¿åº¦ï¼‰ä¸å¯¹å¯¼è‡´çš„ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯å“ªå¤šå‡äº† 14 ä¸ªå­—èŠ‚ã€‚</p>
</section>
<section id="bpf-redirect-dao-qi-ta-wang-kou-yao-xiu-gai-dst-mac-di-zhi">
<h2>bpf_redirect åˆ°å…¶å®ƒç½‘å£è¦ä¿®æ”¹ dst mac åœ°å€<a class="headerlink" href="#bpf-redirect-dao-qi-ta-wang-kou-yao-xiu-gai-dst-mac-di-zhi" title="Permalink to this headline">Â¶</a></h2>
<p>è¿™ä¸ªé—®é¢˜æ˜¯æ‰€æœ‰é—®é¢˜é‡Œæœ€éš¾è§£å†³çš„ä¸€ä¸ªï¼Œå› ä¸ºæ‰€æœ‰çš„æµç¨‹çœ‹ä¸Šå»éƒ½æ­£ç¡®äº†ï¼Œå°åŒ…ã€è½¬å‘ã€è§£åŒ…ã€redirectï¼Œç½‘ç»œåŒ…æˆåŠŸåˆ°è¾¾äº†æˆ‘ä»¬ç»‘å®š 172.17.2.2 çš„ lo ç½‘å£ï¼Œtcpdump å‡ºæ¥çš„ç½‘ç»œåŒ…æ˜¾ç¤ºåŒ…çš„å†…å®¹å’ŒåŸå§‹å†…å®¹ <strong>ä¸€æ¨¡ä¸€æ ·</strong>ï¼Œä½†æ˜¯å†…æ ¸å°†è¿™ä¸ªåŒ…ä¸¢æ‰äº†ï¼ŒWTFï¼</p>
<p>æœ€å¼€å§‹æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸€äº›å·¥å…·æ¥çœ‹çœ‹å†…æ ¸åœ¨å“ªæŠŠåŒ…ä¸¢äº†ï¼ˆåé¢å•ç‹¬å°èŠ‚è¯´æ˜æ–¹æ³•ï¼‰ï¼Œå®šä½åˆ° <a class="reference external" href="https://github.com/torvalds/linux/blob/v5.10/net/ipv4/ip_input.c#L435">ip_rcv_core</a> è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸çŸ¥é“å…·ä½“çš„åŸå› ã€‚</p>
<p>æ²¡åŠæ³•åªå¥½å›å½’æœ€åŸå§‹çš„æ–¹æ³•ï¼Œä½¿ç”¨ scapy ä»æ²¡é—®é¢˜å¼€å§‹æ„é€ ä¸€ä¸ªæœ€å°çš„å¤ç°é—®é¢˜çš„ä»£ç ï¼Œä¸€æ­¥ä¸€æ­¥æ¨ç†ã€‚</p>
<p>é¦–å…ˆï¼Œç›´æ¥åœ¨ 33 ns ä¸­ç›´æ¥ç»™ lo å‘ä¸€ä¸ªåŒ…ï¼Œ ok æ²¡é—®é¢˜ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pkt</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">NS_33_LO_MAC</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">SRC_MAC</span><span class="p">)</span><span class="o">/</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s2">&quot;172.17.2.2&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;172.17.2.1&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">TCP</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">srp1</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s2">&quot;lo&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>ç„¶åï¼Œé€šè¿‡ t33 ç½‘å£å‘é€åŒ…ï¼Œbpf_redirect ç»™ lo åè¢«ä¸¢äº†ï¼Œä½¿ç”¨å†…æ ¸å·¥å…·æ£€æŸ¥ drop çš„ä½ç½®ä¸€æ ·ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pkt</span> <span class="o">=</span> <span class="n">Ether</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">NS_33_ETH0_MAC</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">SRC_MAC</span><span class="p">)</span><span class="o">/</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s2">&quot;172.17.2.2&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;172.17.2.1&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">TCP</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">srp1</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="s2">&quot;t33&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>é‚£ä¹ˆç»è¿‡ eth0 redirect åˆ° lo çš„åŒ…å’Œç›´æ¥å‘ç»™ lo çš„åŒ…æœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Œé¢ã€‚ã€‚ã€‚è¿˜çœŸæœ‰ï¼Œå®ƒä»¬çš„ dst mac åœ°å€ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´çš„ï¼Ÿæˆ‘ä»¬ä¿®æ”¹ä¸Šé¢çš„ç¨‹åºï¼Œä¿®æ”¹ dst mac åœ°å€ä¸ºä¸€ä¸ªä¹±ä¸ƒå…«ç³Ÿçš„åœ°å€ï¼Œç„¶åå’Œæœ€å¼€å§‹ä¸€æ ·ï¼Œåœ¨ 33 ns ä¸­ç»™ lo ç›´æ¥å‘ä¸€ä¸ªåŒ…ï¼Œyesï¼ä¸¢äº†ã€‚é—®é¢˜æ‰¾åˆ°ã€‚</p>
<p>æ‰€ä»¥ä½¿ç”¨ bpf_redirect å°†åŒ… redirect ç»™å…¶å®ƒç½‘å£å‰éœ€è¦å…ˆä¿®æ”¹ dst macã€‚</p>
</section>
<section id="suan-iphdr-de-checksum-shi-xian-jiang-checksum-she-zhi-wei-0">
<h2>ç®— iphdr çš„ checksum æ—¶å…ˆå°† checksum è®¾ç½®ä¸º 0<a class="headerlink" href="#suan-iphdr-de-checksum-shi-xian-jiang-checksum-she-zhi-wei-0" title="Permalink to this headline">Â¶</a></h2>
<p>æœ€åï¼Œcurl åŸºæœ¬å¯ä»¥è¿è¡Œäº†ï¼Œä½†ä¸æ˜¯ 100% æˆåŠŸï¼Œé—´æˆ–æœ‰è¶…æ—¶æˆ–è€… IP åŒ…é‡ä¼ å¯¼è‡´çš„å“åº”æ…¢ï¼Œtcpdump å‘ç°æ­£å¸¸å’Œä¸æ­£å¸¸çš„å”¯ä¸€åŒºåˆ«æ˜¯ä¸æ­£å¸¸çš„æ—¶å€™æœ‰äº›è½¬å‘åŒ…çš„ tcpdump ä¿¡æ¯æ˜¾ç¤º checksum incorrectï¼Œæ£€æŸ¥å‘ç° xdp director å°åŒ…çš„æ—¶å€™è®¡ç®— checksum çš„æ—¶å€™æ²¡æœ‰é¦–å…ˆå°† checksum ç½®é›¶ã€‚ä¿®æ”¹å†è¿è¡Œï¼Œ100% æˆåŠŸã€‚</p>
<p>è‡³æ­¤ï¼Œç¬¬ä¸€ä¸ªå°ç›®æ ‡ï¼Œå®Œæˆã€‚</p>
</section>
<section id="yuan-mu-biao-ip-yi-yang-dao-zhi-de-bao-bei-diu">
<h2>æº/ç›®æ ‡ IP ä¸€æ ·å¯¼è‡´çš„åŒ…è¢«ä¸¢<a class="headerlink" href="#yuan-mu-biao-ip-yi-yang-dao-zhi-de-bao-bei-diu" title="Permalink to this headline">Â¶</a></h2>
<p>å½“è½¬å‘çš„åç«¯å°±æ˜¯æœ¬æœºçš„æ—¶å€™ï¼Œxdp å¯ä»¥ç›´æ¥ accept åŒ…ï¼Œæ­¤æ—¶åŒ…ä¸­çš„æº IP å’Œç›®çš„ IP å°±ä¼šä¸€æ ·ï¼Œè¿™ç§åŒ…ä¼šè¢«å†…æ ¸ä¸¢æ‰ï¼Œè§£å†³æ–¹æ³•æ˜¯ä¿®æ”¹æº IPï¼Œæˆ–è€…ä¿®æ”¹ä¸‹é¢è¿™ä¸ªå†…æ ¸å‚æ•°å…³é—­è¯¥è¡Œä¸ºï¼š</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>sysctl -w net.ipv4.conf.interface.accept_local<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p><a class="reference external" href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt">https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt</a></p>
</section>
<section id="zhao-chu-nei-he-zai-na-diu-bao-de-ji-ge-fang-fa">
<h2>æ‰¾å‡ºå†…æ ¸åœ¨å“ªä¸¢åŒ…çš„å‡ ä¸ªæ–¹æ³•<a class="headerlink" href="#zhao-chu-nei-he-zai-na-diu-bao-de-ji-ge-fang-fa" title="Permalink to this headline">Â¶</a></h2>
<p><a class="reference external" href="https://jvns.ca/blog/2017/09/05/finding-out-where-packets-are-being-dropped/">https://jvns.ca/blog/2017/09/05/finding-out-where-packets-are-being-dropped/</a></p>
<p>ç®€å•æ–¹æ³•ï¼ŒæŸ¥çœ‹å†…æ ¸çš„ä¸€äº›æŒ‡æ ‡æ•°æ®ï¼Œæ£€æŸ¥æµ‹è¯•å‰åæŒ‡æ ‡æ•°æ®çš„å˜åŒ–ï¼ˆerror ç›¸å…³çš„æŒ‡æ ‡ï¼‰ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ¨å¯¼å‡ºé—®é¢˜ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>netstat -i
<span class="go">Kernel Interface table</span>
<span class="go">Iface             MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg</span>
<span class="go">eth0             1500   403544      0      0 0        232905      0      0      0 BMRU</span>
<span class="go">lo              65536      848      0      0 0           848      0      0      0 LRU</span>
<span class="go">t22              1500     1017      0      0 0           856      0      0      0 BMRU</span>
<span class="go">t33              1500      704      0      0 0           829      0      0      0 BMRU</span>
<span class="gp"># </span>ethtool -S eth0
<span class="go">NIC statistics:</span>
<span class="go">    rx_packets: 403612</span>
<span class="go">    tx_packets: 232875</span>
<span class="go">    rx_bytes: 206386735</span>
<span class="go">    tx_bytes: 22216963</span>
<span class="go">    ...</span>
<span class="go">    rx_errors: 0</span>
<span class="go">    tx_errors: 0</span>
<span class="go">    tx_dropped: 0</span>
<span class="go">    ...</span>
<span class="go">    rx_length_errors: 0</span>
<span class="go">    rx_over_errors: 0</span>
<span class="go">    rx_crc_errors: 0</span>
<span class="go">    rx_frame_errors: 0</span>
<span class="go">    rx_no_buffer_count: 0</span>
<span class="go">    rx_missed_errors: 0</span>
<span class="go">    tx_aborted_errors: 0</span>
<span class="go">    tx_carrier_errors: 0</span>
<span class="go">    tx_fifo_errors: 0</span>
<span class="go">    tx_heartbeat_errors: 0</span>
<span class="go">    tx_window_errors: 0</span>
<span class="go">    ...</span>
</pre></div>
</div>
<p>æ–¹æ³•äºŒï¼šä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">perf</span></code> ç›‘æ§ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>perf record -g -a -e skb:kfree_skb
<span class="gp"># </span>perf script -f
<span class="go">ffffffffa195b695 kfree_skb+0x85 ([kernel.kallsyms])</span>
<span class="go">ffffffffa195b695 kfree_skb+0x85 ([kernel.kallsyms])</span>
<span class="go">ffffffffa1a00d10 ip_rcv_core+0x200 ([kernel.kallsyms])</span>
<span class="go">ffffffffa1a013bf ip_rcv+0x1f ([kernel.kallsyms])</span>
<span class="go">ffffffffa1975c77 __netif_receive_skb_one_core+0x67 ([kernel.kallsyms])</span>
<span class="go">...</span>
</pre></div>
</div>
<p>æˆ–è€…ä½¿ç”¨ä¸‹é¢è¿™ä¸ª bpftrace one-linerï¼š</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">bpftrace -e &#39;tracepoint:skb:kfree_skb { printf(&quot;%s\n&quot;, kstack) }&#39;</span>
</pre></div>
</div>
<p>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">dropwatch</span></code> å·¥å…·ï¼Œ<a class="reference external" href="https://github.com/pavel-odintsov/drop_watch">https://github.com/pavel-odintsov/drop_watch</a>ï¼Œä¸è¿‡è¿™ä¸ªé¡¹ç›®ä¼¼ä¹å¾ˆä¹…æ²¡æœ‰ç»´æŠ¤äº†ã€‚</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>yum install -y dropwatch
<span class="gp"># </span>dropwatch -l kas
<span class="go">Initalizing kallsyms db</span>
<span class="go">dropwatch&gt; start</span>
<span class="go">Enabling monitoring...</span>
<span class="go">Kernel monitoring activated.</span>
<span class="go">Issue Ctrl-C to stop monitoring</span>

<span class="go">2 drops at ip_rcv_core+200 (0xffffffffa1a00d10)</span>
</pre></div>
</div>
</section>
<section id="centos-7-an-zhuang-zui-xin-ban-ben-de-bpftool">
<h2>CentOS 7 å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ bpftool<a class="headerlink" href="#centos-7-an-zhuang-zui-xin-ban-ben-de-bpftool" title="Permalink to this headline">Â¶</a></h2>
<p>ä½¿ç”¨ <a class="reference external" href="https://github.com/fbs/el7-bpf-specs">https://github.com/fbs/el7-bpf-specs</a> æä¾›çš„ yum ä»“åº“ä¸­çš„ bpftool ã€‚</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">#1230 è°ƒè¯•</a><ul>
<li><a class="reference internal" href="#ru-he-tiao-shi-wen-ti">å¦‚ä½•è°ƒè¯•é—®é¢˜</a></li>
<li><a class="reference internal" href="#veth-xdp">veth &amp; xdp</a></li>
<li><a class="reference internal" href="#ke-yi-ping-tong-dan-shi-curl-bao-no-route-to-host">å¯ä»¥ ping é€šä½†æ˜¯ curl æŠ¥ No route to host</a></li>
<li><a class="reference internal" href="#bytes-missing">14 bytes missing!</a></li>
<li><a class="reference internal" href="#bpf-redirect-dao-qi-ta-wang-kou-yao-xiu-gai-dst-mac-di-zhi">bpf_redirect åˆ°å…¶å®ƒç½‘å£è¦ä¿®æ”¹ dst mac åœ°å€</a></li>
<li><a class="reference internal" href="#suan-iphdr-de-checksum-shi-xian-jiang-checksum-she-zhi-wei-0">ç®— iphdr çš„ checksum æ—¶å…ˆå°† checksum è®¾ç½®ä¸º 0</a></li>
<li><a class="reference internal" href="#yuan-mu-biao-ip-yi-yang-dao-zhi-de-bao-bei-diu">æº/ç›®æ ‡ IP ä¸€æ ·å¯¼è‡´çš„åŒ…è¢«ä¸¢</a></li>
<li><a class="reference internal" href="#zhao-chu-nei-he-zai-na-diu-bao-de-ji-ge-fang-fa">æ‰¾å‡ºå†…æ ¸åœ¨å“ªä¸¢åŒ…çš„å‡ ä¸ªæ–¹æ³•</a></li>
<li><a class="reference internal" href="#centos-7-an-zhuang-zui-xin-ban-ben-de-bpftool">CentOS 7 å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ bpftool</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/l4lb/1230.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="https://cn.bing.com/search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>
$('#searchbox').show(0);
document.getElementsByClassName('search')[0].addEventListener('submit', function(event) {
  event.preventDefault();
  var form = event.target;
  var input = form.querySelector('input[name="q"]');
  var value = input.value;
  var q = 'ensearch=1&q=site%3Achanfung032.github.io++' + value;
  var url = form.action + '?' + q;
  window.location.href = url;
});
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, chanfung032.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/l4lb/1230.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>