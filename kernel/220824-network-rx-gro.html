
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>#220824 ç½‘ç»œæ ˆæ¥æ”¶æ•°æ® RX â€”â€” GRO &#8212; Feng&#39;s blog 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/custom.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="#220817 ç½‘ç»œæ ˆæ¥æ”¶æ•°æ® RX â€”â€”ä»ç½‘å¡æ”¶åˆ°åŒ…åˆ° net_rx_action" href="220818-network-rx.html" />
    <link rel="prev" title="å†…æ ¸ç¬”è®°" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="wang-luo-zhan-jie-shou-shu-ju-rx-gro">
<h1>#220824 ç½‘ç»œæ ˆæ¥æ”¶æ•°æ® RX â€”â€” GRO<a class="headerlink" href="#wang-luo-zhan-jie-shou-shu-ju-rx-gro" title="Permalink to this headline">Â¶</a></h1>
<section id="indirect-call-hong-de-zuo-yong-shi-shen-me">
<h2>INDIRECT_CALL_* å®çš„ä½œç”¨æ˜¯ä»€ä¹ˆ<a class="headerlink" href="#indirect-call-hong-de-zuo-yong-shi-shen-me" title="Permalink to this headline">Â¶</a></h2>
<p><a class="reference external" href="https://elixir.bootlin.com/linux/latest/source/include/linux/indirect_call_wrapper.h">https://elixir.bootlin.com/linux/latest/source/include/linux/indirect_call_wrapper.h</a></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">INDIRECT_CALL_INET</span><span class="p">(</span><span class="n">ptype</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">gro_complete</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">ipv6_gro_complete</span><span class="p">,</span><span class="w"> </span><span class="n">inet_gro_complete</span><span class="p">,</span><span class="w"> </span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>å®å±•å¼€ä¹‹åå°±æ˜¯ï¼š</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">likely</span><span class="p">(</span><span class="n">ptype</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">gro_complete</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inet_gro_complete</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">  </span><span class="n">inet_gro_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ptype</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">gro_complete</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ipv6_gro_complete</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">    </span><span class="n">ipv6_gro_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">ptype</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">.</span><span class="n">gro_complete</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<p>åŠŸèƒ½å°±æ˜¯çŒœæŸä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°æ˜¯å“ªä¸ªå‡½æ•°ï¼Œå¦‚æœæ˜¯æŸå‡ ä¸ªå·²çŸ¥å‡½æ•°ï¼Œé‚£å°±ç›´æ¥è°ƒç”¨è¿™äº›å‡½æ•°ï¼Œè€Œä¸æ˜¯é€šè¿‡å‡½æ•°æŒ‡é’ˆã€‚å› ä¸º <strong>ç›´æ¥è°ƒç”¨å‡½æ•°æ¯”é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨çš„æ€§èƒ½è¦å¥½</strong> ã€‚è¿™ä¸ªå…·ä½“å¯ä»¥å‚è§ï¼š<a class="reference external" href="https://lwn.net/Articles/774743/">https://lwn.net/Articles/774743/</a>ï¼Œå¤§ä½“è¯´æ¥å°±æ˜¯ï¼š</p>
<div class="line-block">
<div class="line">å› ä¸ºå‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼ˆindirect function callï¼‰æ€§èƒ½ä¸è¡Œï¼Œæ‰€ä»¥ CPU è¿›åŒ–å‡ºäº† indirect branch predictorã€‚</div>
<div class="line">å› ä¸ºæœ‰äº† indirect branch predictorï¼Œæ‰€æœ‰æœ‰äº† <a class="reference external" href="https://en.wikipedia.org/wiki/Spectre_(security_vulnerability)">Spectre</a> ï¼ˆå¹½çµğŸ‘»ï¼‰ è¿™ç±»é’ˆå¯¹å®ƒçš„ä¾§ä¿¡é“æ”»å‡»ï¼Œå‘œå‘œå‘œï¼Œpredictor ä¸èƒ½ç”¨äº†ã€‚</div>
<div class="line">å› ä¸º predictor ä¸èƒ½ç”¨äº†ï¼Œæ‰€ä»¥æœ‰äº† <a class="reference external" href="https://support.google.com/faqs/answer/7625886">retpoline</a> è¿™ä¸ª hackã€‚retpoline è§£å†³äº†é—®é¢˜åˆæ²¡æœ‰å½»åº•è§£å†³ã€‚</div>
<div class="line">indirect function call æ€§èƒ½ä¸è¡Œï¼Œé‚£å°±ç”¨ direct function callï¼Ÿäºæ˜¯å°±æœ‰äº† <code class="docutils literal notranslate"><span class="pre">INDIRECT_CALL_*</span></code> å®ã€‚</div>
</div>
</section>
<section id="cong-napi-gro-receive-dao-netif-receive-skb">
<h2>ä» napi_gro_receive åˆ° netif_receive_skb<a class="headerlink" href="#cong-napi-gro-receive-dao-netif-receive-skb" title="Permalink to this headline">Â¶</a></h2>
<p>GRO å…¨ç§° Generic Receive Offloadï¼Œæ˜¯ Linux ç½‘ç»œæ ˆé‡Œæ”¶åŒ…ä¾§çš„ä¸€ä¸ªè½¯ä»¶ä¼˜åŒ–ï¼ŒåŠŸèƒ½å°±æ˜¯å°†ç½‘å¡æ”¶åˆ°çš„ä¸€å † mtu 1500 çš„å°åŒ…ç»™åˆå¹¶ä¸ºå¤§åŒ…å†äº¤ç»™ä¸Šå±‚åè®®æ ˆå»å¤„ç†ã€‚GRO ä½äº tcpdump ç­‰æŠ“åŒ…å·¥å…·çš„æŒ‚è½½ç‚¹ä¹‹å‰ï¼Œæ‰€ä»¥æŠ“åŒ…å·¥å…·çœ‹åˆ°çš„ GRO ä¹‹åçš„å¤§åŒ…ã€‚</p>
<img alt="../_images/gro.svg" src="../_images/gro.svg" /><p>è°ƒç”¨æ ˆï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>napi_gro_receive(napi, skb)
  |- gro_result = dev_gro_receive(napi, skb)
  |  |- bucket = skb_get_hash_raw(skb)
  |  |- gro_list = &amp;napi-&gt;gro_hash[bucket]
  |  |
  |  |- if netif_elide_gro(skb-&gt;dev)
  |  |    return GRO_NORMAL
  |  |
  |  |- gro_list_prepare(&amp;gro_list-&gt;list, skb)
  |  |
  |  |- pp = ptype-&gt;callbacks.gro_receive/inet_gro_receive
  |  |    |- tcp4_gro_receive
  |  |      |- tcp_gro_receive
  |  |        |- skb_gro_receive
  |  |
  |  |- if pp:
  |  |    |- napi_gro_complete
  |  |      |- ptype-&gt;callbacks.gro_complete/inet_gro_complete
  |  |      | |- tcp4_gro_complete
  |  |      |- gro_normal_one ğŸ‘ˆ
  |  |
  |  |- if NAPI_GRO_CB(skb)-&gt;same_flow
  |  |    return GRO_MERGED_FREE
  |  |
  |  |- list_add(&amp;skb-&gt;list, &amp;gro_list-&gt;list)
  |  |- return GRO_HELD
  |
  |- napi_skb_finish(napi, skb, gro_result)
     |- switch gro_result
     |- case GRO_NORMAL: gro_normal_one(napi, skb, 1) ğŸ‘ˆ
     |- case GRO_MERGED_FREE: __kfree_skb(skb)
     |- default: return
</pre></div>
</div>
<p>ï¼ˆGRO åˆå¹¶åŒ…è¿™ä¸ªå‡½æ•°æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæˆ‘ä»¬åªæ˜¯è¦å¤§è‡´ç†æ¸…å…¶è„‰ç»œï¼Œæ‰€ä»¥ä¸Šé¢çš„è°ƒç”¨æ ˆç»è¿‡äº†ä¸€å®šçš„ç®€åŒ–ï¼‰</p>
<p><code class="docutils literal notranslate"><span class="pre">napi_gro_receive</span></code> çš„è¾“å…¥æ˜¯é©±åŠ¨ä»ç½‘å¡ ring buffer æ”¶è·å¹¶æ„å»ºå‡ºçš„ä¸€ä¸ªä¸ª skb ç»“æ„ä½“ï¼Œè¦åˆå¹¶å°±å¾—ç¼“å­˜ï¼ŒGRO æ¨¡å—ä¼šå°†æ”¶åˆ°çš„ skb ç¼“å­˜åˆ° <code class="docutils literal notranslate"><span class="pre">napi-&gt;gro_hash</span></code> ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤§å°ä¸º 8 çš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åˆåˆ†åˆ«æ˜¯ä¸ª skb åˆ—è¡¨ã€‚</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">napi_struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">//...</span>
<span class="w">  </span><span class="cp">#define GRO_HASH_BUCKETS  8</span>
<span class="w">  </span><span class="k">struct</span> <span class="nc">gro_list</span><span class="w"> </span><span class="n">gro_hash</span><span class="p">[</span><span class="n">GRO_HASH_BUCKETS</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="c1">//...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>ç¼“å­˜å’Œåˆå¹¶å®Œæˆç»§ç»­å¾€ä¸Šå‘é€åŒ…çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ol class="arabic simple">
<li><p>é¦–å…ˆï¼Œè°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">skb_get_hash_raw</span></code> è·å–åŒ…çš„ hashï¼ˆè¿™ä¸ª hash æ˜¯é©±åŠ¨ä» ring buffer æ”¶åŒ…çš„æ—¶å€™ç›´æ¥ä»åŒ…çš„ metadata ä¸­è·å–åˆ°å¹¶è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">skb_set_hash</span></code> è®¾ç½®çš„ï¼Œä¹Ÿå°±æ˜¯ç½‘å¡ç›´æ¥æä¾›äº†çš„ï¼‰ï¼ŒGRO æ¨¡å—å°†ç›¸åŒ hash çš„ skb ç¼“å­˜åˆ°åŒä¸€ä¸ªåˆ—è¡¨ä¸­ã€‚ <code class="docutils literal notranslate"><span class="pre">napi-&gt;gro_hash[bucket]</span></code> è·å–åˆ°ç¼“å­˜ skb åˆ—è¡¨ï¼Œè¿™é‡Œé¢å¯èƒ½æœ‰å’Œæ–°åˆ°æ¥çš„ skb å±äºåŒä¸€ä¸ªæµçš„ skbã€‚</p></li>
<li><p>è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">netif_elide_gro</span></code> æ£€æŸ¥è¦ä¸è¦åš GROï¼Œä¸åšçš„è¯ç›´æ¥è·³è¿‡ GRO å¤„ç†ã€‚è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">napi_skb_finish</span></code>ï¼Œæœ€ç»ˆè°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">gro_normal_one</span></code> å°†åŒ…ç»§ç»­å¾€ä¸Šå±‚ä¼ ã€‚</p></li>
<li><p>å¦‚æœéœ€è¦åš GROï¼Œåˆ™è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">gro_list_prepare</span></code> å¯¹æ¯”æ–°æ¥çš„ skb å’Œ ç¼“å­˜ skb åˆ—è¡¨é‡Œçš„æ¯ä¸€ä¸ª skb çš„ L2 åè®®å¤´ï¼ˆmac headerï¼‰æ˜¯å¦ä¸€è‡´ï¼Œç»™ç¼“å­˜åˆ—è¡¨ä¸­å¯¹æ¯”ä¸€è‡´çš„ skb è®¾ç½® <code class="docutils literal notranslate"><span class="pre">NAPI_GRO_CB(skb)-&gt;same_flow</span> <span class="pre">=</span> <span class="pre">1</span></code> æ ‡ç¤ºå…¶å¯èƒ½å’Œæ–°æ¥çš„ skb æ˜¯ä¸€ä¸ªæµçš„ã€‚</p></li>
<li><p>æ ¹æ®ä¸Šå±‚åè®®é€çº§å¾€ä¸Šè°ƒç”¨ä¸Šé¢åè®®å±‚çš„ <code class="docutils literal notranslate"><span class="pre">gro_receive</span></code> å‡½æ•°ï¼Œæ¯”å¦‚ä¸€ä¸ª TCP åŒ…ä¼šä¾æ¬¡è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">inet_gro_receive</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">tcp_gro_receive</span></code> å‡½æ•°ï¼Œæ¯ä¸€ä¸ªåè®®å±‚ä¸­ä¼šæ ¹æ®è‡ªå·±è¿™ä¸€å±‚çš„ header ç»§ç»­è¿‡æ»¤ç¼“å­˜ skb åˆ—è¡¨ä¸­å¯èƒ½æ˜¯åŒä¸€ä¸ªæµçš„ skbã€‚æœ€ç»ˆå¦‚æœæ‰¾åˆ°åŒä¸€ä¸ªæµçš„ skb ç¼“å­˜ã€‚è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">skb_gro_receive</span></code> åˆå¹¶åŒ…ã€‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gro_receive</span></code> å‡½æ•°æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰åˆå¹¶åçš„ skb éœ€è¦å¾€ä¸Šå±‚é€äº†ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦çº§è”è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">gro_complete</span></code> å‡½æ•°æ›´æ–°æ¯å±‚åè®®å¤´ä¸­çš„ä¸€äº›å­—æ®µï¼ˆæ¯”å¦‚ checksumï¼‰ï¼Œå®Œæˆåï¼Œè°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">gro_normal_one</span></code> å°†åŒ…ç»§ç»­å¾€ä¸Šå±‚ä¼ ã€‚</p></li>
<li><p>åŒ…è¢«åˆå¹¶åå¯¹åº”çš„ skb ä¼šåœ¨ <code class="docutils literal notranslate"><span class="pre">napi_skb_finish</span></code> ä¸­è¢«é‡Šæ”¾æ‰ã€‚</p></li>
<li><p>å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒä¸€ä¸ªæµçš„ skbï¼Œæ–°çš„ skb ä¼šè¢«æ·»åŠ åˆ°ç¼“å­˜ skb åˆ—è¡¨ä¸­ã€‚</p></li>
</ol>
<p>skb åˆå¹¶çš„æ–¹æ³•æ˜¯å°† <strong>æ–° skb çš„çº¿æ€§æ•°æ®å’Œéçº¿æ€§æ•°æ®</strong> åˆå¹¶åˆ° <strong>è€ skb çš„éçº¿æ€§æ•°æ®åŒº</strong> ä¸­ã€‚åˆå¹¶çš„æ—¶å€™ä¼˜å…ˆä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">skb_shared_info-&gt;frags</span></code> æ•°ç»„ï¼ˆæ–° skb çš„çº¿æ€§åŒºå¦‚æœæ˜¯é¡µç›´æ¥æ˜ å°„çš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆå¹¶åˆ°é‡Œé¢ï¼Œè¯¦ç»†è§ï¼š   <a class="reference external" href="https://github.com/torvalds/linux/commit/d7e8883cfcf4851afe74fb380cc62b7fa9cf66ba">net: make GRO aware of skb-&gt;head_frag</a> )ï¼Œæ”¾ä¸ä¸‹ä¹‹åå† fallback ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">skb_shared_info-&gt;frag_list</span></code> ï¼ˆå¯ä»¥å‚è§å‰é¢ skb æ–‡ä¸­ <a class="reference internal" href="220810-skbuff.html#nonlinear-skb"><span class="std std-ref">çº¿æ€§ skb å’Œéçº¿æ€§ skb</span></a> ç¬¬ä¸€ç§å’Œç¬¬äºŒç§ç»“æ„ï¼‰ã€‚æ–° skb çš„å„ç§åè®®å¤´ä¼šè¢« <code class="docutils literal notranslate"><span class="pre">skb_pull</span></code> åˆ°åªå‰©ä¸‹æ•°æ®ã€‚</p>
<p><code class="docutils literal notranslate"><span class="pre">gro_normal_one</span></code> å‡½æ•°ä¹‹åï¼Œskb å°±å‡ºäº† GRO æ¨¡å—ã€‚ ä» <code class="docutils literal notranslate"><span class="pre">netif_receive_skb_list_internal</span></code> å¼€å§‹ skb å°±ç®—è¿›å…¥äº†åè®®æ ˆã€‚</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gro_normal_one</span>
  <span class="o">|-</span> <span class="n">gro_normal_list</span>
    <span class="o">|-</span> <span class="n">netif_receive_skb_list_internal</span>
      <span class="o">|-</span> <span class="n">__netif_receive_skb_list</span>
        <span class="o">|-</span> <span class="n">__netif_receive_skb_list_core</span>
          <span class="o">|-</span> <span class="n">__netif_receive_skb_core</span>
            <span class="o">|-</span> <span class="n">deliver_skb</span>
</pre></div>
</div>
<p>References:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://lwn.net/Articles/358910/">https://lwn.net/Articles/358910/</a></p></li>
<li><p><a class="reference external" href="https://blog.csdn.net/zgy666/article/details/106989856">https://blog.csdn.net/zgy666/article/details/106989856</a></p></li>
<li><p><a class="reference external" href="http://arthurchiao.art/blog/linux-net-stack-implementation-rx-zh/#66-napi_gro_receive">http://arthurchiao.art/blog/linux-net-stack-implementation-rx-zh/#66-napi_gro_receive</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">#220824 ç½‘ç»œæ ˆæ¥æ”¶æ•°æ® RX â€”â€” GRO</a><ul>
<li><a class="reference internal" href="#indirect-call-hong-de-zuo-yong-shi-shen-me">INDIRECT_CALL_* å®çš„ä½œç”¨æ˜¯ä»€ä¹ˆ</a></li>
<li><a class="reference internal" href="#cong-napi-gro-receive-dao-netif-receive-skb">ä» napi_gro_receive åˆ° netif_receive_skb</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/kernel/220824-network-rx-gro.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, chanfung032.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/kernel/220824-network-rx-gro.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>