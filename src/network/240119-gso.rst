#240119 TSO & GSO
=====================

æ¦‚è¿°
-----------

TSO å’Œ GSO æ˜¯å†…æ ¸åè®®æ ˆä¸­çš„ä¸¤ä¸ªä¼˜åŒ–ç­–ç•¥ï¼ŒæŠŠå¤§çš„æ•°æ®åŒ…åˆ†æ®µæˆä¸€ä¸ªä¸€ä¸ªç½‘å¡å¯ä»¥å‘å‡ºå»çš„å°åŒ…è¿™ä¸ªæ“ä½œå»¶è¿Ÿåˆ°åè®®æ ˆçš„åº•å±‚å»åšã€‚

-  TSOï¼ˆTCP Segment Offloadingï¼‰æ˜¯æŠŠ TCP åˆ†æ®µå»¶è¿Ÿåˆ°ç½‘å¡å»æ“ä½œã€‚
-  GSOï¼ˆGeneric Segment
   Offloadingï¼‰æ˜¯æŠŠåˆ†æ®µç»™å»¶è¿Ÿåˆ°ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿå±‚ï¼ˆç½‘å¡é©±åŠ¨ä¹‹å‰ï¼‰å»æ“ä½œã€‚

è¿™ä¸¤ä¸ªä¼˜åŒ–çš„å®ç°ä¾èµ–äºåè®®æ ˆä¸Šä¸‹çš„é€šåŠ›åˆä½œã€‚

TCP/IP å±‚
-------------

TCP å®¢æˆ·ç«¯è¿æ¥å‡½æ•° ``tcp_v4_connect`` ï¼ŒæœåŠ¡ç«¯ä¸‰æ¬¡æ¡æ‰‹æˆåŠŸå›è°ƒå‡½æ•° ``tcp_v4_syn_recv_sock`` ä¸­åˆå§‹åŒ– sk çš„æ—¶å€™ï¼Œä¼šè®¾ç½® GSO ç›¸å…³çš„è®¾ç½®ã€‚

.. code-block:: c

   tcp_v4_connect
   |- sk_setup_caps
      |- if sk_can_gso(sk)
      |    |- sk->sk_route_caps |= NETIF_F_SG | NETIF_F_HW_CSUM;
      |    |- sk->sk_gso_max_size = sk_dst_gso_max_size(sk, dst);
      |    |- max_segs = max_t(u32, READ_ONCE(dst->dev->gso_max_segs), 1)
      |- sk->sk_gso_max_segs = max_segs

åœ¨ ``tcp_write_xmit`` å‘åŒ…å‡½æ•°ä¸­ï¼Œä¼šåˆ¤æ–­æ˜¯å¦æ”¯æŒ GSOï¼Œä¸æ”¯æŒæŒ‰ mss å»åˆ†æ®µï¼Œæ”¯æŒçš„è¯æŒ‰ GSO çš„è§„åˆ™åˆ†æ®µï¼ˆæ¯” mss å¤§å¾ˆå¤šï¼‰ã€‚

.. code-block:: c

   tcp_tsq_write(struct sock *sk)
   |- tcp_write_xmit(sk, tcp_current_mss(sk), ...);
      |- ...
      |- max_segs = tcp_tso_segs(sk, mss_now)
      |  |- tso_segs = tcp_tso_authorize(sk, mss_now, min_tso)
      |  |  |- bytes = min_t(unsigned long, bytes, sk->sk_gso_max_size)
      |  |  |- return max_t(u32, bytes / mss_now, min_tso_segs)
      |  |- return min_t(u32, tso_segs, sk->sk_gso_max_segs);
      |- tso_fragment()

IP å±‚åœ¨ ``__ip_finish_output`` ä¸­åˆ¤æ–­æ˜¯ GSO åˆ†æ®µä¹‹åï¼Œè°ƒç”¨ ``ip_finish_output_gso`` æ¥å¤„ç†åˆ†æ®µï¼Œä¸€èˆ¬å°±ç›´æ¥å¾€ä¸‹ä¼ ï¼Œç‰¹æ®Šæƒ…å†µä¸‹ä¼šåœ¨è¿™é‡Œç›´æ¥åˆ†æ®µåå†è°ƒ ``ip_fragment`` å‡½æ•°å¯¹ IP åŒ…åˆ†ç‰‡ã€‚

å¯¹äº TCP/IP å±‚æ¥è¯´ï¼ŒTSO/GSO çš„å¤„ç†æ˜¯ä¸€æ ·çš„ã€‚åˆ°äº†åº•å±‚é©±åŠ¨ä¹‹å‰æ‰æ ¹æ®ç¡¬ä»¶æ˜¯å¦æ”¯æŒ TSO æ¥å†³å®šæ˜¯è½¯ä»¶åˆ†æ®µè¿˜æ˜¯ç¡¬ä»¶åˆ†æ®µã€‚

ç½‘ç»œè®¾å¤‡å­ç³»ç»Ÿå±‚
-------------------

å¦‚æœç½‘å¡ç¡¬ä»¶ä¸æ”¯æŒ TSOï¼Œä»ä¸Šå±‚ä¸‹æ¥çš„å¤§åŒ…ä¼šåœ¨ç½‘ç»œè®¾å¤‡å±‚è¢«è½¯ä»¶æ‹†æˆç½‘å¡å¯ä»¥å‘é€çš„å°åŒ…ï¼Œè¿™ä¸ªæ“ä½œåœ¨ç½‘å¡æŠ“åŒ…çš„ hook ç‚¹ä¹‹åï¼Œæ‰€ä»¥å¦‚æœé€šè¿‡ tcpdump çœ‹å¯ä»¥çœ‹åˆ°å¤§äºç½‘å¡ mtu çš„åŒ…ï¼Œè¯´æ˜ GSO/TSO æ˜¯ç”Ÿæ•ˆçš„ã€‚

.. code-block:: c

   __dev_queue_xmit
   |- skb = sch_handle_egress(skb, &rc, dev); ğŸ‘ˆ æŠ“åŒ…å‘ç”Ÿåœ¨è¿™ä¸ªé‡Œé¢
   |- if (q->enqueue) ğŸ‘ˆ ç¡¬ä»¶ç½‘å¡èµ°è¿™è¾¹
   |  |- rc = __dev_xmit_skb(skb, q, dev, txq);
   |  |      |- sch_direct_xmit
   |  |         |- validate_xmit_skb_list
   |  |         |  |- validate_xmit_skb
   |  |         |- skb = dev_hard_start_xmit(skb, dev, txq, &ret);
   |  |- goto out;
   |- if (dev->flags & IFF_UP) ğŸ‘ˆ è™šæ‹Ÿç½‘å¡ï¼ˆloï¼Œtunnel å•Šä¹‹ç±»çš„ï¼‰
   |  |- validate_xmit_skb
   |  |- skb = dev_hard_start_xmit(skb, dev, txq, &rc)

``validate_xmit_skb`` å‡½æ•°é‡Œé¢æ˜¯å®é™…æ‰§è¡Œåˆ†æ®µçš„åœ°æ–¹ã€‚

.. code-block:: c

   validate_xmit_skb
   |- if (netif_needs_gso(skb, features)
   |  |- segs = skb_gso_segment(skb, features)
   |            |- __skb_gso_segment
   |               |- skb_mac_gso_segment
   |                  |- ptype->callbacks.gso_segment(skb, features)
   |- else
   |  |- if (skb_needs_linearize(skb, features) && __skb_linearize(skb))

ä¸Šé¢çš„ ``ptype->callbacks.gso_segment`` å›è°ƒ IP å±‚æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼ŒIPv4 æ˜¯ `inet_gso_segment <https://elixir.bootlin.com/linux/v5.19/C/ident/inet_gso_segment>`__ ï¼ŒIPv6 æ˜¯ `ipv6_gso_segment <https://elixir.bootlin.com/linux/v5.19/C/ident/ipv6_gso_segment>`__ ã€‚ç„¶åå†ä¾æ¬¡è°ƒç”¨ä¸Šå±‚çš„ gso_segment å‡½æ•°ã€‚

``dev_hard_start_xmit`` æ˜¯é©±åŠ¨ç¨‹åºçš„å…¥å£ç¨‹åºã€‚

.. code-block:: c

   dev_hard_start_xmit
   |- xmit_one for each skb
      |- netdev_start_xmit
         |- __netdev_start_xmit
            |- dev->netdev_ops->ndo_start_xmit

å¦‚æœæ˜¯ ipip éš§é“åè®®ï¼Œ ``ndo_start_xmit`` å›è°ƒå‡½æ•°å°±æ˜¯ `ipip_tunnel_xmit <https://elixir.bootlin.com/linux/v5.19/C/ident/ipip_tunnel_xmit>`__ ã€‚

- `25 å¼ å›¾ï¼Œä¸€ä¸‡å­—ï¼Œæ‹†è§£ Linux ç½‘ç»œåŒ…å‘é€è¿‡ç¨‹ <https://mp.weixin.qq.com/s/wThfD9th9e_-YGHJJ3HXNQ>`_
-  https://blog.csdn.net/wangquan1992/article/details/109018488
-  https://www.cnblogs.com/dream397/p/14500939.html