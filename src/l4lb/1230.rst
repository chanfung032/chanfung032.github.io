#1230 è°ƒè¯•
===================

å¦‚ä½•è°ƒè¯•é—®é¢˜
-----------------

xdp/bpf ç¨‹åºä¸æ”¯æŒ gdb ä¹‹ç±»çš„å·¥å…·ï¼Œæ‰€ä»¥è°ƒè¯•åªèƒ½è¯‰è¯¸äº tcpdump + æ—¥å¿—ã€‚è½¬å‘è¿‡ç¨‹ä¸­ç½‘ç»œåŒ…ä¾æ¬¡ç»è¿‡äº† ``t22`` -> ``t33`` -> ``t33 é‡Œçš„ eth0`` -> ``t33 é‡Œçš„ lo`` è¿™äº›ç½‘å£ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥ä»å‰åˆ°å tcpdump è¿™äº›æ¥å£å¹¶éªŒè¯æ•°æ®æ˜¯å¦å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€è‡´ï¼Œä¸ä¸€è‡´è§£å†³é—®é¢˜ï¼Œä¸€ç‚¹ä¸€ç‚¹å¾€å‰æ¨è¿›ã€‚

å¸¸ç”¨ tcpdump å‘½ä»¤ï¼š

.. code-block:: bash

    # -nã€-nn ä¸è½¬æ¢åœ°å€ä¸ºä¸»æœºåã€ä¸ç¿»è¯‘ç«¯å£ä¸ºåè®®å
    # -vvv Even more verbose output
    # -x æ‰“å°å‡ºåŸå§‹ IP åŒ…
    tcpdump -n -nn -vvv -x -i <iface>
    # -xx æ‰“å°å‡ºåŒ…æ‹¬ ethernet header çš„æ•´ä¸ªç½‘ç»œåŒ…
    tcpdump -n -nn -vvv -xx -i <iface>

veth & xdp
---------------------

å¦‚æœåœ¨ t22 ç½‘å£ä¸Š tcpdump åªæœ‰è¿›çš„åŒ…ï¼Œæ²¡æœ‰è½¬å‘å‡ºæ¥çš„åŒ…ï¼Œå¯èƒ½çš„åŸå› æœ‰ä¸¤ä¸ªï¼š

ç¬¬ä¸€ä¸ªï¼Œt22 ç½‘å£ä¸Šæ²¡æœ‰åŠ è½½ xdp ç¨‹åºã€‚

    Note that in order to the transmit and/or redirect functionality to work, all involved devices should have an attached XDP program, including both veth peers. We have to do this because veth devices wonâ€™t deliver redirected/retransmitted XDP frames unless there is an XDP program attached to the receiving side of the target veth interface. Physical hardware will likely behave the same. XDP maintainers are currently working on fixing this behaviour upstream. See the `Veth XDP: XDP for containers <https://www.netdevconf.org/0x13/session.html?talk-veth-xdp>`_  talk which describes the reasons behind this problem. (The xdpgeneric mode may be used without this limitation.)

    https://github.com/xdp-project/xdp-tutorial/tree/master/packet03-redirecting#sending-packets-back-to-the-interface-they-came-from

è¿™ä¸ªé—®é¢˜è§£å†³çš„æ–¹æ³•å°±æ˜¯åœ¨æ‰€æœ‰æåˆ°çš„ç½‘å£ä¸Šéƒ½æŒ‚è½½ä¸€ä¸ªç©º xdp ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºåªå¹²ä¸€ä»¶äº‹ï¼Œå°±æ˜¯è¿”å› XDP_PASSã€‚

å¦å¤–ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯ 22 ns é‡ŒæŒ‚è½½çš„ xdp director ç¨‹åºæ ¹æœ¬æ²¡æœ‰è¿”å› XDP_TXï¼Œæ¯”å¦‚ xdp ç¨‹åºä¸­çš„é”™è¯¯å¤„ç†å¯èƒ½ä¼šè¿”å› XDP_DROPï¼Œå¯¼è‡´åŒ…è¢«ç›´æ¥ dropã€‚è¿™ä¸ªä¸€èˆ¬é€šè¿‡åŠ æ—¥å¿—å°±èƒ½æ‰¾åˆ°é—®é¢˜ã€‚è¯´è¿™ä¸ªå½“ç„¶æ˜¯æ‰åœ¨è¿™ä¸ªå‘é‡Œè¿‡ï¼Œå¼€å‘å°åŒ…ç¨‹åºè°ƒç”¨ bpf_xdp_adjust_head ç”³è¯·ç©ºé—´çš„æ—¶å€™ï¼Œdelta å‚æ•°ä¼ æˆäº†æ­£çš„ï¼ˆä¸ºè´Ÿæ‰æ˜¯å¢åŠ ç©ºé—´ï¼‰ï¼Œå¯¼è‡´ç©ºé—´åè€Œç¼©å°äº†ï¼Œåç»­å†™ GUE header å‰åš bounds checking çš„æ—¶å€™å‘ç°ç©ºé—´ä¸å¤Ÿï¼ˆè¦å†™çš„åœ°æ–¹åœ¨ data_end ä¹‹åäº†ï¼‰ï¼Œè¿”å› XDP_DROPï¼Œå¯¼è‡´åŒ…è¢« drop äº† ğŸ¤¦â€â™‚ï¸ã€‚

å¯ä»¥ ping é€šä½†æ˜¯ curl æŠ¥ No route to host
------------------------------------------------

åœ¨ 22 ns é‡Œç›´æ¥ curl 33ï¼ŒæŠ¥ No route to hostã€‚

.. code-block:: console

    $ ip netns exec t22 curl 172.17.3.3
    curl: (7) Failed to connect to 172.17.3.3 port 80: No route to host

tcpdump t22 ç½‘å£ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š ::

    172.17.2.2.49138 > 172.17.3.3.80: Flags [S], cksum 0x5d56 (incorrect -> 0x26e6), seq 1545991743, win 64240, options [mss 1460,sackOK,TS val 2712278192 ecr 0,nop,wscale 6], length 0
    08:04:59.957166 IP (tos 0xc0, ttl 64, id 54935, offset 0, flags [none], proto ICMP (1), length 88)
    172.17.2.1 > 172.17.2.2: ICMP host 172.17.3.3 unreachable - admin prohibited filter, length 68

è¿™ä¸ª ``unreachable - admin prohibited filter`` è·Ÿ firewalld æœ‰å…³ç³»ï¼Œç›´æ¥å…³é—­ firewalld å°± okã€‚

.. code-block:: console

    $ systemctl disable --now firewalld

https://unix.stackexchange.com/questions/552857/why-are-my-network-connections-being-rejected

14 bytes missing!
-----------------------

å‰é¢ä¸€åˆ‡é¡ºåˆ©ï¼Œåˆ° 33 ns åè§£åŒ…å¹¶ redirect ç»™ lo åï¼Œtcpdump lo æŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š

::

    08:18:20.780688 IP truncated-ip - 14 bytes missing! (tos 0x0, ttl 64, id 30246, offset 0, flags [DF], proto TCP (6), length 60)
        172.17.2.1.36312 > 172.17.2.2.80: Flags [S], seq 481216774, win 64240, options [mss 1460,sackOK,[|tcp]>
        0x0000:  4500 003c 7626 4000 4006 6870 ac11 0201
        0x0010:  ac11 0202 8dd8 0050 1cae c906 0000 0000
        0x0020:  a002 faf0 0d84 0000 0204 05b4 0402

è¿™ä¸ªé—®é¢˜æ˜¯å°åŒ…çš„ iphdr ä¸­çš„ tot_len ï¼ˆIP åŒ…çš„æ€»é•¿åº¦ï¼‰ä¸å¯¹å¯¼è‡´çš„ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯å“ªå¤šå‡äº† 14 ä¸ªå­—èŠ‚ã€‚


bpf_redirect åˆ°å…¶å®ƒç½‘å£è¦ä¿®æ”¹ dst mac åœ°å€
-------------------------------------------------

è¿™ä¸ªé—®é¢˜æ˜¯æ‰€æœ‰é—®é¢˜é‡Œæœ€éš¾è§£å†³çš„ä¸€ä¸ªï¼Œå› ä¸ºæ‰€æœ‰çš„æµç¨‹çœ‹ä¸Šå»éƒ½æ­£ç¡®äº†ï¼Œå°åŒ…ã€è½¬å‘ã€è§£åŒ…ã€redirectï¼Œç½‘ç»œåŒ…æˆåŠŸåˆ°è¾¾äº†æˆ‘ä»¬ç»‘å®š 172.17.2.2 çš„ lo ç½‘å£ï¼Œtcpdump å‡ºæ¥çš„ç½‘ç»œåŒ…æ˜¾ç¤ºåŒ…çš„å†…å®¹å’ŒåŸå§‹å†…å®¹ **ä¸€æ¨¡ä¸€æ ·**ï¼Œä½†æ˜¯å†…æ ¸å°†è¿™ä¸ªåŒ…ä¸¢æ‰äº†ï¼ŒWTFï¼

æœ€å¼€å§‹æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸€äº›å·¥å…·æ¥çœ‹çœ‹å†…æ ¸åœ¨å“ªæŠŠåŒ…ä¸¢äº†ï¼ˆåé¢å•ç‹¬å°èŠ‚è¯´æ˜æ–¹æ³•ï¼‰ï¼Œå®šä½åˆ° `ip_rcv_core <https://github.com/torvalds/linux/blob/v5.10/net/ipv4/ip_input.c#L435>`_ è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸çŸ¥é“å…·ä½“çš„åŸå› ã€‚

æ²¡åŠæ³•åªå¥½å›å½’æœ€åŸå§‹çš„æ–¹æ³•ï¼Œä½¿ç”¨ scapy ä»æ²¡é—®é¢˜å¼€å§‹æ„é€ ä¸€ä¸ªæœ€å°çš„å¤ç°é—®é¢˜çš„ä»£ç ï¼Œä¸€æ­¥ä¸€æ­¥æ¨ç†ã€‚

é¦–å…ˆï¼Œç›´æ¥åœ¨ 33 ns ä¸­ç›´æ¥ç»™ lo å‘ä¸€ä¸ªåŒ…ï¼Œ ok æ²¡é—®é¢˜ã€‚

.. code-block:: python

    pkt = Ether(dst=NS_33_LO_MAC, src=SRC_MAC)/IP(dst="172.17.2.2", src="172.17.2.1")/TCP()
    print(repr(srp1(pkt, iface="lo")))

ç„¶åï¼Œé€šè¿‡ t33 ç½‘å£å‘é€åŒ…ï¼Œbpf_redirect ç»™ lo åè¢«ä¸¢äº†ï¼Œä½¿ç”¨å†…æ ¸å·¥å…·æ£€æŸ¥ drop çš„ä½ç½®ä¸€æ ·ã€‚

.. code-block:: python

    pkt = Ether(dst=NS_33_ETH0_MAC, src=SRC_MAC)/IP(dst="172.17.2.2", src="172.17.2.1")/TCP()
    print(repr(srp1(pkt, iface="t33")))

é‚£ä¹ˆç»è¿‡ eth0 redirect åˆ° lo çš„åŒ…å’Œç›´æ¥å‘ç»™ lo çš„åŒ…æœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼Œé¢ã€‚ã€‚ã€‚è¿˜çœŸæœ‰ï¼Œå®ƒä»¬çš„ dst mac åœ°å€ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´çš„ï¼Ÿæˆ‘ä»¬ä¿®æ”¹ä¸Šé¢çš„ç¨‹åºï¼Œä¿®æ”¹ dst mac åœ°å€ä¸ºä¸€ä¸ªä¹±ä¸ƒå…«ç³Ÿçš„åœ°å€ï¼Œç„¶åå’Œæœ€å¼€å§‹ä¸€æ ·ï¼Œåœ¨ 33 ns ä¸­ç»™ lo ç›´æ¥å‘ä¸€ä¸ªåŒ…ï¼Œyesï¼ä¸¢äº†ã€‚é—®é¢˜æ‰¾åˆ°ã€‚

æ‰€ä»¥ä½¿ç”¨ bpf_redirect å°†åŒ… redirect ç»™å…¶å®ƒç½‘å£å‰éœ€è¦å…ˆä¿®æ”¹ dst macã€‚

ç®— iphdr çš„ checksum æ—¶å…ˆå°† checksum è®¾ç½®ä¸º 0
-------------------------------------------------

æœ€åï¼Œcurl åŸºæœ¬å¯ä»¥è¿è¡Œäº†ï¼Œä½†ä¸æ˜¯ 100% æˆåŠŸï¼Œé—´æˆ–æœ‰è¶…æ—¶æˆ–è€… IP åŒ…é‡ä¼ å¯¼è‡´çš„å“åº”æ…¢ï¼Œtcpdump å‘ç°æ­£å¸¸å’Œä¸æ­£å¸¸çš„å”¯ä¸€åŒºåˆ«æ˜¯ä¸æ­£å¸¸çš„æ—¶å€™æœ‰äº›è½¬å‘åŒ…çš„ tcpdump ä¿¡æ¯æ˜¾ç¤º checksum incorrectï¼Œæ£€æŸ¥å‘ç° xdp director å°åŒ…çš„æ—¶å€™è®¡ç®— checksum çš„æ—¶å€™æ²¡æœ‰é¦–å…ˆå°† checksum ç½®é›¶ã€‚ä¿®æ”¹å†è¿è¡Œï¼Œ100% æˆåŠŸã€‚

è‡³æ­¤ï¼Œç¬¬ä¸€ä¸ªå°ç›®æ ‡ï¼Œå®Œæˆã€‚

æº/ç›®æ ‡ IP ä¸€æ ·å¯¼è‡´çš„åŒ…è¢«ä¸¢
-------------------------------

å½“è½¬å‘çš„åç«¯å°±æ˜¯æœ¬æœºçš„æ—¶å€™ï¼Œxdp å¯ä»¥ç›´æ¥ accept åŒ…ï¼Œæ­¤æ—¶åŒ…ä¸­çš„æº IP å’Œç›®çš„ IP å°±ä¼šä¸€æ ·ï¼Œè¿™ç§åŒ…ä¼šè¢«å†…æ ¸ä¸¢æ‰ï¼Œè§£å†³æ–¹æ³•æ˜¯ä¿®æ”¹æº IPï¼Œæˆ–è€…ä¿®æ”¹ä¸‹é¢è¿™ä¸ªå†…æ ¸å‚æ•°å…³é—­è¯¥è¡Œä¸ºï¼š

.. code-block:: console

    # sysctl -w net.ipv4.conf.interface.accept_local=1

https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt

æ‰¾å‡ºå†…æ ¸åœ¨å“ªä¸¢åŒ…çš„å‡ ä¸ªæ–¹æ³•
-----------------------------

https://jvns.ca/blog/2017/09/05/finding-out-where-packets-are-being-dropped/

ç®€å•æ–¹æ³•ï¼ŒæŸ¥çœ‹å†…æ ¸çš„ä¸€äº›æŒ‡æ ‡æ•°æ®ï¼Œæ£€æŸ¥æµ‹è¯•å‰åæŒ‡æ ‡æ•°æ®çš„å˜åŒ–ï¼ˆerror ç›¸å…³çš„æŒ‡æ ‡ï¼‰ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ¨å¯¼å‡ºé—®é¢˜ã€‚

.. code-block:: console

    # netstat -i
    Kernel Interface table
    Iface             MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
    eth0             1500   403544      0      0 0        232905      0      0      0 BMRU
    lo              65536      848      0      0 0           848      0      0      0 LRU
    t22              1500     1017      0      0 0           856      0      0      0 BMRU
    t33              1500      704      0      0 0           829      0      0      0 BMRU
    # ethtool -S eth0
    NIC statistics:
        rx_packets: 403612
        tx_packets: 232875
        rx_bytes: 206386735
        tx_bytes: 22216963
        ...
        rx_errors: 0
        tx_errors: 0
        tx_dropped: 0
        ...
        rx_length_errors: 0
        rx_over_errors: 0
        rx_crc_errors: 0
        rx_frame_errors: 0
        rx_no_buffer_count: 0
        rx_missed_errors: 0
        tx_aborted_errors: 0
        tx_carrier_errors: 0
        tx_fifo_errors: 0
        tx_heartbeat_errors: 0
        tx_window_errors: 0
        ...

æ–¹æ³•äºŒï¼šä½¿ç”¨ ``perf`` ç›‘æ§ã€‚

.. code-block:: console

    # perf record -g -a -e skb:kfree_skb
    # perf script -f
    ffffffffa195b695 kfree_skb+0x85 ([kernel.kallsyms])
    ffffffffa195b695 kfree_skb+0x85 ([kernel.kallsyms])
    ffffffffa1a00d10 ip_rcv_core+0x200 ([kernel.kallsyms])
    ffffffffa1a013bf ip_rcv+0x1f ([kernel.kallsyms])
    ffffffffa1975c77 __netif_receive_skb_one_core+0x67 ([kernel.kallsyms])
    ...

æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ ``dropwatch`` å·¥å…·ï¼Œhttps://github.com/pavel-odintsov/drop_watchï¼Œä¸è¿‡è¿™ä¸ªé¡¹ç›®ä¼¼ä¹å¾ˆä¹…æ²¡æœ‰ç»´æŠ¤äº†ã€‚

.. code-block:: console

    # yum install -y dropwatch
    # dropwatch -l kas
    Initalizing kallsyms db
    dropwatch> start
    Enabling monitoring...
    Kernel monitoring activated.
    Issue Ctrl-C to stop monitoring

    2 drops at ip_rcv_core+200 (0xffffffffa1a00d10)

CentOS 7 å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ bpftool
---------------------------------------

ä½¿ç”¨ https://github.com/fbs/el7-bpf-specs æä¾›çš„ yum ä»“åº“ä¸­çš„ bpftool ã€‚