#220330 é—®é¢˜
===================

ixgbe Detected Tx Unit Hang
----------------------------------

ç°è±¡æ˜¯ç½‘å¡ä¸æ–­é‡å¯ï¼ŒæŸ¥çœ‹ ``/var/log/message`` å¯ä»¥çœ‹åˆ°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š ::

    Mar 25 15:35:53: [686973.797868] ixgbe 0000:83:00.0 p4p1: Detected Tx Unit Hang (XDP)
    Mar 25 15:35:53: [686973.797868]   Tx Queue             <24>
    Mar 25 15:35:53: [686973.797868]   TDH, TDT             <84>, <136>
    Mar 25 15:35:53: [686973.797868]   next_to_use          <136>
    Mar 25 15:35:53: [686973.797868]   next_to_clean        <84>
    Mar 25 15:35:53: [686973.797868] tx_buffer_info[next_to_clean]
    Mar 25 15:35:53: [686973.797868]   time_stamp           <0>
    Mar 25 15:35:53: [686973.797868]   jiffies              <128edcdc0>
    ...
    Mar 25 15:35:53: [686973.797955] ixgbe 0000:83:00.0 p4p1: tx hang 1 detected on queue 25, resetting adapter
    ...
    15:35:53 kernel: [687078.764725] bond0: link status down for interface p4p2, disabling it in 200 ms

è¿™ä¸ªé—®é¢˜æ˜¯ ixgbe é©±åŠ¨ xdp å®ç° BUG å¯¼è‡´ï¼Œå‡ºç°åœ¨ cpu æ¯”è¾ƒå¤šçš„æœºå™¨ã€‚

    When the received core is such that the xdp queue falls beyond
    MAX_TX_QUEUES(64), then the hang results. In other words, if I leave
    `ethtool -L eno1 combined 40` (the default), and a packet is received on
    core 24 or greater, it hangs. However, if I lower the tx queue count to
    24 (since XDP is forced to nr_cpu_ids), or if I force the incoming
    packets onto core < 24 with an ntuple filter, then no hang occurs.

.. code-block:: console

    # ethtool -l p4p1
    Channel parameters for p4p1:
    Pre-set maximums:
    RX:		0
    TX:		0
    Other:		1
    Combined:	63
    Current hardware settings:
    RX:		0
    TX:		0
    Other:		1
    Combined:	28
    # nproc
    56
    # uname -r
    4.19.113-88.4bs.el7.centos.x86_64

å½“ ``combined + xdp queues(nr_cpu_ids) > max_tx_queues(64)`` å°±ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚

è¯¦ç»†é—®é¢˜è®¨è®ºåœ¨è¿™ä¸¤ä¸ª thread ä¸­ï¼š

- https://www.spinics.net/lists/netdev/msg439438.html
- https://www.spinics.net/lists/netdev/msg519914.html

ä¸å‡çº§å†…æ ¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ ``ethtool -L p4p1 combined N`` å‘½ä»¤è°ƒä½ combined çš„ä¸ªæ•°ï¼Œç»•è¿‡è¿™ä¸ª BUGï¼Œä½†æ˜¯ä¼šå½±å“æ€§èƒ½ã€‚

BUG åœ¨ 4.20-rc1 å·²ç»ä¿®å¤ã€‚å‚è§ï¼šhttps://github.com/torvalds/linux/commit/8d7179b1e2d64b3493c0114916486fe92e6109a9

å¦ä¸€ä¸ªè§£å†³é—®é¢˜çš„æ–¹æ³•æ˜¯è®¾å®š XDP åŠ è½½æ¨¡å¼ä¸º skb æ¨¡å¼ï¼ŒåŒæ ·ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ˜¯ä¸éœ€è¦å‡çº§å†…æ ¸ã€‚

i40e/X722 unable to handle kernel NULL pointer dereference
-----------------------------------------------------------------

i40e é©±åŠ¨ï¼Œç½‘å¡æ˜¯ X722 å‹å·çš„ï¼Œåœ¨åŠ è½½ xdp çš„æ—¶å€™ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ã€‚

.. code-block:: console

    # ethtool -i enp61s0f0
    driver: i40e
    version: 2.3.2-k
    ...
    # lshw -class network -short
    H/W path         Device      Class          Description
    =======================================================
    /0/0/0/3/0       enp61s0f0   network        Ethernet Connection X722 for 10GbE SFP+
    /0/0/0/3/0.1     enp61s0f1   network        Ethernet Connection X722 for 10GbE SFP+
    /3               bond0       network        Ethernet interface

é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š ::

	i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
	i40e 0000:3d:00.0: setup of MAIN VSI failed
	i40e 0000:3d:00.0: can't remove VEB 160 with 0 VSIs left
	BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
	Oops: 0000 [#1] SMP NOPTI
	CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
	Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
	RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
	i40e 0000:3d:00.0: failed to get tracking for 256 queues for VSI 0 err -12
	i40e 0000:3d:00.0: setup of MAIN VSI failed
	i40e 0000:3d:00.0: can't remove VEB 160 with 0 VSIs left
	BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	PGD 1fe4ee7067 P4D 1fe4ee7067 PUD 1ef96f8067 PMD 0
	Oops: 0000 [#1] SMP NOPTI
	Oops: 0000 [#1] SMP NOPTI
	CPU: 21 PID: 809441 Comm: l4lb Tainted: G           OE     4.19.113-88.6bs.el7.x86_64 #1
	Hardware name: Sugon I420-G30/60P16-US, BIOS 0JGST219 05/30/2019
	RIP: 0010:i40e_xdp+0xae/0x110 [i40e]
	Code: 87 ab d0 0c 00 00 84 c0 75 60 31 c0 66 83 bb f6 0c 00 00 00 74 27 48 8b 93 90 0c 00 00 48 63 f0 48 8b 8b d0 0c 00 00 83 c0 01 <48> 8b 14 f2 48 89 4a 20 0f b7 93 f6 0c 00 00 39 d0 7c d9 48 85 ed
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	RSP: 0018:ffff9d00ea6af8c0 EFLAGS: 00010202
	RAX: 0000000000000001 RBX: ffff88f5f75fc000 RCX: ffff9d00c01ef000
	RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff88f5ffcd68f0
	RBP: 0000000000000000 R08: 0000000000000070 R09: 0000000000027e7c
	R10: ffff89063ff468c0 R11: 0000000000000707 R12: ffff88f5f7600000
	R13: ffffffffc0308aa0 R14: ffffffffc032c5a0 R15: 000000000000000f
	FS:  00007f25f9ffb700(0000) GS:ffff88f5ffcc0000(0000) knlGS:0000000000000000
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
	CR2: 0000000000000000 CR3: 0000001fb3828004 CR4: 00000000007606e0
	DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
	DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
	PKRU: 55555554
	Call Trace:
	 dev_xdp_install+0x4f/0x70
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 dev_change_xdp_fd+0x103/0x210
	 ? dev_disable_lro+0xa0/0xa0
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 do_setlink+0xd63/0xd90
	 ? cpumask_next+0x16/0x20
	 ? do_kernel_range_flush+0x50/0x50
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 ? nla_parse+0xa4/0x120
	 rtnl_setlink+0xd7/0x140
	 ? security_capset+0x50/0x70
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 rtnetlink_rcv_msg+0x28f/0x350
	 ? _cond_resched+0x15/0x30
	 ? __kmalloc_node_track_caller+0x188/0x280
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 ? rtnl_calcit.isra.27+0x110/0x110
	 netlink_rcv_skb+0xd4/0x110
	 netlink_unicast+0x182/0x230
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 netlink_sendmsg+0x2ed/0x3e0
	 sock_sendmsg+0x36/0x50
	 __sys_sendto+0xdc/0x160
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 ? sock_setsockopt+0x3b9/0xc80
	 ? syscall_trace_enter+0x1c9/0x2c0
	 ? __audit_syscall_exit+0x213/0x350
	 __x64_sys_sendto+0x24/0x30
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	 do_syscall_64+0x5b/0x1a0
	 entry_SYSCALL_64_after_hwframe+0x44/0xa9
	RIP: 0033:0x4aeeea
	bond0: link status down for interface enp61s0f0, disabling it in 200 ms
	Code: e8 5b 9c fb ff 48 8b 7c 24 10 48 8b 74 24 18 48 8b 54 24 20 4c 8b 54 24 28 4c 8b 44 24 30 4c 8b 4c 24 38 48 8b 44 24 08 0f 05 <48> 3d 01 f0 ff ff 76 20 48 c7 44 24 40 ff ff ff ff 48 c7 44 24 4

	RSP: 002b:000000c0003d8f98 EFLAGS: 00000216 ORIG_RAX: 000000000000002c

è¿™ä¸ªæ˜¯é©±åŠ¨ BUGï¼Œå‡çº§é©±åŠ¨å¯è§£å†³ã€‚

- é©±åŠ¨ä¸‹è½½ï¼šhttps://www.intel.com/content/www/us/en/download/18026/intel-network-adapter-driver-for-pcie-40-gigabit-ethernet-network-connections-under-linux.html
- é‚®ä»¶åˆ—è¡¨åŒæ ·é—®é¢˜è®¨è®ºï¼šhttps://www.spinics.net/lists/xdp-newbies/msg01780.html
- ä¿®å¤è¡¥ä¸ï¼šhttps://github.com/torvalds/linux/commit/92947844b8beee988c0ce17082b705c2f75f0742

----

çº¿ä¸Šå‡çº§çš„æ—¶å€™æ˜¯æ–°å†…æ ¸å’Œæ–°é©±åŠ¨ä¸€èµ·å‡çº§ï¼Œé»˜è®¤æƒ…å†µä¸‹éœ€è¦é‡å¯ä¸¤æ¬¡æ–°é©±åŠ¨æ‰ç”Ÿæ•ˆï¼Œç¬¬ä¸€æ¬¡æ–°å†…æ ¸ç”Ÿæ•ˆï¼Œç¬¬äºŒæ¬¡æ–°é©±åŠ¨æ‰ç”Ÿæ•ˆï¼Œå› ä¸ºæ–°é©±åŠ¨å®‰è£…çš„æ—¶å€™æœ€å postinstall è„šæœ¬é‡Œçš„ ``depmod`` æ‰§è¡Œè¿˜æ˜¯åœ¨è€å†…æ ¸ä¸Šï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡é‡å¯è¿˜æ˜¯ä½¿ç”¨çš„æ–°å†…æ ¸é»˜è®¤è‡ªå¸¦çš„è€é©±åŠ¨ã€‚è§£å†³æ–¹æ³•æ˜¯æ–°é©±åŠ¨é‡Œæ·»åŠ ä¸€ä¸ª ``/etc/depmod.d/`` é…ç½®æ–‡ä»¶ã€‚

.. code-block:: console

	# cat /etc/depmod.d/kmod-i40e.conf
	override i40e * weak-updates/i40e

https://linux.die.net/man/8/depmod

----

å‡çº§é©±åŠ¨ç‰ˆæœ¬æ³¨æ„ä¸­é—´æœ‰äº›ç‰ˆæœ¬å‡çº§åä¼šå‡ºç°ç½‘å¡ç»Ÿè®¡çš„ RX ä¸€ç›´ä¸º 0 çš„é—®é¢˜ï¼Œè¿™ä¸ªåœ¨ä¸‹é¢è¿™ä¸ªæäº¤ä¸­å·²ç»ä¿®å¤ï¼š

https://github.com/torvalds/linux/commit/cdec2141c24ef177d929765c5a6f95549c266fb3

è™½ç„¶è¿™ä¸ªæ˜¯ 2018 å¹´çš„æäº¤ï¼Œä½† intel å®˜æ–¹åœ¨ 2021 å¹´ä¹‹åæä¾›çš„é©±åŠ¨ç‰ˆæœ¬ä¼¼ä¹è¿˜æ˜¯ä¸åŒ…å«è¿™ä¸ªè¡¥ä¸å†…å®¹ã€‚éœ€è¦ä»£ç ç¡®è®¤ä¸‹ã€‚

ç¬¬äºŒè·³ç›´æ¥æ‘˜é™¤ VIP + æœåŠ¡å™¨å¼€å¯äº† ip_forward é€ æˆçš„åŒ…å¾ªç¯
---------------------------------------------------------------

å¦‚æœç¬¬äºŒè·³æœºå™¨ä¸Šæ²¡æœ‰ç»‘å®š VIPï¼Œæœºå™¨ä¸Šåˆå¼€å¯äº† ip_forwardï¼Œè¿™ä¸ªæ—¶å€™è§£åŒ…å‡ºä¸€ä¸ª VIP çš„åŒ…è¿‡æ¥ï¼Œå‘ç°ä¸æ˜¯æœ¬æœº IPï¼Œä¼šèµ°è·¯ç”±å°†åŒ…è½¬å‘å‡ºå»ï¼ŒåŒ…åˆä¼šä»è´Ÿè½½å‡è¡¡è¿›æ¥ï¼Œé‡æ–°è½¬å‘ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åŒ…åªæœ‰ ttl ä¼šå‡å°ï¼Œä¼šå¯¼è‡´åŒ…ä¸€ç›´åœ¨ director -> ç¬¬ä¸€è·³åç«¯ -> ç¬¬äºŒè·³åç«¯ -> director è¿™æ ·å¾ªç¯ï¼Œç›´åˆ° ttl ä¸º 0 ä¸ºæ­¢ã€‚

.. code-block:: console

    # tcpdump -i bond0 'dst <VIP>'  -nnn -v -e
    19:26:28.377695 24:6e:96:c6:aa:60 > e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 49, id 21256, offset 0, flags [DF], proto TCP (6), length 40)
      112.8.88.102.14979 > 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0
    ...
    19:26:28.380421 24:6e:96:c6:aa:60 > e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 4, id 21256, offset 0, flags [DF], proto TCP (6), length 40)
      112.8.88.102.14979 > 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0
    19:26:28.380493 24:6e:96:c6:aa:60 > e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 3, id 21256, offset 0, flags [DF], proto TCP (6), length 40)
      112.8.88.102.14979 > 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0
    19:26:28.380540 24:6e:96:c6:aa:60 > e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 2, id 21256, offset 0, flags [DF], proto TCP (6), length 40)
      112.8.88.102.14979 > 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0
    19:26:28.380595 24:6e:96:c6:aa:60 > e4:43:4b:0a:fb:60, ethertype IPv4 (0x0800), length 54: (tos 0x0, ttl 1, id 21256, offset 0, flags [DF], proto TCP (6), length 40)
      112.8.88.102.14979 > 140.249.147.253.80: Flags [F.], cksum 0x6105 (correct), seq 0, ack 1, win 333, length 0

æ•™è®­å°±æ˜¯ï¼š

- åœ¨å¯¹ç§°éƒ¨ç½²æ¶æ„ä¸‹ï¼ŒOSPF VIP å’Œåç«¯ç»‘å®š VIP éœ€è¦åœ¨é€»è¾‘åœ¨åˆ†å¼€ï¼ˆç‰©ç†ä¸Šå¯èƒ½ç»‘å®šçš„æ˜¯ä¸€ä¸ªï¼‰ï¼Œæœ‰äº›åœºæ™¯ä¸‹ OSPF VIP å’Œåç«¯ VIP çš„ç»‘å®šè§£ç»‘é€»è¾‘ä¸ä¸€è‡´ï¼Œä¸€ä¸ªéœ€è¦è§£ï¼Œä¸€ä¸ªä¸èƒ½è§£ï¼Œè¿™ä¸ªéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé¿å…ç±»ä¼¼ä¸Šé¢è¿™æ ·çš„é—®é¢˜ã€‚
- æ²¡äº‹åˆ«å¼€ ip_forwardã€‚

IPv4 VIP è®¿é—®æ­£å¸¸ã€IPv6 è®¿é—®å¼‚å¸¸å¯èƒ½çš„é—®é¢˜
---------------------------------------------------

é›†ç¾¤ä¸­æœ‰ä¸€å°æœºå™¨ IPv6 è®¿é—®å¼‚å¸¸ï¼ŒIPv4 è®¿é—®ç¡®æ­£å¸¸ï¼Œå¼‚å¸¸çš„æœºå™¨ä¸Š IPv6 çš„ VIP ç»‘å®šæ­£å¸¸ï¼Œsit0 ç½‘å¡ä¹Ÿæ­£å¸¸ï¼Œä¸€åˆ‡çœ‹ä¸Šå»éƒ½æŒºæ­£å¸¸ï¼Œè¿™ç§æƒ…å†µå¯èƒ½æ˜¯æ²¡æœ‰åˆå§‹åŒ– IPv6 å¯¼è‡´ç¼ºå°‘é»˜è®¤ IPv6 è·¯ç”±ï¼Œä¸‹è¡Œçš„åŒ…ä¸çŸ¥é“æ€ä¹ˆå‡ºå»å¯¼è‡´çš„ã€‚

äº¤æ¢æœºå’ŒæœåŠ¡å™¨ä¸Š MTU ä¸ä¸€è‡´å¯¼è‡´çš„ bird ospf å¤±è´¥
------------------------------------------------

æœ‰äº›äº¤æ¢æœº MTU è®¾ç½®ä¸º 9000 ä¸”æ— æ³•ä¿®æ”¹ï¼Œä½†æ˜¯æŒ‚è½½äº† XDP çš„ç½‘å¡çš„ MTU æ— æ³•æ”¹åˆ°å’Œäº¤æ¢æœºçš„ä¸€è‡´ï¼ˆ :ref:`mtu9000` ï¼‰ï¼Œæ­¤æ—¶ `bird <https://bird.network.cz/>`_ ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ã€‚

.. code-block:: console

	# tail /tmp/bird.log
	2022-12-03 20:30:51.893 <RMT> ospfv2: MTU mismatch with nbr 61.184.215.126 on bond0 (remote 9000, local 1500)
	...

è¿™ä¸ªæ˜¯ bird v2.0.7 ç‰ˆæœ¬å¼€å§‹åŠ ä¸Šçš„ä¸€ä¸ªéªŒè¯ï¼Œä¹‹å‰åªæ˜¯ä¸€ä¸ª warningã€‚

https://github.com/CZ-NIC/bird/commit/267da8138d7f429941f2d829b44cf9bdd94a14d6

å¯ä»¥åŠ ä¸ªé€‰é¡¹æ”¯æŒå°†è¿™ä¸ªéªŒè¯å…³é—­ã€‚

.. code-block:: diff

	diff -ru a/proto/ospf/config.Y b/proto/ospf/config.Y
	--- a/proto/ospf/config.Y	2019-10-16 18:45:08.000000000 +0800
	+++ b/proto/ospf/config.Y	2022-12-05 16:36:46.334051267 +0800
	@@ -191,7 +191,7 @@
	 CF_DECLS
	 
	 CF_KEYWORDS(OSPF, V2, V3, OSPF_METRIC1, OSPF_METRIC2, OSPF_TAG, OSPF_ROUTER_ID)
	-CF_KEYWORDS(AREA, NEIGHBORS, RFC1583COMPAT, STUB, TICK, COST, COST2, RETRANSMIT)
	+CF_KEYWORDS(AREA, NEIGHBORS, RFC1583COMPAT, STUB, TICK, COST, COST2, RETRANSMIT, IGNOREMTU)
	 CF_KEYWORDS(HELLO, TRANSMIT, PRIORITY, DEAD, TYPE, BROADCAST, BCAST, DEFAULT)
	 CF_KEYWORDS(NONBROADCAST, NBMA, POINTOPOINT, PTP, POINTOMULTIPOINT, PTMP)
	 CF_KEYWORDS(NONE, SIMPLE, AUTHENTICATION, STRICT, CRYPTOGRAPHIC, TTL, SECURITY)
	@@ -258,6 +258,7 @@
		proto_item
	  | ospf_channel { this_proto->net_type = $1->net_type; }
	  | RFC1583COMPAT bool { OSPF_CFG->rfc1583 = $2; }
	+ | IGNOREMTU bool { OSPF_CFG->ignoremtu = $2; }
	  | RFC5838 bool { OSPF_CFG->af_ext = $2; if (!ospf_cfg_is_v3()) cf_error("RFC5838 option requires OSPFv3"); }
	  | VPN PE bool { OSPF_CFG->vpn_pe = $3; }
	  | STUB ROUTER bool { OSPF_CFG->stub_router = $3; }
	diff -ru a/proto/ospf/dbdes.c b/proto/ospf/dbdes.c
	--- a/proto/ospf/dbdes.c	2019-10-16 18:45:08.000000000 +0800
	+++ b/proto/ospf/dbdes.c	2022-12-05 16:54:41.919077802 +0800
	@@ -360,9 +360,11 @@
		   (rcv_iface_mtu != ifa->iface->mtu) &&
		   (rcv_iface_mtu != 0) && (ifa->iface->mtu != 0))
	   {
	-    LOG_PKT("MTU mismatch with nbr %R on %s (remote %d, local %d)",
	-	    n->rid, ifa->ifname, rcv_iface_mtu, ifa->iface->mtu);
	-    return;
	+    LOG_PKT("MTU mismatch with nbr %R on %s (remote %d, local %d) %d",
	+	    n->rid, ifa->ifname, rcv_iface_mtu, ifa->iface->mtu, p->ignoremtu);
	+    if (!p->ignoremtu) {
	+       return;
	+    }
	   }
	 
	   switch (n->state)
	diff -ru a/proto/ospf/ospf.c b/proto/ospf/ospf.c
	--- a/proto/ospf/ospf.c	2019-10-16 18:45:08.000000000 +0800
	+++ b/proto/ospf/ospf.c	2022-12-05 16:57:16.415081613 +0800
	@@ -287,6 +287,7 @@
	   p->af_ext = c->af_ext;
	   p->af_mc = c->af_mc;
	   p->rfc1583 = c->rfc1583;
	+  p->ignoremtu = c->ignoremtu;
	   p->stub_router = c->stub_router;
	   p->merge_external = c->merge_external;
	   p->instance_id = c->instance_id;
	@@ -708,6 +709,9 @@
	   if (p->rfc1583 != new->rfc1583)
		 return 0;
	 
	+  if (p->ignoremtu != new->ignoremtu)
	+    return 0;
	+
	   if (p->instance_id != new->instance_id)
		 return 0;
	 
	@@ -832,6 +836,7 @@
	 
	   cli_msg(-1014, "%s:", p->p.name);
	   cli_msg(-1014, "RFC1583 compatibility: %s", (p->rfc1583 ? "enabled" : "disabled"));
	+  cli_msg(-1014, "Ignore MTU: %s", (p->ignoremtu? "enabled" : "disabled"));
	   cli_msg(-1014, "Stub router: %s", (p->stub_router ? "Yes" : "No"));
	   cli_msg(-1014, "RT scheduler tick: %d", p->tick);
	   cli_msg(-1014, "Number of areas: %u", p->areano);
	diff -ru a/proto/ospf/ospf.h b/proto/ospf/ospf.h
	--- a/proto/ospf/ospf.h	2019-10-16 18:45:08.000000000 +0800
	+++ b/proto/ospf/ospf.h	2022-12-05 15:19:47.161937314 +0800
	@@ -94,6 +94,7 @@
	   u8 af_ext;
	   u8 af_mc;
	   u8 rfc1583;
	+  u8 ignoremtu;
	   u8 stub_router;
	   u8 merge_external;
	   u8 instance_id;
	@@ -232,6 +233,7 @@
	   u8 af_ext;			/* OSPFv3-AF extension */
	   u8 af_mc;			/* OSPFv3-AF multicast */
	   u8 rfc1583;			/* RFC1583 compatibility */
	+  u8 ignoremtu;
	   u8 stub_router;		/* Do not forward transit traffic */
	   u8 merge_external;		/* Should i merge external routes? */
	   u8 instance_id;		/* Differentiate between more OSPF instances */

tcpdump èƒ½çœ‹åˆ° vlan headerï¼Œä½†æ˜¯ xdp çœ‹ä¸åˆ°
------------------------------------------------

	Since XDP needs to see the VLAN headers as part of the packet headers, it is important to turn off VLAN hardware offload (which most hardware NICs support), since that will remove the VLAN tag from the packet header and instead communicate it out of band to the kernel via the packet hardware descriptor.

	https://github.com/xdp-project/xdp-tutorial/tree/master/packet01-parsing

ä¸€èˆ¬ç½‘å¡éƒ½æœ‰ vlan è§£æ/æ’å…¥çš„ç¡¬ä»¶åŠ é€Ÿï¼š

.. code-block:: console

	# ethtool -k eth0|grep vlan-offload
	rx-vlan-offload: on
	tx-vlan-offload: on [fixed]

ç½‘å¡ä¼šç›´æ¥ç¡¬ä»¶è§£æ vlan headerï¼Œç„¶åå°† vlan id ç­‰ä¿¡æ¯ç›´æ¥ç»™é©±åŠ¨ï¼ŒDMA ç»™é©±åŠ¨çš„ç½‘ç»œåŒ…ä¼šåˆ é™¤æ‰ vlan header å˜æˆä¸€ä¸ªæ™®é€šçš„ç½‘ç»œåŒ…ã€‚è¿™æ · XDP å°±çœ‹ä¸åˆ° vlan header äº†ã€‚è§£å†³çš„æ–¹æ³•æ˜¯å…³é—­è¿™ä¸ªç¡¬ä»¶åŠ é€Ÿï¼š

.. code-block:: console

    # ethtool -K eth0 rxvlan off

æˆ–è€…é€šè¿‡é…ç½®å°† vlan ä¿¡æ¯ç»™åˆ° XDP ç¨‹åºã€‚

XDP_PASS & sysctl net.ipv4.conf.interface.accept_local
--------------------------------------------------------------

https://sysctl-explorer.net/net/ipv4/accept_local/

sysctl ``net.ipv4.conf.interface.accept_local`` å‚æ•°é»˜è®¤ä¸º FALSEï¼Œæ­¤æ—¶ XDP_PASS ç»™æœ¬æœºçš„ GUE åŒ…çš„æºåœ°å€éœ€è¦æ”¹æˆå…¶ä»–éæœ¬æœº IPï¼Œå¦åˆ™åŒ…ä¼šè¢«ä¸¢æ‰ã€‚æˆ–è€…è®¾ç½® sysctl ``net.ipv4.conf.interface.accept_local`` å‚æ•°ä¸º TRUEã€‚

clang loop unroll(full) å¤±è´¥å¯¼è‡´çš„ BPF åŠ è½½å¤±è´¥
------------------------------------------------------------

ä¸‹é¢çš„ä»£ç åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå¾ªç¯ä¼šå±•å¼€å¤±è´¥ã€‚

.. code-block:: c

	#pragma clang loop unroll(full)
	for (int i = 1; i < L4LB_GUE_IPS_ARRAY_SIZE; i++) {
	    uint32_t *ip = (uint32_t *)bpf_map_lookup_elem(&l4lb_gue_ips, &i);
	    ...
	}

æŠ¥ *è­¦å‘Š*ï¼š

	warning: loop not unrolled: the optimizer was unable to perform the requested transformation; the transformation might be part of an unsupported transformation ordering [-Wpass-failed=transform-warning]

è¿™æ ·ç¼–è¯‘å‡ºçš„ bpf ä¼šåŠ è½½å¤±è´¥ï¼ŒæŠ¥ *é”™è¯¯*ã€‚

	invalid argument: back-edge from insn 1456 to 1458

æœç´¢ Linux å†…æ ¸ä»£ç å¯ä»¥çœ‹åˆ°è¿™ä¸ªé”™è¯¯æ˜¯è¯´ bpf ä»£ç ä¸­æœ‰å¾€å›çš„ jump äº†ï¼Œåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹å°±æ˜¯ä¸Šé¢çš„è¿™ä¸ªå¾ªç¯ï¼Œbpf ä¸å…è®¸å¾ªç¯ã€‚

ä¸€ä¸ªè®©ç¼–è¯‘å™¨çš„ä¼˜åŒ–å™¨å¯ä»¥æˆåŠŸå±•å¼€è¿™ä¸ªå¾ªç¯çš„æ–¹æ³•æ˜¯ï¼š

.. code-block:: c

	#pragma clang loop unroll(full)
	for (int i = 1; i < L4LB_GUE_IPS_ARRAY_SIZE; i++) {
	    int j = i;   // ğŸ‘ˆ
	    uint32_t *ip = (uint32_t *)bpf_map_lookup_elem(&l4lb_gue_ips, &j);
	    ...
	}

é‚®ä»¶åˆ—è¡¨é‡Œä¹Ÿæœ‰äººé‡åˆ°è¿‡åŒæ ·é—®é¢˜ï¼ˆhttps://lists.linuxfoundation.org/pipermail/iovisor-dev/2017-April/000733.htmlï¼‰ï¼Œç»™å‡ºçš„è§£é‡Šæ˜¯å°† ``&i`` è¿™ä¸ªå¾ªç¯è®¡æ•°å˜é‡çš„æŒ‡é’ˆä¼ ç»™ ``bpf_map_lookup_elem`` å‡½æ•°ï¼Œå‡½æ•°ä¸­å¯èƒ½ä¼šæ”¹å˜æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œä½†æ˜¯ä»è¿™ä¸ªå‡½æ•°çš„åŸå‹ ``static void *(*bpf_map_lookup_elem)(void *map, const void *key) = (void *) 1`` æ¥çœ‹ï¼Œè¿™ä¸ªå‚æ•°å‰é¢å¸¦äº† const å…³é”®å­—ï¼Œç¼–è¯‘å™¨åº”è¯¥å¯ä»¥çŸ¥é“è¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ªåªè¯»å˜é‡çš„ã€‚

----

.. code-block:: c

	int a = 24;
	const int *p = &a;

	// æŠ¥ error: assignment of read-only location â€˜*pâ€™
	*p = 10;
	// ä½†æ˜¯åšä¸€ä¸ªå¼ºåˆ¶è½¬æ¢åï¼Œåƒä¸‹é¢è¿™æ ·æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡çš„
	*(int*)p = 10;

https://stackoverflow.com/questions/34842224/when-to-use-const-void

const æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ä¹Ÿæ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œä½†è¿™ç§æƒ…å†µç¼–è¯‘å™¨åº”è¯¥è€ƒè™‘å—ï¼Ÿ

can't get map by id(2637): Device or resource busy
------------------------------------------------------

.. code-block:: console

    # bpftool map show
    2001: hash  flags 0x0
        key 24B  value 48B  max_entries 256  memlock 40960B
    2636: percpu_array  name l4lb_director_m  flags 0x0
        key 4B  value 120B  max_entries 1  memlock 8192B
    Error: can't get map by id(2637): Device or resource busy

è¿™ä¸ªå¯èƒ½æ˜¯ç”¨æˆ·ç©ºé—´ç¨‹åºæ‰“å¼€äº†å¤ªå¤šçš„ 2637 è¿™ä¸ª id çš„ bpf map fd å¯¼è‡´çš„ã€‚å†…æ ¸ä»£ç é™åˆ¶äº†ä¸€ä¸ª map æœ€å¤šå¯ä»¥æ‰“å¼€ 32768 ä¸ª fdã€‚

.. code-block:: c

    #define BPF_MAX_REFCNT 32768

    SYSCALL_DEFINE3(bpf, int, cmd, union bpf_attr __user *, uattr, unsigned int, size)
    |- bpf_map_get_fd_by_id()
       |- ...
       |- bpf_map_inc_not_zero()
          |- ...
          |- int refold = atomic_fetch_add_unless(&map->refcnt, 1, 0);
          |- if (refold >= BPF_MAX_REFCNT)
          |-   return ERR_PTR(-EBUSY);
          |- ...

BPF_MAP_TYPE_PROG_ARRAY ç±»å‹ map å†™å…¥æˆåŠŸä½†æ˜¯ bpftool dump map å‘ç°æ²¡æœ‰å†™å…¥çš„å…ƒç´ 
------------------------------------------------------------------------------------

ç”¨æˆ·æ€ç¨‹åºå¦‚æœå…³é—­ BPF_MAP_TYPE_PROG_ARRAY çš„ mapï¼Œä¼šç»™ map ä¸­æ‰€æœ‰çš„ prog çš„å¼•ç”¨è®¡æ•°å‡ 1ï¼Œæ·»åŠ çš„æ—¶å€™æ‰€æœ‰çš„ prog ä¼šå¼•ç”¨åŠ  1ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–æ“ä½œï¼Œè¿™ä¸ª prog ä¼šè¢«è‡ªåŠ¨æ¸…ç†æ‰ã€‚

è§£å†³æ–¹æ³•å°±æ˜¯è¦ä¹ˆç”¨æˆ·ç©ºé—´ç¨‹åºä¸è¦å…³é—­è¿™ä¸ª mapï¼Œæˆ–è€…å…³é—­å‰å°†è¿™ä¸ª map å›ºå®šåˆ° bpf æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚

.. code-block:: c

    const struct file_operations bpf_map_fops = {
        ...
        .release = bpf_map_release,
        ...
    };
    
    bpf_map_release
    |- map->ops->map_release()
       |- prog_array_map_clear()
          |- for (i = 0; i < array->map.max_entries; i++)
          |-   __fd_array_map_delete_elem(map, &i, need_defer)
               |- map->ops->map_fd_put_ptr(map, old_ptr, need_defer)

bpf éªŒè¯å™¨æŠ¥ math between pkt pointer and register with unbounded min value is not allowed
------------------------------------------------------------------------------------------------

æœ‰æ—¶å€™æ ¡éªŒå™¨æŠ¥é”™ä¸ä¸€å®šæ˜¯ç¨‹åºä»£ç æœ‰é—®é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨ä½ç‰ˆæœ¬çš„å†…æ ¸ä¸Šï¼Œä¹Ÿå¯èƒ½æ˜¯ bpf æ ¡éªŒå™¨æœ¬èº«æœ‰é—®é¢˜ã€‚æ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š

.. code-block:: c

	if (ipv4->ihl <= 5) {
	    return true;
	}
	return buf_skip(buf, (ipv4->ihl - 5) * 4);

è¿™æ®µä»£ç æœ‰äº›æ—¶å€™ç¼–è¯‘çš„æ—¶å€™æ²¡é—®é¢˜ï¼Œæœ‰äº›æ—¶å€™ï¼ˆå…¶ä»–ä»£ç å˜äº†ï¼‰ç¼–è¯‘ä¹‹ååœ¨é«˜ç‰ˆæœ¬å†…æ ¸ä¸Šæ²¡é—®é¢˜ï¼Œåœ¨ä½ç‰ˆæœ¬æ¯”å¦‚ 4.19 å†…æ ¸ä¸Šå°±æŠ¥ ``math between pkt pointer and register with unbounded min value is not allowed`` é”™è¯¯ã€‚

åæ±‡ç¼– bpf ç¨‹åºï¼Œæ ¹æ®æŠ¥é”™çš„ä¿¡æ¯å¯ä»¥å®šä½åˆ°ä»£ç è¡Œæ•°ï¼Œå¯ä»¥å‘ç°ä¸Šé¢çš„ä»£ç ç¼–è¯‘å‡ºæ¥çš„ bpf æŒ‡ä»¤ç æœ‰é—®é¢˜å’Œæ²¡é—®é¢˜çš„æ—¶å€™ä¸ä¸€æ ·ã€‚

é¦–å…ˆæ²¡é—®é¢˜çš„ï¼š

.. code-block:: objdump

    ; if (ipv4->ihl < 5) {
        187:       r4 = *(u8 *)(r8 + 0)
        188:       r4 &= 15
        189:       r5 = 5
        190:       if r5 > r4 goto +157 <LBB0_154>
    ; if (ipv4->ihl <= 5) {
        191:       if r4 == 5 goto +4 <LBB0_28>
    ; return buf_skip(buf, (ipv4->ihl - 5) * 4);
        192:       r4 <<= 2
    ; if (buf->head + len > buf->tail) {
        193:       r8 += r4
	
æœ‰é—®é¢˜çš„ï¼š

.. code-block:: objdump

    ; if (ipv4->ihl < 5) {
        221:       r3 = *(u8 *)(r4 + 0)
        222:       r3 &= 15
        223:       r5 = 5
        224:       *(u64 *)(r10 - 104) = r3
        225:       if r5 > r3 goto +178 <LBB0_165>
    ; if (ipv4->ihl <= 5) {
        226:       r5 = *(u64 *)(r10 - 104)
        227:       if r5 == 5 goto +5 <LBB0_29>
        228:       r3 = *(u64 *)(r10 - 104)
    ; return buf_skip(buf, (ipv4->ihl - 5) * 4);
        229:       r3 <<= 2
    ; if (buf->head + len > buf->tail) {
        230:       r4 += r3 ğŸ‘ˆ æŠ¥é”™è¡Œ

å¯¹æ¯” bpf æŒ‡ä»¤ç å¯ä»¥çœ‹å‡ºï¼Œæ²¡é—®é¢˜çš„ç‰ˆæœ¬ä¸­ ``ipv4->ihl`` è¿™ä¸ªå˜é‡å§‹ç»ˆæ˜¯ä¿å­˜åœ¨ ``r4`` è¿™ä¸ªå¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ ``buf_skip`` å‡½æ•°çš„æ—¶å€™ï¼Œæ ¡éªŒå™¨å¯ä»¥å¾ˆå®¹æ˜“è·Ÿè¸ªå¾—åˆ° ``ipv4->ihl - 5`` è‚¯å®šæ˜¯å¤§äº 0 çš„ï¼Œä½†æ˜¯å¯¹äºæœ‰é—®é¢˜çš„ç‰ˆæœ¬ä¸­ï¼Œç”Ÿæˆçš„ bpf ä»£ç æ˜¯ä»æ ˆä¸ŠåŠ è½½çš„å˜é‡å€¼ï¼Œä½ç‰ˆæœ¬çš„æ—¶å€™ï¼Œæ ¡éªŒå™¨è¿˜ä¸èƒ½è·Ÿè¸ªæ ˆä¸Šçš„å˜é‡ï¼Œæ‰€ä»¥è¿™é‡Œè·Ÿè¸ªå¤±è´¥ï¼Œå¯¼è‡´æ ¡éªŒå™¨æ— æ³•ç¡®å®šå€¼çš„èŒƒå›´ï¼ŒæŠ¥è¿™ä¸ªé”™è¯¯ã€‚

è§£å†³çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ç”¨ asm å¼ºåˆ¶å°†ä¸Šé¢ 226-228 è¡Œè¿™é‡Œçš„ ``r5`` å’Œ ``r3`` å¯„å­˜å™¨å¼ºåˆ¶ä¸ºä¸€ä¸ªï¼Œè¿™æ ·å°±èƒ½è®©æ ¡éªŒå™¨è·Ÿè¸ªåˆ°å˜é‡çš„èŒƒå›´ä»è€Œé¿å…è¿™ä¸ªé”™è¯¯ã€‚

.. code-block:: c

	uint8_t a;
	asm volatile ("%0 = %1" : "=r"(a) : "r"(ipv4->ihl)); /* a = ipv4->ihl */
	if (a <= 5) {
	    return true;
	}
	return buf_skip(buf, (a - 5) * 4);

å¦å¤–é«˜å†…æ ¸ï¼ˆ5.3 ä¹‹åï¼‰åº”è¯¥å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†ã€‚

- https://www.mail-archive.com/iovisor-dev@lists.iovisor.org/msg01390.html
- https://discourse.llvm.org/t/forcing-llvm-to-not-spill-specific-variables-to-the-stack-when-compiling-to-bpf/59002